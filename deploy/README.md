# Health Platform Deployment Guide
# Generated by Zhuang

## Overview
This directory contains all the necessary files for deploying the Health Platform to Kubernetes with automated CI/CD support.

## File Structure

```
deploy/
├── config/
│   ├── dev.env          # Development environment configuration
│   ├── staging.env      # Staging environment configuration  
│   └── prod.env         # Production environment configuration
├── k8s-template.yaml    # Kubernetes deployment template with variables
├── deploy-configurable.sh   # Configurable deployment script (Linux/Mac)
├── deploy-configurable.bat  # Configurable deployment script (Windows)
├── validate-config.sh       # Configuration validation script
├── nginx-nonroot.conf.template  # Nginx configuration for non-root container
└── docker-entrypoint.sh      # Docker container entrypoint script
```

## Automated Deployment via GitHub Actions

### Automatic Deployment
- **Main branch**: Automatically deploys to production environment
- **Feature branches**: Build images only, manual deployment trigger available

### Manual Deployment
1. Go to Actions tab in GitHub repository
2. Select "Build, Push and Deploy" workflow
3. Click "Run workflow"
4. Choose environment (dev/prod) and enable deployment

## Manual Deployment

### Prerequisites
- Kubernetes cluster access configured (`kubectl` working)
- Docker registry access
- `envsubst` utility (Linux/Mac)

### Quick Start

```bash
# Validate configuration before deployment
./deploy/validate-config.sh dev

# Deploy to development environment
./deploy/deploy-configurable.sh dev

# Deploy to staging environment  
./deploy/deploy-configurable.sh staging

# Deploy to production environment  
./deploy/deploy-configurable.sh prod

# Generate manifests only (don't apply)
APPLY_NOW=false ./deploy/deploy-configurable.sh dev
```

### Multi-Cluster Deployment

Configure different Kubernetes clusters per environment:

```bash
# deploy/config/prod.env
NAMESPACE=health-platform
KUBE_CONTEXT=aks-prod-cluster    # Production cluster
KUBE_CONFIG_PATH=/path/to/prod-kubeconfig  # Optional

# deploy/config/staging.env  
NAMESPACE=health-platform-staging
KUBE_CONTEXT=aks-staging-cluster  # Staging cluster

# deploy/config/dev.env
NAMESPACE=health-platform-dev
KUBE_CONTEXT=aks-dev-cluster     # Development cluster
```

### Configuration

Edit the environment files to customize deployment:
- `deploy/config/dev.env` - Development settings
- `deploy/config/prod.env` - Production settings

Key configuration options:
- `NAMESPACE`: Kubernetes namespace
- `IMAGE_TAG`: Docker image tag to deploy
- `SERVICE_TYPE`: ClusterIP or LoadBalancer
- Resource limits and replicas
- Environment-specific variables

## Environment Configuration

### Development (dev.env)
- Single replica deployments
- Lower resource limits
- LoadBalancer service for external access
- Development-friendly settings

### Production (prod.env)  
- Multiple replicas for high availability
- Higher resource limits and requests
- Production-optimized settings
- Security-focused configuration

## Security Features

### Container Security
- Non-root user execution
- Minimal base images
- Security contexts configured
- Health checks enabled

### Kubernetes Security
- Resource limits enforced
- Network policies (add as needed)
- RBAC (configure per environment)
- Secret management ready

## Monitoring and Health Checks

### Application Health
- Backend: `/api/v1/health`
- Frontend: `/nginx-health`

### Resource Monitoring
```bash
# Check pod status
kubectl get pods -n <namespace>

# Check service status
kubectl get svc -n <namespace>

# View logs
kubectl logs deployment/backend -n <namespace>
kubectl logs deployment/frontend -n <namespace>
```

## Troubleshooting

### Common Issues

1. **ImagePullBackOff**
   - Check image tag in environment config
   - Verify registry authentication

2. **CrashLoopBackOff**
   - Check pod logs: `kubectl logs <pod-name> -n <namespace>`
   - Verify health check endpoints
   - Check resource limits

3. **Service not accessible**
   - Verify service type configuration
   - Check LoadBalancer IP assignment
   - Validate port mappings

### Debug Commands

```bash
# Get deployment details
kubectl describe deployment backend -n <namespace>

# Check pod logs
kubectl logs -l app=backend -n <namespace> --tail=100

# Port forward for local testing
kubectl port-forward svc/frontend-svc 8080:80 -n <namespace>
```

## Best Practices Implemented

1. **Security First**: Non-root containers, minimal permissions
2. **Configuration as Code**: Environment-specific config files
3. **Automated Deployment**: CI/CD pipeline with GitHub Actions
4. **Resource Management**: Proper limits and requests
5. **Health Monitoring**: Comprehensive health checks
6. **Template-based**: Reusable Kubernetes templates

## Next Steps

1. Configure monitoring and alerting
2. Implement backup strategies
3. Set up network policies
4. Configure ingress controllers
5. Implement secrets management
