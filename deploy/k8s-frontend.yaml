apiVersion: v1
# Generated by Zhuang
kind: List
items:
  - apiVersion: v1
    kind: Namespace
    metadata:
      name: health-platform

  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: frontend-config
      namespace: health-platform
    data:
      # LISTEN_PORT used by the nginx entrypoint in the image
      LISTEN_PORT: "80"
      # Default API_URL uses in-cluster DNS to reach the backend service; override at deploy time if needed
      API_URL: "http://backend.health-platform.svc.cluster.local:5000"

  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: frontend
      namespace: health-platform
      labels:
        app: frontend
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: frontend
      template:
        metadata:
          labels:
            app: frontend
        spec:
          imagePullSecrets:
            - name: regcred
          securityContext:
            runAsUser: 101
            runAsGroup: 101
            fsGroup: 101
            runAsNonRoot: true
          containers:
            - name: frontend
              image: ghcr.io/devnextx/health-platform-frontend:sha-8aef88b
              imagePullPolicy: IfNotPresent
              ports:
                - containerPort: 80
              envFrom:
                - configMapRef:
                    name: frontend-config
              readinessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 3
              livenessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 30
                periodSeconds: 20
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits:
                  cpu: "250m"
                  memory: "256Mi"

  - apiVersion: v1
    kind: Service
    metadata:
      name: frontend-svc
      namespace: health-platform
      labels:
        app: frontend
    spec:
      type: LoadBalancer
      selector:
        app: frontend
      ports:
        - name: http
          port: 80
          targetPort: 80

# Notes:
# - This manifest intentionally uses an in-cluster default API_URL pointing to the backend service
#   (http://backend.health-platform.svc.cluster.local:5000). If you prefer the frontend to proxy to an
#   external backend IP/domain, update the ConfigMap value `API_URL` after creating the frontend service.
# - Create the image pull secret `regcred` in the `health-platform` namespace if pulling from a private registry:
#     kubectl create secret docker-registry regcred --docker-server=ghcr.io --docker-username=<USER> --docker-password=<TOKEN> -n health-platform
# - Apply the manifest with: kubectl apply -f deploy/k8s-frontend.yaml
# - After applying, get the external IP: kubectl get svc frontend-svc -n health-platform
