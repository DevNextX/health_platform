# Health Platform Kubernetes Deployment Guide
# Generated by Zhuang

## Overview
This guide provides instructions for deploying the Health Platform to Kubernetes with optimized configurations.

## Prerequisites
- Kubernetes cluster (1.19+)
- kubectl configured
- Docker registry access (for pushing images)
- Sufficient cluster resources

## Quick Deployment

### 1. Build and Push Images
```bash
# Build backend image
docker build -f Dockerfile.backend -t health-platform-backend:latest .
docker tag health-platform-backend:latest ghcr.io/devnextx/health-platform-backend:latest
docker push ghcr.io/devnextx/health-platform-backend:latest

# Build frontend image
docker build -f Dockerfile.frontend -t health-platform-frontend:latest .
docker tag health-platform-frontend:latest ghcr.io/devnextx/health-platform-frontend:latest
docker push ghcr.io/devnextx/health-platform-frontend:latest
```

### 2. Create Namespace and Secrets
```bash
# Create namespace
kubectl create namespace health-platform

# Create image pull secret (if using private registry)
kubectl create secret docker-registry regcred \
  --docker-server=ghcr.io \
  --docker-username=YOUR_USERNAME \
  --docker-password=YOUR_TOKEN \
  -n health-platform

# Create backend secrets (replace with your values)
kubectl create secret generic backend-secrets \
  --from-literal=JWT_SECRET='your-secure-jwt-secret-here' \
  --from-literal=DATABASE_URL='sqlite:///instance/health_platform.db' \
  -n health-platform
```

### 3. Deploy Backend
```bash
kubectl apply -f deploy/k8s-optimized-backend.yaml
```

### 4. Deploy Frontend
```bash
kubectl apply -f deploy/k8s-optimized-frontend.yaml
```

### 5. Verify Deployment
```bash
# Check pods
kubectl get pods -n health-platform

# Check services
kubectl get services -n health-platform

# Check HPA
kubectl get hpa -n health-platform

# Get external IPs
kubectl get svc -n health-platform -w
```

## Configuration Options

### Backend Configuration
- **Replicas**: Default 2, scales 2-6 with HPA
- **Resources**: 200m CPU / 256Mi memory (requests), 1000m CPU / 1Gi memory (limits)
- **Database**: SQLite by default, configure DATABASE_URL for external DB
- **JWT**: Configure JWT_SECRET for security

### Frontend Configuration
- **Replicas**: Default 2, scales 2-8 with HPA
- **Resources**: 100m CPU / 128Mi memory (requests), 500m CPU / 512Mi memory (limits)
- **API URL**: Uses internal cluster DNS by default

### Environment Variables

#### Backend
- `DATABASE_URL`: Database connection string
- `JWT_SECRET`: JWT signing secret
- `CORS_ORIGINS`: Allowed CORS origins
- `JWT_ACCESS_MINUTES`: JWT access token expiration (default: 30)
- `JWT_REFRESH_DAYS`: JWT refresh token expiration (default: 7)
- `GUNICORN_WORKERS`: Number of Gunicorn workers (default: 2)
- `GUNICORN_THREADS`: Number of threads per worker (default: 4)

#### Frontend
- `API_URL`: Backend API URL
- `LISTEN_PORT`: Nginx listen port (default: 80)

## Monitoring and Health Checks

### Health Endpoints
- Backend: `/healthz`
- Frontend: `/nginx-health`

### Probes Configuration
- **Startup Probe**: Validates initial startup
- **Readiness Probe**: Determines if pod can receive traffic
- **Liveness Probe**: Detects if pod needs restart

### HPA Metrics
- CPU utilization threshold: 70%
- Memory utilization threshold: 80%

## Troubleshooting

### Common Issues
1. **Image Pull Errors**: Verify regcred secret and image names
2. **Pod Startup Issues**: Check logs with `kubectl logs -n health-platform <pod-name>`
3. **Service Discovery**: Ensure internal DNS names match service names
4. **Database Connection**: Verify DATABASE_URL format and network access

### Useful Commands
```bash
# View pod logs
kubectl logs -n health-platform deployment/backend
kubectl logs -n health-platform deployment/frontend

# Describe pod issues
kubectl describe pod -n health-platform <pod-name>

# Port forward for debugging
kubectl port-forward -n health-platform svc/backend-svc 5000:5000
kubectl port-forward -n health-platform svc/frontend-svc 8080:80

# Scale deployments
kubectl scale deployment backend --replicas=3 -n health-platform
kubectl scale deployment frontend --replicas=3 -n health-platform
```

## Production Recommendations

1. **Security**:
   - Use strong JWT secrets
   - Configure proper RBAC
   - Enable network policies
   - Use private container registry

2. **Database**:
   - Use external managed database (PostgreSQL/MySQL)
   - Configure backup strategy
   - Set up monitoring

3. **Ingress**:
   - Configure Ingress controller for better traffic management
   - Enable TLS/SSL certificates
   - Set up domain names

4. **Monitoring**:
   - Deploy Prometheus/Grafana for metrics
   - Configure log aggregation
   - Set up alerting

5. **Resource Management**:
   - Adjust resource requests/limits based on load testing
   - Configure PodDisruptionBudgets
   - Use node selectors/affinity rules

## Cleanup
```bash
# Delete all resources
kubectl delete -f deploy/k8s-optimized-frontend.yaml
kubectl delete -f deploy/k8s-optimized-backend.yaml

# Delete namespace (removes everything)
kubectl delete namespace health-platform
```
