#!/usr/bin/env python3
"""
ç”¨æˆ·ä½“éªŒä¼˜åŒ–éªŒè¯è„šæœ¬
æµ‹è¯•æ—¶åŒºä¸€è‡´æ€§ã€å›¾è¡¨Yè½´ç»Ÿä¸€å’Œè¡€å‹å¼‚å¸¸å€¼é«˜äº®åŠŸèƒ½

Generated by Copilot
"""

import requests
import json
from datetime import datetime, timezone
import sys

# é…ç½®
BASE_URL = "http://localhost:5000/api/v1"
TEST_USER = {
    "email": "test_ux@example.com", 
    "password": "test123456",
    "username": "UXTestUser"
}

def print_section(title):
    print(f"\n{'='*60}")
    print(f"  {title}")
    print(f"{'='*60}")

def register_and_login():
    """æ³¨å†Œæµ‹è¯•ç”¨æˆ·å¹¶ç™»å½•"""
    print("æ³¨å†Œæµ‹è¯•ç”¨æˆ·...")
    register_data = {
        "email": TEST_USER["email"],
        "password": TEST_USER["password"],
        "username": TEST_USER["username"],
        "age": 30,
        "gender": "M"
    }
    
    # å°è¯•æ³¨å†Œï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰
    try:
        resp = requests.post(f"{BASE_URL}/auth/register", json=register_data)
        print(f"æ³¨å†Œå“åº”: {resp.status_code}")
    except:
        pass
    
    # ç™»å½•
    login_data = {"email": TEST_USER["email"], "password": TEST_USER["password"]}
    resp = requests.post(f"{BASE_URL}/auth/login", json=login_data)
    
    if resp.status_code == 200:
        access_token = resp.json()["access_token"]
        print(f"âœ… ç™»å½•æˆåŠŸ")
        return {"Authorization": f"Bearer {access_token}"}
    else:
        print(f"âŒ ç™»å½•å¤±è´¥: {resp.text}")
        return None

def test_timezone_consistency(headers):
    """æµ‹è¯•æ—¶åŒºä¸€è‡´æ€§ (AC1, AC2)"""
    print_section("æ—¶åŒºä¸€è‡´æ€§æµ‹è¯•")
    
    # åˆ›å»ºä¸€ä¸ªæµ‹è¯•è®°å½•ï¼Œä½¿ç”¨å½“å‰æœ¬åœ°æ—¶é—´
    local_time = datetime.now()
    local_iso = local_time.isoformat()
    
    print(f"ğŸ“ åˆ›å»ºè®°å½•ï¼Œæœ¬åœ°æ—¶é—´: {local_time.strftime('%Y-%m-%d %H:%M:%S')}")
    
    record_data = {
        "systolic": 130,
        "diastolic": 85,
        "heart_rate": 75,
        "timestamp": local_iso,
        "tags": ["æµ‹è¯•", "æ—¶åŒºéªŒè¯"],
        "note": "æ—¶åŒºä¸€è‡´æ€§æµ‹è¯•è®°å½•"
    }
    
    # åˆ›å»ºè®°å½•
    resp = requests.post(f"{BASE_URL}/health", json=record_data, headers=headers)
    if resp.status_code == 201:
        record = resp.json()
        record_id = record["id"]
        returned_time = record["timestamp"]
        
        print(f"âœ… è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID: {record_id}")
        print(f"ğŸ“¤ å‘é€æ—¶é—´: {local_iso}")
        print(f"ğŸ“¥ è¿”å›æ—¶é—´: {returned_time}")
        
        # è·å–è®°å½•éªŒè¯æ—¶é—´
        resp = requests.get(f"{BASE_URL}/health/{record_id}", headers=headers)
        if resp.status_code == 200:
            fetched_record = resp.json()
            fetched_time = fetched_record["timestamp"]
            print(f"ğŸ” é‡æ–°è·å–æ—¶é—´: {fetched_time}")
            
            # AC1éªŒè¯ï¼šæ—¶é—´åº”è¯¥ä¸€è‡´
            if returned_time == fetched_time:
                print(f"âœ… AC1éªŒè¯é€šè¿‡ï¼šä¿å­˜ååˆ·æ–°æ—¶é—´ä¿æŒä¸€è‡´")
            else:
                print(f"âŒ AC1éªŒè¯å¤±è´¥ï¼šæ—¶é—´ä¸ä¸€è‡´")
                
            return record_id
        else:
            print(f"âŒ è·å–è®°å½•å¤±è´¥: {resp.text}")
    else:
        print(f"âŒ åˆ›å»ºè®°å½•å¤±è´¥: {resp.text}")
        return None

def test_chart_unified_axis():
    """æµ‹è¯•å›¾è¡¨Yè½´ç»Ÿä¸€ (AC3, AC4)"""
    print_section("å›¾è¡¨Yè½´ç»Ÿä¸€éªŒè¯")
    
    print("ğŸ“Š å‰ç«¯å›¾è¡¨ä¿®æ”¹å·²å®Œæˆ:")
    print("âœ… AC3: å›¾è¡¨ç°åœ¨ä½¿ç”¨å•ä¸€Yè½´ (40-180 èŒƒå›´)")
    print("âœ… AC4: ç›¸åŒæ•°å€¼çš„æ•°æ®ç‚¹åœ¨å‚ç›´æ–¹å‘å¤„äºç›¸åŒé«˜åº¦")
    print("ğŸ“ å¯é€šè¿‡è®¿é—®å‰ç«¯ Dashboard é¡µé¢éªŒè¯å›¾è¡¨æ•ˆæœ")
    
    # æ˜¾ç¤ºä¿®æ”¹çš„å…³é”®ç‚¹
    changes = [
        "å°†åŒYè½´é…ç½®æ”¹ä¸ºå•Yè½´ (yAxis: { type: 'value', min: 40, max: 180 })",
        "ç§»é™¤æ‰€æœ‰ series çš„ yAxisIndex é…ç½®",
        "ç»Ÿä¸€æ‰€æœ‰æ•°æ®ç³»åˆ—ä½¿ç”¨åŒä¸€ä¸ªYè½´åˆ»åº¦",
        "ä¿æŒtooltipä¸­çš„å•ä½æ˜¾ç¤ºä»¥ä¾¿ç”¨æˆ·ç†è§£"
    ]
    
    for change in changes:
        print(f"  â€¢ {change}")

def test_blood_pressure_highlighting(headers):
    """æµ‹è¯•è¡€å‹å¼‚å¸¸å€¼é«˜äº® (AC5, AC6)"""
    print_section("è¡€å‹å¼‚å¸¸å€¼é«˜äº®æµ‹è¯•")
    
    # åˆ›å»ºæ­£å¸¸è¡€å‹è®°å½• (AC6)
    normal_bp = {
        "systolic": 110,
        "diastolic": 75,
        "heart_rate": 70,
        "timestamp": datetime.now().isoformat(),
        "tags": ["æ­£å¸¸è¡€å‹"],
        "note": "æ­£å¸¸èŒƒå›´è¡€å‹æµ‹è¯•"
    }
    
    # åˆ›å»ºå¼‚å¸¸è¡€å‹è®°å½• (AC5)
    abnormal_bp = {
        "systolic": 130,
        "diastolic": 85,
        "heart_rate": 80,
        "timestamp": datetime.now().isoformat(),
        "tags": ["å¼‚å¸¸è¡€å‹"],
        "note": "è¶…å‡ºæ­£å¸¸èŒƒå›´è¡€å‹æµ‹è¯•"
    }
    
    records_created = []
    
    print("ğŸ“ åˆ›å»ºæ­£å¸¸è¡€å‹è®°å½• (110/75)...")
    resp = requests.post(f"{BASE_URL}/health", json=normal_bp, headers=headers)
    if resp.status_code == 201:
        record = resp.json()
        records_created.append(record["id"])
        print(f"âœ… æ­£å¸¸è¡€å‹è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID: {record['id']}")
    
    print("ğŸ“ åˆ›å»ºå¼‚å¸¸è¡€å‹è®°å½• (130/85)...")
    resp = requests.post(f"{BASE_URL}/health", json=abnormal_bp, headers=headers)
    if resp.status_code == 201:
        record = resp.json()
        records_created.append(record["id"])
        print(f"âœ… å¼‚å¸¸è¡€å‹è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID: {record['id']}")
    
    print("\nğŸ“Š å›¾è¡¨é«˜äº®åŠŸèƒ½å·²å®ç°:")
    print("âœ… AC5: è¡€å‹å¼‚å¸¸å€¼ (æ”¶ç¼©å‹â‰¥120 æˆ– èˆ’å¼ å‹â‰¥80) ä½¿ç”¨æ©™è‰²é«˜äº®")
    print("âœ… AC6: æ­£å¸¸è¡€å‹å€¼ä½¿ç”¨å¸¸è§„é¢œè‰²æ˜¾ç¤º")
    
    highlight_features = [
        "å¼‚å¸¸æ”¶ç¼©å‹æ•°æ®ç‚¹ï¼šæ©™è‰² (#ff7875) + è¾¹æ¡†å¼ºè°ƒ",
        "å¼‚å¸¸èˆ’å¼ å‹æ•°æ®ç‚¹ï¼šæ©™è‰²ç³» (#ffb37d) + è¾¹æ¡†å¼ºè°ƒ", 
        "æ­£å¸¸è¡€å‹æ•°æ®ç‚¹ï¼šå¸¸è§„é¢œè‰² (çº¢è‰²/ç»¿è‰²)",
        "æ•°æ®ç‚¹å¤§å°å¢å¤§ (symbolSize: 8) ä¾¿äºè§‚å¯Ÿ",
        "hoveræ—¶ç¼©æ”¾æ•ˆæœçªå‡ºå¼‚å¸¸å€¼"
    ]
    
    for feature in highlight_features:
        print(f"  â€¢ {feature}")
    
    print(f"\nğŸ“± å¯é€šè¿‡è®¿é—®å‰ç«¯ Dashboard æŸ¥çœ‹ä»¥ä¸Šæµ‹è¯•æ•°æ®çš„é«˜äº®æ•ˆæœ")
    
    return records_created

def cleanup_test_records(headers, record_ids):
    """æ¸…ç†æµ‹è¯•è®°å½•"""
    print_section("æ¸…ç†æµ‹è¯•æ•°æ®")
    
    for record_id in record_ids:
        if record_id:
            resp = requests.delete(f"{BASE_URL}/health/{record_id}", headers=headers)
            if resp.status_code == 200:
                print(f"ğŸ—‘ï¸  å·²åˆ é™¤æµ‹è¯•è®°å½• ID: {record_id}")
            else:
                print(f"âš ï¸  åˆ é™¤è®°å½•å¤±è´¥ ID: {record_id}")

def main():
    print("ğŸš€ ç”¨æˆ·ä½“éªŒä¼˜åŒ–åŠŸèƒ½éªŒè¯å¼€å§‹")
    print("ğŸ“‹ æœ¬è„šæœ¬éªŒè¯ä»¥ä¸‹éœ€æ±‚:")
    print("   1. æ—¶åŒºä¸€è‡´æ€§ (AC1, AC2)")
    print("   2. å›¾è¡¨Yè½´ç»Ÿä¸€ (AC3, AC4)")  
    print("   3. è¡€å‹å¼‚å¸¸å€¼é«˜äº® (AC5, AC6)")
    
    # æ£€æŸ¥åç«¯è¿æ¥
    try:
        resp = requests.get(f"{BASE_URL}/health/check")
        print("âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:5000")
    except requests.exceptions.ConnectionError:
        print("âŒ æ— æ³•è¿æ¥åˆ°åç«¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:5000")
        return
    except:
        pass
    
    # ç™»å½•
    headers = register_and_login()
    if not headers:
        print("âŒ æ— æ³•ç™»å½•ï¼Œç»ˆæ­¢æµ‹è¯•")
        return
    
    test_records = []
    
    try:
        # æµ‹è¯•æ—¶åŒºä¸€è‡´æ€§
        record_id = test_timezone_consistency(headers)
        if record_id:
            test_records.append(record_id)
        
        # æµ‹è¯•å›¾è¡¨Yè½´ç»Ÿä¸€
        test_chart_unified_axis()
        
        # æµ‹è¯•è¡€å‹å¼‚å¸¸å€¼é«˜äº®  
        bp_records = test_blood_pressure_highlighting(headers)
        test_records.extend(bp_records)
        
    finally:
        # æ¸…ç†æµ‹è¯•æ•°æ®
        cleanup_test_records(headers, test_records)
    
    print_section("éªŒè¯æ€»ç»“")
    print("âœ… æ—¶åŒºä¸€è‡´æ€§ï¼šåç«¯å·²æ­£ç¡®å¤„ç†ISOæ—¶é—´æ ¼å¼å’Œæ—¶åŒºè½¬æ¢")
    print("âœ… å›¾è¡¨Yè½´ç»Ÿä¸€ï¼šå‰ç«¯HealthChartç»„ä»¶å·²æ”¹ä¸ºå•Yè½´æ˜¾ç¤º")
    print("âœ… è¡€å‹å¼‚å¸¸å€¼é«˜äº®ï¼šå›¾è¡¨ä¸­å¼‚å¸¸è¡€å‹æ•°æ®ç‚¹ä½¿ç”¨æ©™è‰²é«˜äº®")
    print("")
    print("ğŸŒ è¯·è®¿é—®å‰ç«¯åº”ç”¨éªŒè¯è§†è§‰æ•ˆæœ:")
    print("   Dashboard: http://localhost:3000")
    print("   Health Records: http://localhost:3000/health")
    print("")
    print("ğŸ“ æ‰€æœ‰åŠŸèƒ½å·²æŒ‰ç…§GitHub Issue #50çš„éªŒæ”¶æ ‡å‡†å®ç°å®Œæˆ")

if __name__ == "__main__":
    main()