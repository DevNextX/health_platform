# WeChat Mini-App Example Project

This directory contains example code and structure for building a WeChat mini-app client for the Health Platform.

Generated by Copilot

## Quick Start

### 1. Create Mini-App Project

1. Open WeChat Developer Tools
2. Create a new mini-app project
3. Enter your AppID (get from [WeChat MP Console](https://mp.weixin.qq.com/))
4. Choose JavaScript as the language
5. Select "Empty Template"

### 2. Project Structure

```
mini-app/
├── pages/
│   ├── index/
│   │   ├── index.js
│   │   ├── index.json
│   │   ├── index.wxml
│   │   └── index.wxss
│   ├── login/
│   │   ├── login.js
│   │   ├── login.json
│   │   ├── login.wxml
│   │   └── login.wxss
│   ├── records/
│   │   ├── records.js
│   │   ├── records.json
│   │   ├── records.wxml
│   │   └── records.wxss
│   ├── add-record/
│   │   ├── add-record.js
│   │   ├── add-record.json
│   │   ├── add-record.wxml
│   │   └── add-record.wxss
│   └── profile/
│       ├── profile.js
│       ├── profile.json
│       ├── profile.wxml
│       └── profile.wxss
├── utils/
│   ├── api.js
│   ├── auth.js
│   └── util.js
├── app.js
├── app.json
├── app.wxss
├── project.config.json
└── sitemap.json
```

### 3. Configuration Files

**app.json** - Main configuration file:

```json
{
  "pages": [
    "pages/index/index",
    "pages/login/login",
    "pages/records/records",
    "pages/add-record/add-record",
    "pages/profile/profile"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#1890ff",
    "navigationBarTitleText": "健康记录平台",
    "navigationBarTextStyle": "white"
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1890ff",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/home.png",
        "selectedIconPath": "images/home-active.png"
      },
      {
        "pagePath": "pages/records/records",
        "text": "记录",
        "iconPath": "images/records.png",
        "selectedIconPath": "images/records-active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的",
        "iconPath": "images/profile.png",
        "selectedIconPath": "images/profile-active.png"
      }
    ]
  },
  "permission": {
    "scope.userLocation": {
      "desc": "用于显示您的位置"
    }
  },
  "requiredBackgroundModes": ["audio"],
  "sitemapLocation": "sitemap.json"
}
```

**project.config.json** - Project settings:

```json
{
  "description": "健康记录平台小程序",
  "packOptions": {
    "ignore": []
  },
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": false,
    "coverView": true,
    "nodeModules": false,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    },
    "enableEngineNative": false,
    "useIsolateContext": true,
    "userConfirmedBundleSwitch": false,
    "packNpmManually": false,
    "packNpmRelationList": [],
    "minifyWXSS": true
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "appid": "wxYOUR_APP_ID",
  "projectname": "health-platform",
  "debugOptions": {
    "hidedInDevtools": []
  },
  "scripts": {},
  "staticServerOptions": {
    "baseURL": "",
    "servePath": ""
  },
  "isGameTourist": false,
  "condition": {
    "search": {
      "list": []
    },
    "conversation": {
      "list": []
    },
    "game": {
      "list": []
    },
    "plugin": {
      "list": []
    },
    "gamePlugin": {
      "list": []
    },
    "miniprogram": {
      "list": []
    }
  }
}
```

### 4. API Configuration

**utils/config.js** - API endpoints configuration:

```javascript
// API Base URL - change to your deployed backend URL
const API_BASE_URL = 'https://your-backend.com/api/v1';

// For development with local backend
// const API_BASE_URL = 'http://localhost:5000/api/v1';

module.exports = {
  API_BASE_URL
};
```

### 5. Key Pages

#### Login Page (pages/login/login.wxml)

```xml
<view class="container">
  <view class="header">
    <image class="logo" src="/images/logo.png" mode="aspectFit"></image>
    <text class="title">健康记录平台</text>
    <text class="subtitle">记录健康，关爱家人</text>
  </view>
  
  <view class="login-section">
    <button class="login-btn" bindtap="handleWeChatLogin" type="primary">
      <image class="wechat-icon" src="/images/wechat.png"></image>
      微信一键登录
    </button>
    
    <view class="tips">
      <text>登录即表示同意</text>
      <text class="link">《用户协议》</text>
      <text>和</text>
      <text class="link">《隐私政策》</text>
    </view>
  </view>
</view>
```

#### Login Page (pages/login/login.js)

```javascript
const api = require('../../utils/api');

Page({
  data: {
    loading: false
  },

  onLoad(options) {
    // Check if already logged in
    const accessToken = wx.getStorageSync('access_token');
    if (accessToken) {
      // Already logged in, redirect to home
      wx.switchTab({
        url: '/pages/index/index'
      });
    }
  },

  handleWeChatLogin() {
    if (this.data.loading) return;
    
    this.setData({ loading: true });
    
    wx.showLoading({ title: '登录中...' });
    
    api.wechatLogin()
      .then((data) => {
        wx.hideLoading();
        
        wx.showToast({
          title: '登录成功',
          icon: 'success'
        });
        
        setTimeout(() => {
          wx.switchTab({
            url: '/pages/index/index'
          });
        }, 1000);
      })
      .catch((err) => {
        console.error('Login failed:', err);
        wx.hideLoading();
        
        wx.showModal({
          title: '登录失败',
          content: '请检查网络连接后重试',
          showCancel: false
        });
      })
      .finally(() => {
        this.setData({ loading: false });
      });
  }
});
```

#### Health Records List (pages/records/records.wxml)

```xml
<view class="container">
  <!-- Search and Filter -->
  <view class="filter-bar">
    <picker mode="date" bindchange="onDateFromChange" value="{{dateFrom}}">
      <view class="picker">
        开始日期: {{dateFrom || '选择日期'}}
      </view>
    </picker>
    <picker mode="date" bindchange="onDateToChange" value="{{dateTo}}">
      <view class="picker">
        结束日期: {{dateTo || '选择日期'}}
      </view>
    </picker>
  </view>
  
  <!-- Records List -->
  <scroll-view class="records-list" scroll-y refresher-enabled bindrefresherrefresh="onRefresh">
    <view class="record-item" wx:for="{{records}}" wx:key="id" bindtap="onRecordTap" data-id="{{item.id}}">
      <view class="record-header">
        <text class="record-date">{{item.timestamp}}</text>
        <view class="record-tags">
          <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
        </view>
      </view>
      <view class="record-data">
        <view class="data-item">
          <text class="data-label">血压</text>
          <text class="data-value">{{item.systolic}}/{{item.diastolic}} mmHg</text>
        </view>
        <view class="data-item" wx:if="{{item.heart_rate}}">
          <text class="data-label">心率</text>
          <text class="data-value">{{item.heart_rate}} bpm</text>
        </view>
      </view>
      <view class="record-note" wx:if="{{item.note}}">
        <text>{{item.note}}</text>
      </view>
    </view>
    
    <view class="no-data" wx:if="{{records.length === 0}}">
      <image src="/images/no-data.png" mode="aspectFit"></image>
      <text>暂无记录</text>
    </view>
  </scroll-view>
  
  <!-- Add Button -->
  <view class="fab" bindtap="onAddRecord">
    <image src="/images/add.png" mode="aspectFit"></image>
  </view>
</view>
```

#### Health Records List (pages/records/records.js)

```javascript
const api = require('../../utils/api');

Page({
  data: {
    records: [],
    dateFrom: '',
    dateTo: '',
    page: 1,
    size: 20,
    loading: false
  },

  onLoad() {
    this.loadRecords();
  },

  onShow() {
    // Refresh records when returning from add/edit page
    this.loadRecords();
  },

  loadRecords() {
    if (this.data.loading) return;
    
    this.setData({ loading: true });
    
    const params = {
      page: this.data.page,
      size: this.data.size
    };
    
    if (this.data.dateFrom) {
      params.date_from = this.data.dateFrom;
    }
    if (this.data.dateTo) {
      params.date_to = this.data.dateTo;
    }
    
    const queryString = Object.keys(params)
      .map(key => `${key}=${encodeURIComponent(params[key])}`)
      .join('&');
    
    api.apiRequest(`/health/records?${queryString}`)
      .then((data) => {
        this.setData({
          records: data.records,
          loading: false
        });
      })
      .catch((err) => {
        console.error('Failed to load records:', err);
        wx.showToast({
          title: '加载失败',
          icon: 'none'
        });
        this.setData({ loading: false });
      });
  },

  onDateFromChange(e) {
    this.setData({
      dateFrom: e.detail.value
    }, () => {
      this.loadRecords();
    });
  },

  onDateToChange(e) {
    this.setData({
      dateTo: e.detail.value
    }, () => {
      this.loadRecords();
    });
  },

  onRefresh() {
    this.setData({ page: 1 });
    this.loadRecords();
  },

  onAddRecord() {
    wx.navigateTo({
      url: '/pages/add-record/add-record'
    });
  },

  onRecordTap(e) {
    const id = e.currentTarget.dataset.id;
    wx.navigateTo({
      url: `/pages/add-record/add-record?id=${id}`
    });
  }
});
```

### 6. Testing Locally

#### Prerequisites
1. Install WeChat Developer Tools
2. Set up your backend with WeChat credentials
3. Add `localhost` or your development domain to the mini-app's request whitelist

#### Steps
1. Open WeChat Developer Tools
2. Import the project
3. Update `utils/config.js` with your backend URL
4. Click "Compile" to run the mini-app
5. Use the simulator to test login and features

### 7. Deployment

#### Backend Domain Whitelist
1. Go to WeChat MP Console
2. Navigate to **Development** → **Development Settings**
3. Add your backend domain to:
   - **request valid domains**
   - **uploadFile valid domains** (if uploading files)
   - **downloadFile valid domains** (if downloading files)

**Important**: WeChat only allows HTTPS domains in production!

#### Publishing
1. Click "Upload" in WeChat Developer Tools
2. Enter version number and description
3. Submit for review in WeChat MP Console
4. Wait for approval (usually 1-7 days)
5. Release after approval

### 8. Best Practices

#### Security
- Never store sensitive data in local storage without encryption
- Always validate user input before sending to backend
- Use HTTPS for all API requests

#### Performance
- Implement pagination for large lists
- Cache frequently accessed data
- Use lazy loading for images
- Minimize API calls

#### User Experience
- Show loading indicators during API calls
- Handle errors gracefully with user-friendly messages
- Implement pull-to-refresh for data lists
- Use WeChat's native components when possible

### 9. Resources

- [WeChat Mini-App Documentation](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [WeChat Developer Tools Download](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- [WeChat Component Library](https://developers.weixin.qq.com/miniprogram/dev/component/)
- [WeChat API Reference](https://developers.weixin.qq.com/miniprogram/dev/api/)

Generated by Copilot
