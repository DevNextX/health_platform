
# 全面提升自动化测试覆盖率以保障核心业务质量

- **状态**: 草稿
- **背景**: 随着业务功能的迭代，部分核心场景的自动化测试覆盖存在缺失，特别是在异常处理和权限校验方面。为了确保系统的稳定性和数据安全性，防止在未来的迭代中出现功能回归，需要系统性地增强接口测试和E2E测试的覆盖范围。
- **业务价值**: 提升系统质量与稳定性，减少生产环境的缺陷数量；增强开发团队信心，支持更快速、更安全的迭代；为未来的重构和功能扩展提供坚实的安全保障。

## 范围

### 范围内
- **测试计划制定**: 撰写一份详细的测试计划文档，明确核心业务场景、测试策略和用例设计。
- **接口测试增强 (Pytest)**:
  - 覆盖所有核心API的CRUD操作。
  - 测试正常输入（Happy Path）。
  - 测试异常输入，包括边界值、无效格式、业务规则冲突（如注册重名/邮箱冲突）。
  - 测试权限隔离，确保用户无法访问或修改不属于自己的数据（成员、健康记录等）。
- **E2E测试增强 (Playwright)**:
  - 覆盖核心用户旅程（User Journey）。
  - 验证UI层面的交互、校验和错误提示是否符合预期。
  - 确保多用户之间的数据隔离在前端得到正确体现。
- **测试报告生成**:
  - 完成测试后，生成一份包含代码覆盖率（后端）和测试结果摘要的测试报告。
  - 报告需带有时间戳，并存储在 `/docs/TestResult/` 目录下。

### 不包含
- 性能测试、压力测试或负载测试。
- 并发场景的专项测试。
- 手动测试用例的编写。
- 非核心业务流程或纯管理功能的测试。

## 验收标准

- **AC-1 (测试计划)**: 必须产出一份测试计划文档 (`/docs/plans/plan-test-coverage-enhancement.md`)，该文档清晰地定义了要测试的核心业务场景、关键测试点以及接口/E2E测试的设计思路。
- **AC-2 (接口测试覆盖)**:
  - **用户认证**: 必须覆盖注册（含用户名/邮箱冲突）、登录、登出、Token刷新等场景。
  - **成员管理**: 必须覆盖对家庭成员的增、删、改、查，并特别验证无法通过API编辑或删除特殊成员“自己”。
  - **健康记录**: 必须覆盖对“自己”和“其他家庭成员”的健康记录的增、删、改、查。
  - **数据隔离**: 必须有测试用例验证用户A无法通过API直接操作（查询、修改、删除）用户B的成员或健康记录。
- **AC-3 (E2E测试覆盖)**:
  - **用户流程**: 必须覆盖从登录、管理家庭成员、添加/查看/筛选健康记录到登出的完整用户流程。
  - **数据隔离**: 必须有E2E测试用例，使用两个不同的用户账号登录，验证一个用户在UI上看不到另一个用户的数据。
  - **异常交互**: 必须验证UI对于无效输入（如错误的血压值、重名的家庭成员）的错误提示和交互限制（如禁用保存按钮）符合预期。
- **AC-4 (测试报告)**: 测试执行完毕后，必须在 `/docs/TestResult/` 目录下生成一份Markdown格式的测试报告，文件名包含日期戳（例如 `test-report-2025-09-16.md`），内容至少包括测试执行摘要、通过/失败统计以及后端代码覆盖率报告。

## 边界场景

- **权限校验**: 用户A尝试通过构造ID的方式访问用户B的资源。
- **边界值输入**: 对所有有范围限制的字段（如血压、心率）测试其允许的最小值、最大值以及刚好超出范围的值。
- **唯一性约束**: 创建已存在的用户名/邮箱，创建重名的家庭成员。
- **特殊成员操作**: 尝试通过API修改或删除名为“自己”的成员。

## 约束与非功能

- **可维护性**: 新增的测试用例应遵循现有测试代码的风格和结构，保持清晰可读。
- **CI/CD集成**: 测试脚本需要能稳定地在CI/CD环境中运行。

## 风险 / 问题

- **时间成本**: 全面补充测试用例可能需要较多的时间投入。
- **环境依赖**: E2E测试对一个稳定、隔离的测试环境有较强依赖。

## 数据/兼容影响

- 本需求不涉及任何生产数据或数据库结构的变更。

## 测试提示

- **接口测试**: 使用 `pytest` 的 `fixture` 来创建不同权限的用户和测试数据。使用 `pytest-cov` 来衡量代码覆盖率。
- **E2E测试**: 使用 Playwright 的 `global-setup` 功能来预先创建不同角色的用户账号，以便在测试中复用。

## 后续行动

- [ ] 创建测试计划文档 (`/docs/plans/plan-test-coverage-enhancement.md`)。
- [ ] 根据测试计划，识别并梳理需要补充的接口测试用例。
- [ ] 根据测试计划，识别并梳理需要补充的E2E测试用例。
- [ ] 分配任务并开始编写测试代码。
- [ ] 执行所有测试并生成最终的测试报告。
Generated by Copilot.
