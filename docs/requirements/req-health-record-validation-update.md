
# 更新健康记录中血压和心率的校验规则

- **状态**: 草稿

- **背景**: 当前的血压和心率校验规则与最新的医学常规不完全匹配，缺少必要的内部一致性校验（例如：收缩压应大于舒张压），并且存在将越界输入（低于下限或高于上限的数值）**自动修正为边界值** 的不当行为：
	- 血压范围 30–250，输入 20 被自动改为 30，输入 300 被自动改为 250
	- 心率范围 30–150，输入 10 被自动改为 30，输入 200 被自动改为 150
	该行为造成真实错误数据被“掩盖”，用户难以及时意识到输入不合法，不符合业务期望。此次变更目标是：**仅提示错误，不自动替换或校正用户输入值**，让用户主动修正。
- **业务价值**: 通过实施更严格、更透明的交互与校验规则，提高数据质量，避免“被静默修改”的风险，增强系统的专业性与用户信任度。


## 范围

### 范围内
- 调整血压（收缩压和舒张压）的校验范围为 30-250 mmHg。
- 调整心率的校验范围为 30-150 bpm。
- 新增“收缩压必须大于舒张压”的关联校验规则。
- 确保心率字段在校验中保持可选（允许为空）。
- 在前端“新增/编辑健康记录”的表单中应用新的校验规则，并提供清晰的、多语言的错误提示。
- 在后端处理创建和更新健康记录的 API 中同步实现上述所有校验逻辑。
- 更新后端接口测试（Unit/Integration Tests），以覆盖新的校验规则。
- 更新前端端到端（E2E）测试，以验证包含新规则的用户交互流程。

### 不包含
- 对历史不合规数据的清洗或迁移。
- 除了血压和心率之外的其他健康指标（如体重）的校验规则变更。
- 允许用户自定义校验规则的功能。

## 验收标准


- **AC-1 (血压范围 + 不自动修正)**: 场景：用户新增或编辑健康记录。当输入的收缩压或舒张压值低于 30 或高于 250 时，系统必须：
	1. 在对应输入框下方显示错误提示（示例：“血压值必须在 30-250 mmHg 之间”）。
	2. 禁用“保存”按钮。
	3. 保留用户原始输入值（例如 20 或 300），**不得**替换为 30 或 250。
	4. 当用户手动改为合法值后（例如 118 / 76），错误提示即时消失，保存按钮恢复可用。
- **AC-2 (心率范围 + 不自动修正)**: 场景：用户新增或编辑健康记录。当输入的心率值低于 30 或高于 150 时，系统必须：
	1. 在对应输入框下方显示错误提示（示例：“心率必须在 30-150 bpm 之间”）。
	2. 禁用“保存”按钮。
	3. 保留用户原始输入值（例如 10 或 180），**不得**替换为 30 或 150。
	4. 当用户手动改为合法值（或清空——合法空值）后，错误提示即时消失，保存按钮恢复可用。
- **AC-3 (血压关系校验)**: 场景：用户新增或编辑健康记录。当输入的收缩压值小于或等于舒张压值时，系统必须显示关联错误提示（例如：“收缩压必须大于舒张压”），并且“保存”按钮应处于禁用状态。
- **AC-4 (心率可选性)**: 场景：用户新增或编辑健康记录。当心率字段留空时，系统不应显示任何错误，并允许在其他字段均合法的情况下保存记录。
- **AC-5 (合法提交流程)**: 场景：用户输入的所有健康数据均符合新规则。此时，“保存”按钮应处于可用状态，用户点击后数据能成功提交，并收到成功反馈。
- **AC-6 (后端 API 校验)**: 对于不符合任一新规则的 API 请求，后端必须返回 `400 Bad Request` 状态码，并在响应体中包含清晰、结构化的错误信息。
- **AC-7 (测试覆盖)**: 必须编写并更新自动化测试用例（后端接口测试和前端 E2E 测试），确保以上所有场景都得到验证。

## 边界场景

- **空输入**: 除心率外，血压字段输入为空字符串时，应提示必填错误；心率为空视为合法（不会强制填 0 或其他值）。
- **非数值输入**: 在血压和心率字段输入字母、特殊字符等非数值内容时，应提示格式错误，不做清洗、截断或替换。
- **越界输入**: 输入 29、251（血压），或 29、151（心率）时，系统只提示错误，不把值改写成 30、250 或 150。
- **边界值**: 30、250（血压）以及 30、150（心率）均为合法值，不提示错误。
- **小数输入**: 输入小数（如 120.5）应提示格式非法（要求整数），不做四舍五入或取整。
- **批量快速修改**: 若用户粘贴一组非法值并快速删除再输入合法值，最终以“当前值”实时判定，不缓存之前错误状态。

## 约束与非功能

- **国际化**: 所有面向用户的错误提示信息都必须支持中英文双语，并遵循项目现有的 `i18next` 国际化方案。
- **一致性**: 前后端的校验逻辑必须保持严格一致，以确保数据完整性。

- **用户体验**: 错误提示应实时出现，并在用户修正输入后自动消失；不应出现“闪烁”或滞留。
- **禁止自动修正**: 系统在任何情况下都不得自动修正（覆盖、裁剪、四舍五入、取边界、清空）用户输入的越界或非法值；必须保留原始输入供用户自行修改。
- **可测试性**: 后端返回的 400 响应应结构化（字段级错误列表），前端可直接映射到对应表单项。


## 风险 / 问题

- **回归风险**: 新的校验规则可能会影响现有记录的编辑功能。需要确保对旧记录的编辑操作同样遵循新规则。
- **测试覆盖不全**: 如果测试用例未能覆盖所有组合和边界情况，可能导致部分校验逻辑在生产环境中失效。

## 数据/兼容影响

- 此变更不涉及数据库 Schema 的改动。
- 新规则仅对新增和更新的数据生效，不会影响已存储在数据库中的历史数据。

## 测试提示

- **后端**: 重点测试 `health_service.py` 中的 `_validate_health_record_data` 或类似函数，确保所有新规则都已实现。使用参数化测试覆盖不同的无效输入组合。
- **前端**: 在 `HealthRecords.js` 或相关表单组件中，验证 Ant Design 表单的 `rules` 是否已更新。
- **E2E**: 编写一个新的 Playwright 测试脚本，模拟用户填写表单的完整过程，覆盖所有成功和失败的校验场景。

## 后续行动

- [ ] 拆分开发任务并创建实施计划 (`/docs/plans/plan-health-record-validation-update.md`)。
- [ ] 分配后端开发任务（API 逻辑 + 接口测试）。
- [ ] 分配前端开发任务（UI 校验 + E2E 测试）。
Generated by Copilot.
