
# 更新健康记录中血压和心率的校验规则

- **状态**: 草稿
- **背景**: 当前的血压和心率校验规则与最新的医学常规不完全匹配，并且缺少必要的内部一致性校验（例如，收缩压应大于舒张压）。为了提升数据的准确性和系统的可靠性，需要对这些校验规则进行更新。
- **业务价值**: 通过实施更严格、更合理的校验规则，提高健康数据的质量，防止用户录入明显的错误数据，从而增强系统的专业性和用户信任度。

## 范围

### 范围内
- 调整血压（收缩压和舒张压）的校验范围为 30-250 mmHg。
- 调整心率的校验范围为 30-150 bpm。
- 新增“收缩压必须大于舒张压”的关联校验规则。
- 确保心率字段在校验中保持可选（允许为空）。
- 在前端“新增/编辑健康记录”的表单中应用新的校验规则，并提供清晰的、多语言的错误提示。
- 在后端处理创建和更新健康记录的 API 中同步实现上述所有校验逻辑。
- 更新后端接口测试（Unit/Integration Tests），以覆盖新的校验规则。
- 更新前端端到端（E2E）测试，以验证包含新规则的用户交互流程。

### 不包含
- 对历史不合规数据的清洗或迁移。
- 除了血压和心率之外的其他健康指标（如体重）的校验规则变更。
- 允许用户自定义校验规则的功能。

## 验收标准

- **AC-1 (血压范围)**: 场景：用户新增或编辑健康记录。当输入的收缩压或舒张压值低于 30 或高于 250 时，系统必须在对应输入框下方显示错误提示（例如：“血压值必须在 30-250 mmHg 之间”），并且“保存”按钮应处于禁用状态。
- **AC-2 (心率范围)**: 场景：用户新增或编辑健康记录。当输入的心率值低于 30 或高于 150 时，系统必须在对应输入框下方显示错误提示（例如：“心率必须在 30-150 bpm 之间”），并且“保存”按钮应处于禁用状态。
- **AC-3 (血压关系校验)**: 场景：用户新增或编辑健康记录。当输入的收缩压值小于或等于舒张压值时，系统必须显示关联错误提示（例如：“收缩压必须大于舒张压”），并且“保存”按钮应处于禁用状态。
- **AC-4 (心率可选性)**: 场景：用户新增或编辑健康记录。当心率字段留空时，系统不应显示任何错误，并允许在其他字段均合法的情况下保存记录。
- **AC-5 (合法提交流程)**: 场景：用户输入的所有健康数据均符合新规则。此时，“保存”按钮应处于可用状态，用户点击后数据能成功提交，并收到成功反馈。
- **AC-6 (后端 API 校验)**: 对于不符合任一新规则的 API 请求，后端必须返回 `400 Bad Request` 状态码，并在响应体中包含清晰、结构化的错误信息。
- **AC-7 (测试覆盖)**: 必须编写并更新自动化测试用例（后端接口测试和前端 E2E 测试），确保以上所有场景都得到验证。

## 边界场景

- **空输入**: 除心率外，血压字段输入为空字符串时，应提示必填错误。
- **非数值输入**: 在血压和心率字段输入字母、特殊字符等非数值内容时，应提示格式错误。
- **边界值**: 系统应能正确处理边界值，例如，30 和 250 应被视为合法的血压值。
- **小数输入**: 血压和心率应只接受整数输入。

## 约束与非功能

- **国际化**: 所有面向用户的错误提示信息都必须支持中英文双语，并遵循项目现有的 `i18next` 国际化方案。
- **一致性**: 前后端的校验逻辑必须保持严格一致，以确保数据完整性。
- **用户体验**: 错误提示应实时出现，并在用户修正输入后自动消失。不允许自动修正用户输入。

## 风险 / 问题

- **回归风险**: 新的校验规则可能会影响现有记录的编辑功能。需要确保对旧记录的编辑操作同样遵循新规则。
- **测试覆盖不全**: 如果测试用例未能覆盖所有组合和边界情况，可能导致部分校验逻辑在生产环境中失效。

## 数据/兼容影响

- 此变更不涉及数据库 Schema 的改动。
- 新规则仅对新增和更新的数据生效，不会影响已存储在数据库中的历史数据。

## 测试提示

- **后端**: 重点测试 `health_service.py` 中的 `_validate_health_record_data` 或类似函数，确保所有新规则都已实现。使用参数化测试覆盖不同的无效输入组合。
- **前端**: 在 `HealthRecords.js` 或相关表单组件中，验证 Ant Design 表单的 `rules` 是否已更新。
- **E2E**: 编写一个新的 Playwright 测试脚本，模拟用户填写表单的完整过程，覆盖所有成功和失败的校验场景。

## 后续行动

- [ ] 拆分开发任务并创建实施计划 (`/docs/plans/plan-health-record-validation-update.md`)。
- [ ] 分配后端开发任务（API 逻辑 + 接口测试）。
- [ ] 分配前端开发任务（UI 校验 + E2E 测试）。
Generated by Copilot.
