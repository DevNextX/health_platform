
# 引入管理员后台与版本管理功能

- **状态**: 草稿
- **背景**: 随着用户基数的增长，系统需要一个内部管理机制来处理基本的用户支持任务（如密码重置）和权限分配。同时，为了更好地追踪产品演进和功能迭代，需要引入标准化的版本管理和变更日志。
- **业务价值**: 提升运营效率和安全性，使管理员能够安全地管理用户；通过版本化和变更日志，增强产品的可维护性和迭代过程的清晰度。

## 范围

### 范围内
**管理员功能:**
- **角色体系**: `role` 字段支持 `USER`, `ADMIN`, `SUPER_ADMIN`。统一使用大写存储。
- **默认超级管理员**: 系统启动或迁移初始化时，从配置文件/环境变量读取 `SUPER_ADMIN_USERNAME`, `SUPER_ADMIN_EMAIL`, `SUPER_ADMIN_PASSWORD` 创建（若已存在则不重复创建）。
- **超级管理员唯一性**: 系统中始终只允许存在 1 个 `SUPER_ADMIN`；禁止新增第二个；禁止删除；禁止被降级。
- **权限管理 (仅 SUPER_ADMIN)**: 仅 `SUPER_ADMIN` 可以在 `USER` 与 `ADMIN` 之间提升/降级其他账号（不含自身）。
- **用户列表**:
    - `SUPER_ADMIN`: 查看全部用户。
    - `ADMIN`: 查看除 `SUPER_ADMIN` 以外的所有用户。
    - `USER`: 无访问权限。
- **密码重置**:
    - `SUPER_ADMIN`: 可重置 `USER` / `ADMIN` 密码。
    - `ADMIN`: 可重置 `USER` 与 `ADMIN`（不含 `SUPER_ADMIN`）密码。
    - 重置时系统生成 8 位随机临时密码（字母+数字混合），仅在响应中明文显示一次；后端只存加密哈希；同时将目标用户 `must_change_password` 标志设为 True 并使其现有 JWT 立即失效。
- **强制改密标志**: 字段 `must_change_password`（或等价机制）控制登录后是否必须先修改密码。
- **访问鉴权响应规范**: 未登录访问管理员 API → 401；已登录但权限不足 → 403。
- **前端界面**:
    - 管理员后台：导航入口仅对 `ADMIN` / `SUPER_ADMIN` 可见。
    - 列表视图（按权限过滤）+ 用户密码重置操作；重置后弹窗展示一次性临时密码并提示复制保存。
    - 角色变更操作仅 `SUPER_ADMIN` 可见。


**用户账户管理:**
- **强制密码修改**:
    1.  `Super_Admin` 首次使用初始密码登录后，必须修改密码。修改密码前，无法访问其他功能。
    2.  任何被管理员重置密码的用户，在下次使用该密码登录时，必须首先修改密码。
    3. 无论是超级管理员，还是被重置密码的用户，修改密码成功后，自动调整到登录界面，使用新密码登录后，可正常使用系统功能。
- **自主修改密码**: 为已登录用户提供一个API和前端“修改密码”设置界面，允许用户通过提供“当前密码”和“新密码”来主动修改自己的密码。密码修改成功后，旧密码立即失效，自动跳转到登录界面。
- **用户名/密码策略**:
    1.  **用户名**: 登录和注册时，统一按小写处理，实现大小写不敏感。
    2.  **密码**: 保持大小写敏感。
    3.  **密码强度**: 新密码（注册/修改时）必须至少8位，且同时包含字母和数字。

**版本管理:**
- **版本号配置**: 在 `src/config.py` 文件中增加 `VERSION` 配置项。
- **版本号接口**: 创建一个新的API (`GET /api/v1/version`)，返回当前系统版本号。
- **前端展示**: 前端在登录页面等位置调用接口并展示版本号。
- **变更日志**:
    1.  在项目根目录创建 `CHANGELOG.md` 文件，用于记录各版本详细变更。
    2.  简化 `README.md` 中的功能列表，并链接到 `CHANGELOG.md`。

### 不包含
- **管理员查看用户健康数据**: 为保护用户隐私，坚决不实现此功能。
- 复杂的RBAC（基于角色的访问控制）系统，仅实现三级固定角色。
- 通过邮件自动发送重置密码链接的功能（本次仅实现管理员手动重置）。

## 验收标准

- **AC-1 (角色字段)**: `users` 表含 `role` 字段（默认值 `USER`），接受集合 {`USER`,`ADMIN`,`SUPER_ADMIN`}；写入非法值被拒绝（400）。
- **AC-2 (唯一超级管理员)**: 初始化后恰好存在 1 个 `SUPER_ADMIN`（来源配置）；尝试创建第二个或降级/删除现有超级管理员返回 400（错误码：`SUPER_ADMIN_UNIQUE_VIOLATION` / `SUPER_ADMIN_PROTECT`).
- **AC-3 (权限分层 - 列表)**: 
    - `SUPER_ADMIN` 请求用户列表返回全部。
    - `ADMIN` 请求用户列表不包含 `SUPER_ADMIN` 记录。
    - `USER` 请求列表返回 403。
- **AC-4 (角色变更)**: 仅 `SUPER_ADMIN` 能对目标用户执行 USER↔ADMIN 切换；对 `SUPER_ADMIN` 自身或不存在用户操作返回 400/404；幂等重复设置返回 200 且数据不变。
- **AC-5 (密码重置 - 业务语义)**: 管理员（符合权限）重置非 `SUPER_ADMIN` 用户密码：
    1. 响应 JSON 含一次性字段 `temporary_password`（8 位字母数字随机串）。
    2. 该字段仅此响应出现，后续不可再查询。
    3. 目标用户 `must_change_password=True`。
    4. 目标用户所有现有 JWT 立即失效（后续访问返回 401）。
- **AC-6 (强制改密登录流程)**: 登录用户若 `must_change_password=True`：除“修改密码”及“登出”外所有受保护资源返回 403（错误码：`PASSWORD_CHANGE_REQUIRED`）。成功改密后标志置 False 并需重新登录。
- **AC-7 (自主改密)**: 用户提供正确当前密码 + 符合策略新密码 → 200；错误当前密码 → 401；不符合策略 → 400（包含具体失败原因如 `TOO_SHORT` / `MISSING_DIGIT`）。改密后旧 JWT 立即失效。
- **AC-8 (用户名大小写不敏感)**: 使用原注册名大小写任意变体都可登录同一账号；注册已存在（大小写不同）用户名时返回冲突（409）。
- **AC-9 (访问控制响应区分)**: 未携带有效 JWT 访问管理员 API → 401；携带有效 JWT 但权限不足 → 403。
- **AC-10 (版本号接口)**: `GET /api/v1/version` 返回 JSON `{"version":"<semver>"}` 与配置一致（如 `1.0.0`）。
- **AC-11 (CHANGELOG 建立)**: 根目录存在 `CHANGELOG.md`，首段含当前版本及日期；`README.md` 功能列表引用其链接。


## 边界场景

- **唯一超级管理员保护**: 降级 / 删除 / 重置（如禁止重置则返回 400）操作被拒绝。
- **Admin 自身角色变更**: Admin 试图修改自身角色 → 403。
- **Admin 查看列表**: 返回数据不含 `SUPER_ADMIN`；若系统仅存在该一用户，返回空数组。
- **重置自身密码**: 管理员在后台重置自己密码 → 400（提示使用“修改密码”接口）。
- **未登录访问**: 访问 `/api/v1/admin/...` 返回 401。
- **JWT 失效验证**: 用户密码被重置后使用旧 token 调用普通业务 API → 401（错误码 `TOKEN_INVALIDATED`）。
- **临时密码再获取**: 再次请求获取刚才的临时密码 → 不提供（无该字段）。
- **用户名大小写混合注册**: 已有 `testuser` 再注册 `TestUser` → 409。


## 约束与非功能

- **安全性**: 严格区分 401 / 403；所有管理员操作路径需统一前缀（例如 `/api/v1/admin/`）。本阶段不实现持久审计日志（列入后续）。
- **密码策略**: 新密码和生成的临时密码都需满足：长度≥8，至少 1 字母 + 1 数字；临时密码不写入明文日志。
- **配置来源**: 超级管理员初始凭据通过配置文件/环境变量注入；不在代码仓库硬编码。
- **数据迁移**: 通过迁移脚本添加 `role` 与 `must_change_password`（若需要）；现有用户默认为 `USER`，`must_change_password=False`。
- **Token 失效机制**: 改密 / 重置后需使旧 token 鉴权失败（实现方式不在本文范围，但结果需可测试）。
- **幂等性**: 重复对同一用户设置相同角色或重置密码请求的语义：角色设定幂等返回 200；密码每次生成不同值。


## 风险 / 问题

- **安全风险**: 管理员功能的引入增加了新的攻击面，代码实现必须极其谨慎，防止权限绕过或提权漏洞。
- **数据迁移风险**: 在生产环境中对数据库表结构进行变更存在风险，需要有详细的迁移和回滚计划。

## 数据/兼容影响

- 需要对 `users` 表进行结构变更，增加 `role` 字段。这属于破坏性较小的变更，但仍需谨慎处理。

## 测试提示

- **接口测试**: 重点为新的管理员API编写测试用例，覆盖权限、成功场景和所有已知的失败场景。使用 `pytest` 的 `fixture` 创建不同角色的用户进行测试。
- **E2E测试**: 编写一个E2E测试，模拟 `Super_Admin` 登录、提升一个用户为 `Admin`、然后该 `Admin` 登录并重置另一个用户的密码。

## 后续行动

- [ ] 创建实施计划 (`/docs/plans/plan-admin-and-versioning.md`)。
- [ ] 执行数据库迁移脚本设计与开发。
- [ ] 分配后端开发任务（API、角色逻辑、密码策略）。
- [ ] 分配前端开发任务（管理员界面、版本号显示）。
- [ ] 创建 `CHANGELOG.md` 并更新 `README.md`。

