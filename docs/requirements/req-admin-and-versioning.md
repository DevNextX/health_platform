
# 引入管理员后台与版本管理功能

- **状态**: 草稿
- **背景**: 随着用户基数的增长，系统需要一个内部管理机制来处理基本的用户支持任务（如密码重置）和权限分配。同时，为了更好地追踪产品演进和功能迭代，需要引入标准化的版本管理和变更日志。
- **业务价值**: 提升运营效率和安全性，使管理员能够安全地管理用户；通过版本化和变更日志，增强产品的可维护性和迭代过程的清晰度。

## 范围

### 范围内
**管理员功能:**
- **双层角色体系**: 在用户模型中新增 `role` 字段，支持 `USER`, `ADMIN`, `SUPER_ADMIN` 三种角色。
- **默认超级管理员**: 系统预置一个 `Super_Admin` 账号，拥有一个初始密码。
- **权限管理**: `Super_Admin` 拥有将其他用户提升为 `Admin` 或从 `Admin` 降级的权限。
- **用户列表**: 为管理员提供一个新API，用于查看所有注册用户列表，包含字段：用户ID、用户名、邮箱、注册时间、最后一次登录时间、角色。
- **密码重置**: 为管理员提供一个新API，用于重置指定用户的密码。

**用户账户管理:**
- **强制密码修改**:
    1.  `Super_Admin` 首次使用初始密码登录后，必须修改密码。
    2.  任何被管理员重置密码的用户，在下次使用该密码登录时，必须修改密码。
- **自主修改密码**: 为已登录用户提供一个API，允许用户通过提供“当前密码”和“新密码”来主动修改自己的密码。
- **用户名/密码策略**:
    1.  **用户名**: 登录和注册时，统一按小写处理，实现大小写不敏感。
    2.  **密码**: 保持大小写敏感。
    3.  **密码强度**: 新密码（注册/修改时）必须至少8位，且同时包含字母和数字。

**版本管理:**
- **版本号配置**: 在 `src/config.py` 文件中增加 `VERSION` 配置项。
- **版本号接口**: 创建一个新的API (`GET /api/v1/version`)，返回当前系统版本号。
- **前端展示**: 前端在登录页面等位置调用接口并展示版本号。
- **变更日志**:
    1.  在项目根目录创建 `CHANGELOG.md` 文件，用于记录各版本详细变更。
    2.  简化 `README.md` 中的功能列表，并链接到 `CHANGELOG.md`。

### 不包含
- **管理员查看用户健康数据**: 为保护用户隐私，坚决不实现此功能。
- 复杂的RBAC（基于角色的访问控制）系统，仅实现三级固定角色。
- 通过邮件自动发送重置密码链接的功能（本次仅实现管理员手动重置）。

## 验收标准

- **AC-1 (角色模型)**: 数据库 `users` 表中成功添加 `role` 字段，并支持三种角色值。
- **AC-2 (Super Admin)**: 系统启动后，数据库中存在一个默认的 `Super_Admin` 用户。
- **AC-3 (强制改密)**: 成功验证 `Super_Admin` 首次登录和用户被重置密码后首次登录时，都被强制引导至修改密码流程，不完成则无法访问其他功能。
- **AC-4 (管理员API)**:
    - 管理员成功调用API获取用户列表，且返回字段符合要求。
    - `Super_Admin` 成功调用API提升/降低其他用户的 `Admin` 角色。
    - 管理员成功调用API为用户重置密码。
- **AC-5 (权限隔离)**: 普通 `USER` 角色的用户访问任何管理员API时，必须返回 `403 Forbidden` 错误。
- **AC-6 (自主改密)**: 已登录的普通用户成功调用修改密码API后，可以使用新密码登录，旧密码失效。当提供错误的当前密码时，API应返回 `401 Unauthorized` 或 `400 Bad Request` 错误。
- **AC-7 (用户名/密码策略)**:
    - 使用 `testuser` 和 `TestUser` 均能成功登录同一个账号。
    - 注册或修改密码时，不符合“8位且含字母数字”的密码会被拒绝，并返回明确错误提示。
- **AC-8 (版本号)**: 访问 `GET /api/v1/version` 接口能成功返回在 `config.py` 中定义的版本号字符串。
- **AC-9 (文档更新)**: `CHANGELOG.md` 文件被创建，并且 `README.md` 已被相应简化和链接。

## 边界场景

- **权限操作**: 尝试将系统中唯一的 `Super_Admin` 降级（应被阻止）。
- **自身操作**: 管理员尝试重置自己的密码（应通过个人中心的“修改密码”功能，而非管理后台）。
- **用户名处理**: 用户名包含特殊字符或空格时的处理方式。

## 约束与非功能

- **安全性**: 所有管理员操作都需要有严格的权限校验。所有管理员API的访问都应被记录到审计日志中（如果未来引入审计日志）。
- **数据迁移**: 需要提供一个数据库迁移脚本（如使用 `Flask-Migrate`）来为现有用户表添加 `role` 字段并设置默认值 `USER`。

## 风险 / 问题

- **安全风险**: 管理员功能的引入增加了新的攻击面，代码实现必须极其谨慎，防止权限绕过或提权漏洞。
- **数据迁移风险**: 在生产环境中对数据库表结构进行变更存在风险，需要有详细的迁移和回滚计划。

## 数据/兼容影响

- 需要对 `users` 表进行结构变更，增加 `role` 字段。这属于破坏性较小的变更，但仍需谨慎处理。

## 测试提示

- **接口测试**: 重点为新的管理员API编写测试用例，覆盖权限、成功场景和所有已知的失败场景。使用 `pytest` 的 `fixture` 创建不同角色的用户进行测试。
- **E2E测试**: 编写一个E2E测试，模拟 `Super_Admin` 登录、提升一个用户为 `Admin`、然后该 `Admin` 登录并重置另一个用户的密码。

## 后续行动

- [ ] 创建实施计划 (`/docs/plans/plan-admin-and-versioning.md`)。
- [ ] 执行数据库迁移脚本设计与开发。
- [ ] 分配后端开发任务（API、角色逻辑、密码策略）。
- [ ] 分配前端开发任务（管理员界面、版本号显示）。
- [ ] 创建 `CHANGELOG.md` 并更新 `README.md`。
Generated by Copilot.
