# GitHub 环境配置指南
*Generated by Zhuang*

## 🎯 快速设置指南

本指南帮助您在 GitHub 中配置安全的环境变量和密钥。

## 🔧 GitHub Environment 设置

### 1. 创建环境

1. 进入仓库 → **Settings** → **Environments**
2. 点击 **New environment**
3. 创建以下环境：
   - `development`
   - `production`

### 2. 配置分支保护规则

#### Development 环境
- **Environment name**: `development`
- **Deployment branches**: Selected branches
- **Branch name pattern**: `MVP*` (匹配所有 MVP 分支)
- **Required reviewers**: 0 (开发环境无需审批)

#### Production 环境
- **Environment name**: `production`
- **Deployment branches**: Selected branches  
- **Branch name pattern**: `main`
- **Required reviewers**: 1+ (生产环境需要审批)
- **Wait timer**: 0 minutes
- **Prevent self-review**: ✅ 启用

## 🔐 配置环境密钥 (Secrets)

### 🔑 GitHub Personal Access Token 创建

在配置 GHCR 访问之前，需要创建个人访问令牌：

1. 进入 **GitHub Settings** → **Developer settings** → **Personal access tokens** → **Tokens (classic)**
2. 点击 **Generate new token** → **Generate new token (classic)**
3. 设置：
   - **Note**: `Health Platform GHCR Access`
   - **Expiration**: 建议 90 天
   - **Scopes**: 选择以下权限：
     - ✅ `write:packages` (推送容器镜像到 GHCR)
     - ✅ `read:packages` (拉取容器镜像从 GHCR)
     - ✅ `delete:packages` (可选：清理旧镜像)
4. 复制生成的令牌，保存到 GitHub Environment Secrets

### Development 环境密钥
进入 `development` 环境，添加以下 Secrets：

```bash
# 数据库连接（开发）
DATABASE_URL=sqlite:///instance/health_platform.db

# JWT 密钥（开发）
JWT_SECRET=dev-jwt-secret-please-change-in-production

# Kubernetes 配置  
KUBE_CONTEXT=copilot

# GitHub Container Registry 认证
GHCR_USERNAME=your-github-username
GHCR_TOKEN=your-personal-access-token-with-packages-scope
```

### Production 环境密钥
进入 `production` 环境，添加以下 Secrets：

```bash
# 数据库连接（生产）
DATABASE_URL=mysql+pymysql://username:password@your-server.mysql.database.azure.com:3306/health_platform?charset=utf8mb4

# JWT 密钥（生产）- 使用强随机字符串
JWT_SECRET=your-super-secure-random-jwt-secret-key-here

# Kubernetes 配置
KUBE_CONTEXT=copilot

# GitHub Container Registry 认证
GHCR_USERNAME=your-github-username
GHCR_TOKEN=your-personal-access-token-with-packages-scope
```

**密钥获取方法：**

```bash
# 快速获取所有配置 (推荐)
# Windows:
scripts\get-kube-config.bat

# Linux/Mac:
chmod +x scripts/get-kube-config.sh
./scripts/get-kube-config.sh

# 或手动获取各个配置:
# 获取当前 kubectl 上下文
kubectl config current-context

# 获取集群名称
kubectl config view --minify -o jsonpath='{.clusters[].name}'

# 获取完整的 kubeconfig（用于 KUBE_CONFIG）
kubectl config view --minify --raw

# 生成强随机 JWT 密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"

# 或使用 OpenSSL
openssl rand -base64 32
```

## 🔧 配置环境变量 (Variables)

> **🔒 安全特性：CORS_ORIGINS 自动生成**  
> 如果未设置 `CORS_ORIGINS`，系统会根据命名空间自动生成安全的默认值：
> - `http://localhost:3000,http://127.0.0.1:3000,http://frontend-svc.{NAMESPACE}.svc.cluster.local:80`  
> 这样确保默认只允许前端服务访问，提高安全性。

### Development 环境变量
进入 `development` 环境，添加以下 Variables（**可选**）：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `CORS_ORIGINS` | `http://localhost:3000,http://127.0.0.1:3000,http://frontend-svc.health-platform-dev.svc.cluster.local:80` | 允许的前端域名（不设置时自动生成） |
| `BACKEND_REPLICAS` | `1` | 后端副本数 |
| `FRONTEND_REPLICAS` | `1` | 前端副本数 |

### Production 环境变量
进入 `production` 环境，添加以下 Variables（**可选**）：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `CORS_ORIGINS` | `https://your-domain.com,https://www.your-domain.com` | 生产前端域名（不设置时使用默认生成） |
| `BACKEND_REPLICAS` | `3` | 后端副本数（生产） |
| `FRONTEND_REPLICAS` | `2` | 前端副本数（生产） |

## 🚀 部署流程

### 开发部署
1. 推送代码到 `MVP*` 分支
2. CI/CD 自动使用 `development` 环境配置
3. 无需手动审批

### 生产部署
1. 创建 PR 到 `main` 分支
2. 代码审查通过后合并
3. CI/CD 等待手动批准
4. 批准后使用 `production` 环境配置部署

## ⚠️ 安全注意事项

### ✅ 最佳实践
- 定期轮换 JWT 密钥和数据库密码
- 使用强随机密钥（至少 32 字符）
- 限制环境访问权限
- 使用分支保护规则
- 定期审计环境配置

### ❌ 避免的做法
- 不要在代码中硬编码敏感信息
- 不要在 PR 描述中包含密钥
- 不要与他人共享环境访问权限
- 不要在日志中输出敏感信息

## 🔍 验证配置

### 检查环境配置
1. 进入 Actions 页面
2. 查看最新的部署日志
3. 确认环境变量正确加载
4. 检查遮蔽的敏感信息显示

### 常见问题排查
- **配置未生效**: 检查环境名称和分支匹配规则
- **权限错误**: 确认用户有环境访问权限
- **密钥为空**: 确认在正确环境中设置了 Secrets

---

**需要帮助？**
- 查看 [SECURITY-CONFIG.md](./SECURITY-CONFIG.md) 了解配置层次
- 联系团队管理员获取环境访问权限
- 参考 GitHub Actions 日志排查问题

*Last updated: 2025-09-07*
