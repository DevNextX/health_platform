# 分支环境策略实施指南
# Generated by Zhuang

## 总结回答你的问题

### 是否需要为每个环境创建不同的Action YAML文件？

**答案：这取决于你的团队规模和需求复杂度**

### 两种策略对比：

## 策略1：单一工作流（当前推荐，适合小中型团队）
```
一个CI/CD文件处理所有环境
├── .github/workflows/ci.yml          # 当前使用的单一工作流
```

**分支-环境映射：**
- `main` 分支 → 生产环境 (Production)
- `staging` 分支 → 预发布环境 (Staging) 
- `develop` 分支 → 开发环境 (Development)

**优点：**
- 简单维护，只需管理一个工作流文件
- 一致的部署逻辑
- 容易理解和调试

**当前实现方式：**
```yaml
on:
  push:
    branches: [main, staging, develop]  # 监听多个分支
    
jobs:
  deploy:
    steps:
      - name: 检测环境
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
```

## 策略2：多工作流（推荐大型团队或严格环境隔离）
```
每个环境独立的工作流文件
├── .github/workflows/
    ├── build.yml              # 构建和测试
    ├── deploy-dev.yml          # 开发环境部署
    ├── deploy-staging.yml      # 预发布环境部署  
    ├── deploy-prod.yml         # 生产环境部署
    └── pr-validation.yml       # PR验证
```

**分支-环境-工作流映射：**
- `develop` 分支 → 开发环境 → `deploy-dev.yml`
- `staging` 分支 → 预发布环境 → `deploy-staging.yml` 
- `main` 分支 → 生产环境 → `deploy-prod.yml` (需要人工审批)

## 推荐的分支策略

### Git Flow + 环境分支模式：
```
main (生产就绪)
  ↑ 
staging (预发布测试) 
  ↑
develop (集成分支)
  ↑ 
feature/* (功能开发)
```

### 开发工作流：
1. **功能开发**: `feature/xxx` → `develop`
2. **集成测试**: `develop` → 自动部署到开发环境
3. **预发布**: `develop` → `staging` → 自动部署到预发布环境
4. **生产发布**: `staging` → `main` → 手动审批后部署到生产环境

## 具体实施建议

### 对于你的Health Platform项目，推荐以下步骤：

#### 第1阶段：保持当前架构，增强分支支持
```bash
# 创建必需的分支
git checkout main
git checkout -b staging
git push origin staging

git checkout -b develop  
git push origin develop
```

#### 第2阶段：配置GitHub环境和Secret
在GitHub仓库设置中配置：
- `development` 环境（无限制）
- `staging` 环境（可选：需要审查员）  
- `production` 环境（必需：审查员 + 延迟定时器）

#### 第3阶段：环境特定的Secret配置
```
开发环境Secret：
- DEV_KUBE_CONFIG
- DEV_KUBE_CONTEXT

预发布环境Secret：  
- STAGING_KUBE_CONFIG
- STAGING_KUBE_CONTEXT

生产环境Secret：
- PROD_KUBE_CONFIG  
- PROD_KUBE_CONTEXT
```

## 配置文件策略

### 当前配置结构（已经很好）：
```
deploy/config/
├── dev.env         # 开发环境配置
├── staging.env     # 预发布环境配置  
└── prod.env        # 生产环境配置
```

### 安全最佳实践（已实施）：
- ✅ 敏感信息（KUBE_CONTEXT, CORS_ORIGINS）已移到GitHub Secrets
- ✅ 动态CORS配置基于LoadBalancer IP
- ✅ 环境特定的资源配置

## 决策建议

### 如果你的团队 < 5人：
**推荐使用策略1（单一工作流）**
- 保持当前的 `ci.yml` 
- 添加 `staging` 和 `develop` 分支支持
- 配置环境特定的GitHub Secrets

### 如果你的团队 > 5人 或需要严格的环境隔离：
**推荐迁移到策略2（多工作流）**
- 使用我创建的示例工作流（在 `.github/workflows-examples/` 中）
- 实施环境特定的审批流程
- 独立的部署和回滚策略

## 快速实施脚本

### 增强当前单一工作流的脚本：
```bash
# 1. 创建分支
git checkout main
git checkout -b staging && git push origin staging
git checkout -b develop && git push origin develop

# 2. 更新工作流以支持新分支
# (修改 .github/workflows/ci.yml 添加分支检测逻辑)

# 3. 配置GitHub环境和Secrets
# (通过GitHub UI配置)
```

### 迁移到多工作流的脚本：
```bash  
# 1. 备份当前工作流
cp .github/workflows/ci.yml .github/workflows/ci.yml.backup

# 2. 复制新的工作流
cp .github/workflows-examples/*.yml .github/workflows/

# 3. 删除或重命名旧的工作流
mv .github/workflows/ci.yml .github/workflows/ci-legacy.yml

# 4. 提交更改
git add .github/workflows/
git commit -m "Implement multi-workflow CI/CD strategy"
```

## 总结

1. **小团队**：使用单一工作流 + 分支检测，简单有效
2. **大团队**：使用多工作流，环境隔离更好
3. **关键**：无论选择哪种策略，都要有完整的分支策略和环境配置
4. **安全**：敏感配置必须通过GitHub Secrets管理

你的当前架构已经很好了，建议先创建 `staging` 和 `develop` 分支，测试分支自动部署功能，然后根据团队需求决定是否需要拆分工作流。
