# Time Synchronization Feature

## Overview

This document describes the time synchronization feature implemented to address authentication issues caused by time discrepancies between frontend (browser) and backend (server).

## Problem Statement

Time discrepancies between client and server can cause:
- JWT token validation failures (401 Unauthorized errors)
- Token refresh failures
- Inconsistent timestamps in health records
- Authentication session issues

## Solution

### Backend Implementation

#### Time Endpoint
- **URL:** `GET /api/v1/auth/time`
- **Purpose:** Returns server time for synchronization validation
- **Authentication:** Not required (public endpoint)

**Response Format:**
```json
{
  "server_time": "2025-09-28T03:22:24.119812Z",
  "timestamp": 1759029744,
  "timezone": "UTC"
}
```

#### UTC Standardization
- Updated all models to use `datetime.now(timezone.utc)` instead of deprecated `datetime.utcnow()`
- Ensures consistent timezone-aware datetime handling
- All database timestamps stored in UTC

### Frontend Implementation

#### TimeSyncService
- **File:** `frontend/src/services/timeSync.js`
- **Purpose:** Handles time synchronization validation
- **Threshold:** 5 minutes discrepancy tolerance

**Key Methods:**
- `checkTimeSync()`: Validates browser time against server time
- `formatDiscrepancy()`: Formats time differences for display
- `getDiscrepancyDirection()`: Determines if client is ahead/behind server

#### TimeSyncWarning Component
- **File:** `frontend/src/components/TimeSyncWarning.js`
- **Purpose:** Displays warning banner when time discrepancy detected
- **Features:**
  - Automatic time check on app load
  - Manual recheck functionality
  - Dismissible warning
  - Bilingual support (中文/English)

#### Integration
- TimeSyncWarning component integrated into main Layout
- Displays at top of application when discrepancy detected
- Non-blocking - users can dismiss or continue using the app

## Usage

### Automatic Check
Time synchronization is automatically checked when the application loads. If a discrepancy > 5 minutes is detected, a warning banner appears.

### Manual Check
Users can manually trigger a time synchronization check using the "Recheck" button in the warning banner.

### Developer Testing

#### Backend
```bash
# Test time endpoint
curl http://localhost:5000/api/v1/auth/time

# Run time sync tests
python -m pytest tests/test_time_sync.py -v
```

#### Frontend
Time sync functionality is automatically tested when the application loads. Developers can:
1. Adjust system time to create artificial discrepancy
2. Load the application to see warning banner
3. Use browser developer tools to inspect time sync service calls

## Configuration

### Time Threshold
Default discrepancy threshold is 5 minutes. This can be adjusted in:
```javascript
// frontend/src/services/timeSync.js
const TIME_DISCREPANCY_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutes
```

### JWT Token Expiration
JWT tokens are configured in:
```python
# src/config.py
JWT_ACCESS_TOKEN_EXPIRES = timedelta(minutes=30)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=7)
```

## Internationalization

Warning messages support both Chinese and English:

**Chinese:**
- "系统时间同步问题"
- "您的系统时间比服务器时间快了/慢了X分钟"

**English:**
- "System Time Synchronization Issue"
- "Your system time appears to be ahead of/behind server time by X minutes"

## Best Practices

### Server Time
- Ensure server time is synchronized with NTP
- Use UTC for all internal operations
- Convert to local time only for display

### Client Time
- Validate time discrepancy on app initialization
- Display clear warnings for significant discrepancies
- Provide manual refresh/recheck options

### Error Handling
- Graceful fallback if time check fails
- Non-blocking user experience
- Clear error messages and recovery options

## Troubleshooting

### Common Issues

1. **401 Unauthorized during token refresh**
   - Check system time synchronization
   - Verify JWT token expiration settings
   - Clear browser cache and cookies

2. **Warning banner not appearing**
   - Check browser console for errors
   - Verify time endpoint is accessible
   - Check time discrepancy threshold

3. **Persistent authentication issues**
   - Restart browser and backend server
   - Clear all authentication tokens
   - Check server system time

### Manual Testing
To test time discrepancy warnings:
1. Adjust system time by > 5 minutes
2. Open application in browser
3. Warning banner should appear
4. Reset system time and recheck

Generated by Copilot