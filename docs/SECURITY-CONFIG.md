# 安全配置管理指南
*Generated by Zhuang*

## 📋 配置分层策略

本项目采用三层配置管理策略，确保敏感信息的安全性：

### 🔒 Layer 1: GitHub Environment Secrets (敏感配置)
存储在 GitHub Repository → Settings → Environments 中
- `development` 环境对应 `MVP*` 分支
- `production` 环境对应 `main` 分支

#### 敏感配置项：
| 变量名 | 用途 | 示例 |
|--------|------|------|
| `DATABASE_URL` | 数据库连接字符串 | `mysql+pymysql://user:pass@server:3306/db` |
| `JWT_SECRET` | JWT 签名密钥 | `your-super-secret-jwt-key-here` |
| `AZURE_STORAGE_CONNECTION_STRING` | Azure 存储连接 | `DefaultEndpointsProtocol=https;...` |

### 🔧 Layer 2: GitHub Variables (非敏感但环境特定)
存储在 GitHub Repository → Settings → Variables → Environment variables
- 不同环境可能有不同值，但不包含密码

#### 环境特定配置项：
| 变量名 | 用途 | development | production |
|--------|------|-------------|------------|
| `CORS_ORIGINS` | 允许的前端域名 | 自动生成 | 自定义域名 |
| `BACKEND_REPLICAS` | 后端副本数 | `1` | `3` |
| `FRONTEND_REPLICAS` | 前端副本数 | `1` | `2` |

> **🔒 CORS_ORIGINS 智能默认值**  
> 如果未设置，系统会基于 NAMESPACE 自动生成：  
> `http://localhost:3000,http://127.0.0.1:3000,http://frontend-svc.{NAMESPACE}.svc.cluster.local:80`

### 📁 Layer 3: Repository Files (公共配置)
存储在 `deploy/config/*.env` 文件中
- 非敏感的基础配置
- 可以安全地纳入版本控制

#### 基础配置项：
| 变量名 | 用途 | 说明 |
|--------|------|------|
| `NAMESPACE` | K8s 命名空间 | `health-platform-dev/prod` |
| `REGISTRY_URL` | 镜像仓库地址 | `ghcr.io/devnextx` |
| `SERVICE_TYPE` | 服务类型 | `LoadBalancer` |
| `*_MEMORY_LIMIT` | 资源限制 | `512Mi` |

## 🔐 安全配置设置步骤

### Step 1: 创建 GitHub Environments
1. 进入 Repository → Settings → Environments
2. 创建 `development` 环境
3. 创建 `production` 环境
4. 配置分支保护规则：
   - `development`: 限制到 `MVP*` 分支
   - `production`: 限制到 `main` 分支，需要审批

### Step 2: 设置环境密钥
在每个环境中添加 Secrets：
```
DATABASE_URL=mysql+pymysql://username:password@server.mysql.database.azure.com:3306/health_platform?charset=utf8mb4
JWT_SECRET=your-super-secure-jwt-secret-key
```

### Step 3: 设置环境变量
在每个环境中添加 Variables：
```
CORS_ORIGINS=https://your-frontend-domain.com
BACKEND_REPLICAS=3
```

## 🔄 配置优先级

配置加载优先级（高到低）：
1. **GitHub Environment Secrets** (最高优先级)
2. **GitHub Environment Variables** 
3. **Repository .env files** (最低优先级)

## 🚨 安全最佳实践

### ✅ DO (推荐做法)
- 敏感信息只存储在 GitHub Secrets 中
- 使用环境变量进行配置
- 定期轮换密钥和密码
- 限制环境访问权限
- 使用分支保护规则

### ❌ DON'T (禁止做法)
- 不要在代码中硬编码密码
- 不要将 `.env` 文件中的敏感信息提交到版本控制
- 不要在日志中输出敏感信息
- 不要在生产环境中使用默认密钥

## 📝 配置变更流程

### 开发环境配置变更
1. 修改 GitHub `development` 环境的变量
2. 推送代码到 `MVP*` 分支
3. CI/CD 自动应用新配置

### 生产环境配置变更
1. 创建 Pull Request
2. 代码审查
3. 合并到 `main` 分支
4. 需要手动批准部署
5. 修改 GitHub `production` 环境的变量

## 🔍 故障排查

### 配置问题诊断
1. 检查 GitHub Actions 日志中的环境变量输出
2. 使用 `kubectl describe configmap` 验证 K8s 配置
3. 检查 pod 环境变量：`kubectl exec -it <pod> -- env`

### 常见问题
- **配置未生效**：检查环境变量名称是否正确
- **权限错误**：确认环境访问权限设置
- **分支匹配问题**：验证分支保护规则配置

---
*Last updated: 2025-09-07*
*Generated by Zhuang*
