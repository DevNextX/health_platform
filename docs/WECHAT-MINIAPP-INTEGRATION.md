# WeChat Mini-App Integration Guide

## Overview

This guide provides instructions for integrating the Health Platform with WeChat mini-app. The integration allows WeChat users to authenticate via WeChat's OAuth 2.0 system and access all health record features through their WeChat account.

Generated by Copilot

## Features

- **WeChat OAuth Login**: Users can log in using their WeChat account without creating a separate username/password
- **Account Binding**: Existing email/password users can bind their WeChat account for seamless access
- **Automatic User Creation**: New WeChat users are automatically registered with a temporary email
- **Email Upgrade**: WeChat-only users can later add an email and password for alternative login
- **UnionID Support**: Supports WeChat UnionID for cross-platform user identification
- **JWT Token Authentication**: After WeChat login, uses standard JWT tokens for API access

## Architecture

### Authentication Flow

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│  Mini-App   │         │   Backend    │         │ WeChat API  │
└──────┬──────┘         └──────┬───────┘         └──────┬──────┘
       │                       │                        │
       │ 1. wx.login()         │                        │
       │──────────────────────>│                        │
       │                       │                        │
       │ 2. code               │                        │
       │<──────────────────────│                        │
       │                       │                        │
       │ 3. POST /wechat/auth/login (code)             │
       │──────────────────────>│                        │
       │                       │                        │
       │                       │ 4. code2session        │
       │                       │───────────────────────>│
       │                       │                        │
       │                       │ 5. openid, session_key │
       │                       │<───────────────────────│
       │                       │                        │
       │                       │ 6. Get/Create User     │
       │                       │──────┐                 │
       │                       │<─────┘                 │
       │                       │                        │
       │ 7. JWT tokens         │                        │
       │<──────────────────────│                        │
       │                       │                        │
       │ 8. API calls with JWT │                        │
       │──────────────────────>│                        │
```

### Database Schema

The `users` table has been extended with WeChat-specific fields:

```sql
ALTER TABLE users ADD COLUMN wechat_openid VARCHAR(128) UNIQUE;
ALTER TABLE users ADD COLUMN wechat_unionid VARCHAR(128) UNIQUE;
ALTER TABLE users ADD COLUMN wechat_session_key VARCHAR(256);
```

- `wechat_openid`: Unique identifier for user in this mini-app (required)
- `wechat_unionid`: Cross-platform user identifier (optional, for UnionID mechanism)
- `wechat_session_key`: WeChat session key for encrypted data decryption

## Configuration

### Backend Environment Variables

Add the following environment variables to your `.env` file or deployment configuration:

```bash
# WeChat Mini-App Configuration
WECHAT_APP_ID=wx1234567890abcdef        # Your mini-app AppID
WECHAT_APP_SECRET=your_app_secret_here   # Your mini-app AppSecret
```

### Obtaining WeChat Credentials

1. Register at [WeChat Open Platform](https://mp.weixin.qq.com/)
2. Create a new mini-app
3. Navigate to **Development** → **Development Settings**
4. Copy your **AppID** and **AppSecret**

**Security Note**: Never commit your AppSecret to version control. Always use environment variables.

## API Endpoints

### 1. WeChat Login

**Endpoint**: `POST /api/v1/wechat/auth/login`

**Description**: Authenticate user via WeChat code and return JWT tokens.

**Request Body**:
```json
{
  "code": "081AbcDef2...",
  "userInfo": {
    "nickName": "张三",
    "avatarUrl": "https://wx.qlogo.cn/..."
  }
}
```

**Response** (200 OK):
```json
{
  "access_token": "eyJhbGc...",
  "refresh_token": "eyJhbGc...",
  "expires_in": 1800,
  "refresh_expires_in": 604800,
  "token_type": "Bearer",
  "user": {
    "id": 1,
    "username": "张三",
    "email": "wechat_ox123abc@temp.local",
    "is_wechat_temp": true
  }
}
```

**Error Responses**:
- `400`: Missing code parameter
- `401`: Invalid WeChat code or API error
- `500`: Server error or missing WeChat configuration

### 2. Bind WeChat Account

**Endpoint**: `POST /api/v1/wechat/auth/bind`

**Description**: Bind WeChat account to currently logged-in user.

**Headers**: 
```
Authorization: Bearer <access_token>
```

**Request Body**:
```json
{
  "code": "081AbcDef2..."
}
```

**Response** (200 OK):
```json
{
  "message": "WeChat account bound successfully"
}
```

**Error Responses**:
- `400`: Missing code parameter
- `401`: Invalid token or WeChat code
- `409`: WeChat account already bound to another user

### 3. Unbind WeChat Account

**Endpoint**: `POST /api/v1/wechat/auth/unbind`

**Description**: Remove WeChat binding from current user.

**Headers**: 
```
Authorization: Bearer <access_token>
```

**Response** (200 OK):
```json
{
  "message": "WeChat account unbound successfully"
}
```

**Error Responses**:
- `401`: Invalid token
- `404`: User not found

### 4. Update Email for WeChat User

**Endpoint**: `POST /api/v1/wechat/auth/update-email`

**Description**: Update email and optionally set password for WeChat-only user (with temporary email).

**Headers**: 
```
Authorization: Bearer <access_token>
```

**Request Body**:
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Response** (200 OK):
```json
{
  "message": "Email updated successfully",
  "user": {
    "id": 1,
    "username": "张三",
    "email": "user@example.com"
  }
}
```

**Error Responses**:
- `400`: Missing email
- `404`: User not found
- `409`: Email already exists

## Mini-App Integration

### Project Structure

Recommended mini-app project structure:

```
mini-app/
├── pages/
│   ├── index/              # Home page
│   ├── health-records/     # Health records list
│   ├── add-record/         # Add new record
│   └── profile/            # User profile
├── utils/
│   ├── api.js             # API client
│   └── auth.js            # Authentication helpers
├── app.js
├── app.json
└── project.config.json
```

### API Client (`utils/api.js`)

```javascript
const API_BASE_URL = 'https://your-backend-domain.com/api/v1';

// WeChat Login
function wechatLogin() {
  return new Promise((resolve, reject) => {
    wx.login({
      success: (res) => {
        if (res.code) {
          // Get user info if authorized
          wx.getUserProfile({
            desc: 'Used for user identification',
            success: (userRes) => {
              // Send code and userInfo to backend
              wx.request({
                url: `${API_BASE_URL}/wechat/auth/login`,
                method: 'POST',
                data: {
                  code: res.code,
                  userInfo: userRes.userInfo
                },
                success: (response) => {
                  if (response.statusCode === 200) {
                    // Save tokens to storage
                    wx.setStorageSync('access_token', response.data.access_token);
                    wx.setStorageSync('refresh_token', response.data.refresh_token);
                    wx.setStorageSync('user_info', response.data.user);
                    resolve(response.data);
                  } else {
                    reject(new Error('Login failed'));
                  }
                },
                fail: reject
              });
            },
            fail: () => {
              // User denied authorization, login without userInfo
              wx.request({
                url: `${API_BASE_URL}/wechat/auth/login`,
                method: 'POST',
                data: { code: res.code },
                success: (response) => {
                  if (response.statusCode === 200) {
                    wx.setStorageSync('access_token', response.data.access_token);
                    wx.setStorageSync('refresh_token', response.data.refresh_token);
                    wx.setStorageSync('user_info', response.data.user);
                    resolve(response.data);
                  } else {
                    reject(new Error('Login failed'));
                  }
                },
                fail: reject
              });
            }
          });
        } else {
          reject(new Error('Failed to get WeChat code'));
        }
      },
      fail: reject
    });
  });
}

// Make authenticated API request
function apiRequest(endpoint, options = {}) {
  const accessToken = wx.getStorageSync('access_token');
  
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${API_BASE_URL}${endpoint}`,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
      success: (res) => {
        if (res.statusCode === 401) {
          // Token expired, try to refresh
          refreshToken().then(() => {
            // Retry original request
            apiRequest(endpoint, options).then(resolve).catch(reject);
          }).catch(() => {
            // Refresh failed, need to re-login
            wx.removeStorageSync('access_token');
            wx.removeStorageSync('refresh_token');
            wx.removeStorageSync('user_info');
            wx.navigateTo({ url: '/pages/login/login' });
            reject(new Error('Authentication failed'));
          });
        } else {
          resolve(res.data);
        }
      },
      fail: reject
    });
  });
}

// Refresh access token
function refreshToken() {
  const refreshToken = wx.getStorageSync('refresh_token');
  
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${API_BASE_URL}/auth/refresh`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${refreshToken}`
      },
      success: (res) => {
        if (res.statusCode === 200) {
          wx.setStorageSync('access_token', res.data.access_token);
          wx.setStorageSync('refresh_token', res.data.refresh_token);
          resolve(res.data);
        } else {
          reject(new Error('Refresh failed'));
        }
      },
      fail: reject
    });
  });
}

module.exports = {
  wechatLogin,
  apiRequest,
  refreshToken
};
```

### Example: Fetch Health Records

```javascript
const api = require('../../utils/api');

Page({
  data: {
    records: []
  },
  
  onLoad() {
    this.loadHealthRecords();
  },
  
  loadHealthRecords() {
    api.apiRequest('/health/records', {
      method: 'GET'
    }).then((data) => {
      this.setData({
        records: data.records
      });
    }).catch((err) => {
      wx.showToast({
        title: 'Failed to load records',
        icon: 'none'
      });
    });
  }
});
```

### Example: Create Health Record

```javascript
const api = require('../../utils/api');

Page({
  data: {
    systolic: '',
    diastolic: '',
    heart_rate: ''
  },
  
  submitRecord() {
    const { systolic, diastolic, heart_rate } = this.data;
    
    api.apiRequest('/health/records', {
      method: 'POST',
      data: {
        systolic: parseInt(systolic),
        diastolic: parseInt(diastolic),
        heart_rate: heart_rate ? parseInt(heart_rate) : null,
        timestamp: new Date().toISOString(),
        tags: ['晨起'],
        note: ''
      }
    }).then(() => {
      wx.showToast({
        title: 'Record saved',
        icon: 'success'
      });
      wx.navigateBack();
    }).catch((err) => {
      wx.showToast({
        title: 'Failed to save record',
        icon: 'none'
      });
    });
  }
});
```

## Deployment Considerations

### Environment Configuration

For different environments (dev/staging/production), set appropriate WeChat credentials:

**Development**:
```bash
WECHAT_APP_ID=wxdev123...
WECHAT_APP_SECRET=dev_secret...
```

**Production**:
```bash
WECHAT_APP_ID=wxprod456...
WECHAT_APP_SECRET=prod_secret...
```

### Security Best Practices

1. **Never expose AppSecret**: Store in secure environment variables, never in code
2. **Validate session_key**: The session_key should be kept confidential on the backend
3. **HTTPS required**: WeChat APIs only work over HTTPS in production
4. **Token rotation**: JWT tokens expire after 30 minutes; use refresh tokens appropriately
5. **Rate limiting**: WeChat login endpoint is rate-limited to prevent abuse

### Database Migration

For existing deployments, run the following SQL to add WeChat fields:

**SQLite**:
```sql
ALTER TABLE users ADD COLUMN wechat_openid VARCHAR(128);
ALTER TABLE users ADD COLUMN wechat_unionid VARCHAR(128);
ALTER TABLE users ADD COLUMN wechat_session_key VARCHAR(256);
CREATE UNIQUE INDEX idx_users_wechat_openid ON users(wechat_openid);
CREATE UNIQUE INDEX idx_users_wechat_unionid ON users(wechat_unionid);
```

**MySQL**:
```sql
ALTER TABLE users 
  ADD COLUMN wechat_openid VARCHAR(128) UNIQUE,
  ADD COLUMN wechat_unionid VARCHAR(128) UNIQUE,
  ADD COLUMN wechat_session_key VARCHAR(256),
  ADD INDEX idx_wechat_openid (wechat_openid),
  ADD INDEX idx_wechat_unionid (wechat_unionid);
```

Alternatively, the backend will automatically create the columns when starting up with SQLite, or when `DB_AUTO_CREATE=1` is set for external databases.

## Testing

### Unit Tests

Run the WeChat integration tests:

```bash
pytest tests/test_wechat.py -v
```

### Manual Testing with Mock

For development without real WeChat credentials, you can mock the WeChat API:

```python
# In your test or development environment
import os
os.environ['WECHAT_APP_ID'] = 'test_app_id'
os.environ['WECHAT_APP_SECRET'] = 'test_app_secret'

# Mock the WeChat API response
with patch('src.manager.wechat_manager.requests.get') as mock_get:
    mock_get.return_value.json.return_value = {
        'openid': 'test_openid',
        'session_key': 'test_session_key'
    }
    # Test your code here
```

## Troubleshooting

### Common Issues

**1. "WeChat AppID and AppSecret not configured"**
- Ensure `WECHAT_APP_ID` and `WECHAT_APP_SECRET` are set in your environment

**2. "Invalid WeChat code or API error"**
- WeChat codes expire after 5 minutes; ensure the code is fresh
- Verify your AppID and AppSecret are correct
- Check that your backend can reach `api.weixin.qq.com`

**3. "WeChat account already bound to another user"**
- This openid is already associated with a different user account
- User should unbind from the other account first or contact support

**4. Mini-app shows "request:fail"**
- Add your backend domain to the mini-app's whitelist in WeChat MP console
- Ensure your backend is using HTTPS (required for production)

**5. Token refresh not working**
- Check that the refresh token hasn't expired (default: 7 days)
- Verify the token_version hasn't been bumped (user logged out)

## Additional Resources

- [WeChat Mini-App Official Documentation](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [WeChat Login API](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html)
- [Health Platform API Documentation](../API_Design.md)

## Support

For issues or questions:
- Open an issue on GitHub
- Check existing issues for similar problems
- Review the API logs for error details

Generated by Copilot
