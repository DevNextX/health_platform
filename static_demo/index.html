<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康记录平台 - Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; text-align: center; margin-bottom: 2rem; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { height: 80px; resize: vertical; }
        .btn { background: #1890ff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { background: #40a9ff; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .hidden { display: none; }
        .error { color: #ff4d4f; margin-top: 5px; font-size: 12px; }
        .success { color: #52c41a; margin-top: 5px; font-size: 12px; }
        .nav { margin-bottom: 20px; }
        .nav button { margin-right: 10px; }
        .nav button.active { background: #722ed1; }
        .record-item { border: 1px solid #f0f0f0; border-radius: 4px; padding: 15px; margin-bottom: 10px; background: #fafafa; }
        .record-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .record-time { font-weight: bold; color: #1890ff; }
        .record-values { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .record-value { text-align: center; }
        .record-value .label { font-size: 12px; color: #666; }
        .record-value .value { font-size: 16px; font-weight: bold; }
        .tags { margin-top: 10px; }
        .tag { background: #e6f7ff; color: #1890ff; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
        .chart-container { height: 400px; margin: 20px 0; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .row { grid-template-columns: 1fr; } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(45deg, #1890ff, #722ed1); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="header">
        <h1>健康记录平台</h1>
        <p>Generated by Zhuang - 演示版本</p>
        <div id="userInfo" class="hidden" style="margin-top: 10px;">
            欢迎, <span id="userName"></span> | 
            <button class="btn" onclick="logout()">退出登录</button>
        </div>
    </div>

    <div class="container">
        <!-- Login/Register Section -->
        <div id="authSection">
            <div class="card">
                <div class="nav">
                    <button id="loginTab" class="btn active" onclick="showLogin()">登录</button>
                    <button id="registerTab" class="btn" onclick="showRegister()">注册</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <h3>用户登录</h3>
                    <div class="form-group">
                        <label>邮箱地址</label>
                        <input type="email" id="loginEmail" placeholder="请输入邮箱地址">
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="loginPassword" placeholder="请输入密码">
                    </div>
                    <button class="btn btn-success" onclick="login()">登录</button>
                    <div id="loginMessage"></div>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <h3>用户注册</h3>
                    <div class="row">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="regUsername" placeholder="请输入用户名">
                        </div>
                        <div class="form-group">
                            <label>邮箱地址</label>
                            <input type="email" id="regEmail" placeholder="请输入邮箱地址">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>密码</label>
                            <input type="password" id="regPassword" placeholder="请输入密码">
                        </div>
                        <div class="form-group">
                            <label>年龄</label>
                            <input type="number" id="regAge" placeholder="年龄" min="1" max="120">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>性别</label>
                            <select id="regGender">
                                <option value="">请选择性别</option>
                                <option value="M">男</option>
                                <option value="F">女</option>
                                <option value="O">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>体重 (kg)</label>
                            <input type="number" id="regWeight" placeholder="体重" min="1" max="500" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="register()">注册</button>
                    <div id="registerMessage"></div>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="mainSection" class="hidden">
            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">总记录数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSystolic">0</div>
                    <div class="stat-label">平均收缩压 (mmHg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgDiastolic">0</div>
                    <div class="stat-label">平均舒张压 (mmHg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgHeartRate">0</div>
                    <div class="stat-label">平均心率 (bpm)</div>
                </div>
            </div>

            <!-- Health Record Form -->
            <div class="card">
                <h3>添加健康记录</h3>
                <div class="row">
                    <div class="form-group">
                        <label>收缩压 (mmHg)</label>
                        <input type="number" id="systolic" placeholder="收缩压" min="50" max="250">
                    </div>
                    <div class="form-group">
                        <label>舒张压 (mmHg)</label>
                        <input type="number" id="diastolic" placeholder="舒张压" min="50" max="250">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>心率 (bpm)</label>
                        <input type="number" id="heartRate" placeholder="心率" min="30" max="200">
                    </div>
                    <div class="form-group">
                        <label>标签</label>
                        <select id="tags" multiple>
                            <option value="晨起">晨起</option>
                            <option value="睡前">睡前</option>
                            <option value="运动前">运动前</option>
                            <option value="运动后">运动后</option>
                            <option value="餐前">餐前</option>
                            <option value="餐后">餐后</option>
                            <option value="服药前">服药前</option>
                            <option value="服药后">服药后</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="notes" placeholder="可选填写备注信息"></textarea>
                </div>
                <button class="btn btn-success" onclick="addRecord()">添加记录</button>
                <div id="recordMessage"></div>
            </div>

            <!-- Chart -->
            <div class="card">
                <h3>健康趋势图</h3>
                <div id="healthChart" class="chart-container"></div>
            </div>

            <!-- Records List -->
            <div class="card">
                <h3>历史记录</h3>
                <button class="btn" onclick="loadRecords()">刷新记录</button>
                <div id="recordsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Generated by Zhuang
        const API_BASE = 'http://localhost:5000';
        let accessToken = localStorage.getItem('access_token');
        let currentUser = null;

        // Initialize
        if (accessToken) {
            showMainApp();
            loadUserInfo();
            loadRecords();
        }

        function showLogin() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        async function register() {
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                age: parseInt(document.getElementById('regAge').value) || null,
                gender: document.getElementById('regGender').value || null,
                weight: parseFloat(document.getElementById('regWeight').value) || null
            };

            if (!userData.username || !userData.email || !userData.password) {
                showMessage('registerMessage', '请填写必填项', 'error');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE}/auth/register`, userData);
                showMessage('registerMessage', '注册成功！请登录', 'success');
                showLogin();
            } catch (error) {
                const message = error.response?.data?.message || '注册失败';
                showMessage('registerMessage', message, 'error');
            }
        }

        async function login() {
            const credentials = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };

            if (!credentials.email || !credentials.password) {
                showMessage('loginMessage', '请输入邮箱和密码', 'error');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE}/auth/login`, credentials);
                const { access_token, refresh_token } = response.data;
                
                localStorage.setItem('access_token', access_token);
                localStorage.setItem('refresh_token', refresh_token);
                accessToken = access_token;
                
                showMainApp();
                loadUserInfo();
                loadRecords();
            } catch (error) {
                const message = error.response?.data?.message || '登录失败';
                showMessage('loginMessage', message, 'error');
            }
        }

        async function logout() {
            try {
                await axios.post(`${API_BASE}/auth/logout`, {}, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('refresh_token')}` }
                });
            } catch (error) {
                console.log('Logout API call failed, clearing tokens anyway');
            }
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            accessToken = null;
            currentUser = null;
            showAuthSection();
        }

        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
        }

        async function loadUserInfo() {
            try {
                const userId = parseJwt(accessToken).sub;
                const response = await axios.get(`${API_BASE}/users/${userId}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                currentUser = response.data;
                document.getElementById('userName').textContent = currentUser.username;
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        async function addRecord() {
            const recordData = {
                systolic_pressure: parseInt(document.getElementById('systolic').value),
                diastolic_pressure: parseInt(document.getElementById('diastolic').value),
                heart_rate: parseInt(document.getElementById('heartRate').value) || null,
                tags: Array.from(document.getElementById('tags').selectedOptions).map(opt => opt.value),
                notes: document.getElementById('notes').value || null
            };

            if (!recordData.systolic_pressure || !recordData.diastolic_pressure) {
                showMessage('recordMessage', '请输入收缩压和舒张压', 'error');
                return;
            }

            try {
                await axios.post(`${API_BASE}/health-records`, recordData, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                showMessage('recordMessage', '记录添加成功！', 'success');
                
                // Clear form
                document.getElementById('systolic').value = '';
                document.getElementById('diastolic').value = '';
                document.getElementById('heartRate').value = '';
                document.getElementById('tags').selectedIndex = -1;
                document.getElementById('notes').value = '';
                
                loadRecords();
            } catch (error) {
                const message = error.response?.data?.message || '添加记录失败';
                showMessage('recordMessage', message, 'error');
            }
        }

        async function loadRecords() {
            try {
                const response = await axios.get(`${API_BASE}/health-records?per_page=50`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const records = response.data.items || [];
                
                displayRecords(records);
                updateStatistics(records);
                drawChart(records);
            } catch (error) {
                console.error('Failed to load records:', error);
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsList');
            if (!records.length) {
                container.innerHTML = '<p>暂无记录</p>';
                return;
            }

            container.innerHTML = records.map(record => `
                <div class="record-item">
                    <div class="record-header">
                        <span class="record-time">${new Date(record.timestamp).toLocaleString('zh-CN')}</span>
                        <button class="btn btn-danger" onclick="deleteRecord(${record.id})">删除</button>
                    </div>
                    <div class="record-values">
                        <div class="record-value">
                            <div class="label">收缩压</div>
                            <div class="value">${record.systolic_pressure} mmHg</div>
                        </div>
                        <div class="record-value">
                            <div class="label">舒张压</div>
                            <div class="value">${record.diastolic_pressure} mmHg</div>
                        </div>
                        ${record.heart_rate ? `
                        <div class="record-value">
                            <div class="label">心率</div>
                            <div class="value">${record.heart_rate} bpm</div>
                        </div>
                        ` : ''}
                    </div>
                    ${record.tags && record.tags.length ? `
                    <div class="tags">
                        ${record.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    ` : ''}
                    ${record.notes ? `<div style="margin-top: 10px; font-style: italic;">备注: ${record.notes}</div>` : ''}
                </div>
            `).join('');
        }

        async function deleteRecord(recordId) {
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                await axios.delete(`${API_BASE}/health-records/${recordId}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                loadRecords();
            } catch (error) {
                alert('删除失败');
            }
        }

        function updateStatistics(records) {
            const totalRecords = records.length;
            const avgSystolic = records.length ? Math.round(records.reduce((sum, r) => sum + (r.systolic_pressure || 0), 0) / records.length) : 0;
            const avgDiastolic = records.length ? Math.round(records.reduce((sum, r) => sum + (r.diastolic_pressure || 0), 0) / records.length) : 0;
            const heartRateRecords = records.filter(r => r.heart_rate);
            const avgHeartRate = heartRateRecords.length ? Math.round(heartRateRecords.reduce((sum, r) => sum + r.heart_rate, 0) / heartRateRecords.length) : 0;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('avgSystolic').textContent = avgSystolic;
            document.getElementById('avgDiastolic').textContent = avgDiastolic;
            document.getElementById('avgHeartRate').textContent = avgHeartRate;
        }

        function drawChart(records) {
            if (!records.length) return;

            const chart = echarts.init(document.getElementById('healthChart'));
            const sortedRecords = records.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const timeAxis = sortedRecords.map(r => new Date(r.timestamp).toLocaleDateString('zh-CN'));
            const systolicData = sortedRecords.map(r => r.systolic_pressure);
            const diastolicData = sortedRecords.map(r => r.diastolic_pressure);
            const heartRateData = sortedRecords.map(r => r.heart_rate || null);

            const option = {
                title: { text: '健康趋势图', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['收缩压', '舒张压', '心率'], top: 30 },
                xAxis: { type: 'category', data: timeAxis },
                yAxis: [
                    { type: 'value', name: '血压 (mmHg)', position: 'left' },
                    { type: 'value', name: '心率 (bpm)', position: 'right' }
                ],
                series: [
                    { name: '收缩压', type: 'line', data: systolicData, yAxisIndex: 0, itemStyle: { color: '#ff4d4f' } },
                    { name: '舒张压', type: 'line', data: diastolicData, yAxisIndex: 0, itemStyle: { color: '#52c41a' } },
                    { name: '心率', type: 'line', data: heartRateData, yAxisIndex: 1, itemStyle: { color: '#1890ff' } }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }
    </script>
</body>
</html>
