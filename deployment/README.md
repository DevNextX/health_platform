# 容器化与Azure部署配置

Health Platform 的容器化和Azure部署配置文档。Generated by Zhuang

## 目录结构

```
deployment/
├── backend/
│   └── Dockerfile              # 后端容器配置
├── frontend/
│   ├── Dockerfile              # 前端容器配置
│   └── nginx.conf              # Nginx配置
├── k8s/                        # Kubernetes部署配置
│   ├── backend-deployment.yaml
│   ├── frontend-deployment.yaml
│   ├── ingress.yaml
│   └── secrets-config.yaml
└── azure-webapp.yaml           # Azure WebApp配置
```

## 1. Docker容器化

### 本地开发环境

```bash
# 启动完整的开发环境
docker-compose up -d

# 只启动前后端
docker-compose up backend frontend

# 包含数据库的完整环境
docker-compose --profile database up -d
```

### 生产环境

```bash
# 使用生产配置
docker-compose -f docker-compose.prod.yml up -d
```

### 单独构建镜像

```bash
# 构建后端镜像
docker build -f deployment/backend/Dockerfile -t health-platform-backend .

# 构建前端镜像
docker build -f deployment/frontend/Dockerfile -t health-platform-frontend ./frontend
```

## 2. 安全特性

### 容器安全
- 使用非root用户运行应用
- 只读根文件系统
- 删除所有不必要的Linux能力
- 健康检查配置
- 最小化镜像大小

### 网络安全
- CORS配置
- 安全请求头
- 速率限制
- HTTPS强制重定向

### 数据安全
- 环境变量配置敏感信息
- JWT令牌安全配置
- 数据库连接池配置

## 3. GitHub Actions CI/CD

工作流程包括：
1. 代码测试（前端和后端）
2. 构建Docker镜像
3. 推送到GitHub Container Registry
4. 自动部署到Azure

### 必需的Secrets

在GitHub仓库设置中配置：
```
AZURE_CREDENTIALS           # Azure服务主体凭据
AZURE_WEBAPP_BACKEND_NAME   # Azure后端WebApp名称
AZURE_WEBAPP_FRONTEND_NAME  # Azure前端WebApp名称
```

## 4. Azure WebApp部署

### 前置条件
1. Azure订阅
2. 资源组
3. App Service计划
4. Key Vault（存储敏感配置）

### 部署步骤

```bash
# 使用Azure CLI部署
az deployment group create \
  --resource-group myResourceGroup \
  --template-file deployment/azure-webapp.yaml \
  --parameters siteName=health-platform-backend \
               dockerImage=ghcr.io/devnextx/health_platform/backend:latest
```

### 环境变量配置

在Azure WebApp中配置：
- `DATABASE_URL`: 数据库连接字符串
- `JWT_SECRET`: JWT密钥
- `CORS_ORIGINS`: 允许的源域名

## 5. Azure AKS部署

### 部署到Kubernetes

```bash
# 创建命名空间
kubectl create namespace health-platform

# 部署配置和密钥
kubectl apply -f deployment/k8s/secrets-config.yaml -n health-platform

# 部署应用
kubectl apply -f deployment/k8s/ -n health-platform
```

### 配置密钥

```bash
# 创建数据库连接密钥
kubectl create secret generic health-platform-secrets \
  --from-literal=database-url="your-database-connection-string" \
  --from-literal=jwt-secret="your-jwt-secret" \
  -n health-platform
```

### 查看部署状态

```bash
# 查看部署状态
kubectl get deployments -n health-platform

# 查看服务状态
kubectl get services -n health-platform

# 查看Pod状态
kubectl get pods -n health-platform
```

## 6. 配置说明

### 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `DATABASE_URL` | 数据库连接字符串 | sqlite:///health_platform.db |
| `JWT_SECRET` | JWT密钥 | dev-secret-change-me |
| `CORS_ORIGINS` | 允许的跨域源 | http://localhost:3000 |
| `RATELIMIT_DEFAULT` | 默认速率限制 | 60 per minute |
| `RATELIMIT_AUTH` | 认证速率限制 | 5 per minute |

### 前端配置

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `REACT_APP_API_URL` | 后端API地址 | http://localhost:5000/api/v1 |

## 7. 监控和日志

### 健康检查端点

- 后端: `GET /healthz`
- 前端: `GET /health`

### 日志配置

```bash
# 查看容器日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 查看Kubernetes日志
kubectl logs -f deployment/health-platform-backend -n health-platform
kubectl logs -f deployment/health-platform-frontend -n health-platform
```

## 8. 故障排除

### 常见问题

1. **CORS错误**: 检查`CORS_ORIGINS`环境变量配置
2. **数据库连接失败**: 验证`DATABASE_URL`格式
3. **JWT验证失败**: 确保前后端使用相同的`JWT_SECRET`
4. **容器启动失败**: 检查Docker镜像构建日志

### 调试命令

```bash
# 进入运行中的容器
docker exec -it health-platform-backend-1 /bin/bash
docker exec -it health-platform-frontend-1 /bin/sh

# 检查容器状态
docker-compose ps
docker-compose logs
```

## 9. 扩展和优化

### 水平扩展

Kubernetes配置包含HPA（水平Pod自动缩放器）：
- 后端：2-10个实例
- 前端：3-15个实例
- 基于CPU和内存使用率自动缩放

### 性能优化

- 前端启用Gzip压缩
- 静态资源缓存
- 数据库连接池
- 健康检查和就绪探针

### 高可用性

- 多实例部署
- Pod中断预算
- 网络策略
- 负载均衡配置