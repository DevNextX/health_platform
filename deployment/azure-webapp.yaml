# Azure Web App Configuration for Health Platform
# Generated by Zhuang

apiVersion: 2021-02-01
kind: Microsoft.Web/sites

# Backend Web App
backend:
  name: health-platform-backend
  location: East US
  kind: app,container,linux
  properties:
    serverFarmId: /subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Web/serverfarms/{app-service-plan}
    siteConfig:
      linuxFxVersion: "DOCKER|ghcr.io/devnextx/health_platform/backend:latest"
      appSettings:
        - name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
          value: "false"
        - name: DATABASE_URL
          value: "@Microsoft.KeyVault(SecretUri=https://{keyvault-name}.vault.azure.net/secrets/database-url/)"
        - name: JWT_SECRET
          value: "@Microsoft.KeyVault(SecretUri=https://{keyvault-name}.vault.azure.net/secrets/jwt-secret/)"
        - name: CORS_ORIGINS
          value: "https://{frontend-url}.azurewebsites.net"
        - name: RATELIMIT_DEFAULT
          value: "100 per minute"
        - name: RATELIMIT_AUTH
          value: "10 per minute"
        - name: PYTHONPATH
          value: "/app"
      healthCheckPath: "/healthz"
    httpsOnly: true
    clientAffinityEnabled: false

# Frontend Web App
frontend:
  name: health-platform-frontend
  location: East US
  kind: app,container,linux
  properties:
    serverFarmId: /subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Web/serverfarms/{app-service-plan}
    siteConfig:
      linuxFxVersion: "DOCKER|ghcr.io/devnextx/health_platform/frontend:latest"
      appSettings:
        - name: WEBSITES_ENABLE_APP_SERVICE_STORAGE
          value: "false"
        - name: REACT_APP_API_URL
          value: "https://{backend-url}.azurewebsites.net/api/v1"
      healthCheckPath: "/health"
    httpsOnly: true
    clientAffinityEnabled: false

# ARM Template for deployment
armTemplate:
  $schema: "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
  contentVersion: "1.0.0.0"
  parameters:
    siteName:
      type: "string"
      metadata:
        description: "Name of the Web App"
    dockerImage:
      type: "string"
      metadata:
        description: "Docker image for the Web App"
    databaseUrl:
      type: "securestring"
      metadata:
        description: "Database connection string"
    jwtSecret:
      type: "securestring"
      metadata:
        description: "JWT secret key"
  variables:
    appServicePlanName: "[concat(parameters('siteName'), '-plan')]"
  resources:
    - type: "Microsoft.Web/serverfarms"
      apiVersion: "2021-02-01"
      name: "[variables('appServicePlanName')]"
      location: "[resourceGroup().location]"
      sku:
        name: "B1"
        tier: "Basic"
        size: "B1"
        family: "B"
        capacity: 1
      kind: "linux"
      properties:
        reserved: true
    - type: "Microsoft.Web/sites"
      apiVersion: "2021-02-01"
      name: "[parameters('siteName')]"
      location: "[resourceGroup().location]"
      dependsOn:
        - "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
      kind: "app,container,linux"
      properties:
        serverFarmId: "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
        siteConfig:
          linuxFxVersion: "[concat('DOCKER|', parameters('dockerImage'))]"
          appSettings:
            - name: "WEBSITES_ENABLE_APP_SERVICE_STORAGE"
              value: "false"
            - name: "DATABASE_URL"
              value: "[parameters('databaseUrl')]"
            - name: "JWT_SECRET"
              value: "[parameters('jwtSecret')]"
        httpsOnly: true