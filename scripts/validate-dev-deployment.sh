#!/bin/bash
# Deployment Configuration Validation Script
# Generated by Zhuang

set -e

echo "🔍 Validating Health Platform Development Deployment Configuration..."

# Check if required files exist
echo "📁 Checking required files..."
required_files=(
    ".github/workflows/deploy-dev.yml"
    "deploy/config/dev.env"
    "deploy/k8s-template.yaml"
    "deploy/deploy-configurable.sh"
    "Dockerfile.backend"
    "Dockerfile.frontend.nonroot"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "✅ Found: $file"
    else
        echo "❌ Missing: $file"
        exit 1
    fi
done

echo ""
echo "🔧 Checking deployment script permissions..."
if [ -x "deploy/deploy-configurable.sh" ]; then
    echo "✅ deploy-configurable.sh is executable"
else
    echo "⚠️  Making deploy-configurable.sh executable..."
    chmod +x deploy/deploy-configurable.sh
fi

echo ""
echo "📋 优化后的GitHub变量配置："
echo ""
echo "Repository Variables (仓库级别 - 所有环境共享):"
echo "  - REGISTRY_URL (推荐: ghcr.io/devnextx)"
echo ""
echo "Environment Variables (环境级别 - 仅该环境特定):"
echo "  - NAMESPACE (推荐: health-platform-dev)"
echo "  - BACKEND_REPLICAS (当前: 1)"
echo "  - FRONTEND_REPLICAS (当前: 1)"  
echo "  - SERVICE_TYPE (当前: LoadBalancer)"
echo ""
echo "Secrets (敏感信息):"
echo "  - DEV_KUBE_CONFIG (kubeconfig content)"
echo "  - DEV_KUBE_CONTEXT (kubernetes context name)"
echo ""
echo "固定值 (代码中硬编码，无需配置):"
echo "  - 所有资源限制配置 (MEMORY/CPU REQUEST/LIMIT)"
echo "  - FLASK_ENV=development"

echo ""
echo "🎯 Variable Priority Order (High → Low):"
echo "  1. GitHub Actions Workflow env settings (highest)"
echo "  2. GitHub Environment Variables"
echo "  3. Local dev.env file (lowest)"

echo ""
echo "🚀 To trigger deployment:"
echo "  1. Create 'develop' branch if not exists:"
echo "     git checkout -b develop"
echo "     git push origin develop"
echo ""
echo "  2. Make changes and push to develop:"
echo "     git add ."
echo "     git commit -m 'Test deployment'"
echo "     git push origin develop"
echo ""
echo "  3. Or trigger manually:"
echo "     Go to GitHub Actions → Deploy to Development → Run workflow"

echo ""
echo "✅ Configuration validation completed!"
echo ""
echo "⚠️  Next steps:"
echo "1. Ensure all GitHub Environment variables are set"
echo "2. Verify DEV_KUBE_CONFIG and DEV_KUBE_CONTEXT secrets"
echo "3. Create develop branch if needed"
echo "4. Test deployment by pushing to develop branch"
