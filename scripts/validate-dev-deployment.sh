#!/bin/bash
# Deployment Configuration Validation Script
# Generated by Zhuang

set -e

echo "ğŸ” Validating Health Platform Development Deployment Configuration..."

# Check if required files exist
echo "ğŸ“ Checking required files..."
required_files=(
    ".github/workflows/deploy-dev.yml"
    "deploy/config/dev.env"
    "deploy/k8s-template.yaml"
    "deploy/deploy-configurable.sh"
    "Dockerfile.backend"
    "Dockerfile.frontend.nonroot"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "âœ… Found: $file"
    else
        echo "âŒ Missing: $file"
        exit 1
    fi
done

echo ""
echo "ğŸ”§ Checking deployment script permissions..."
if [ -x "deploy/deploy-configurable.sh" ]; then
    echo "âœ… deploy-configurable.sh is executable"
else
    echo "âš ï¸  Making deploy-configurable.sh executable..."
    chmod +x deploy/deploy-configurable.sh
fi

echo ""
echo "ğŸ“‹ ä¼˜åŒ–åçš„GitHubå˜é‡é…ç½®ï¼š"
echo ""
echo "Repository Variables (ä»“åº“çº§åˆ« - æ‰€æœ‰ç¯å¢ƒå…±äº«):"
echo "  - REGISTRY_URL (æ¨è: ghcr.io/devnextx)"
echo ""
echo "Environment Variables (ç¯å¢ƒçº§åˆ« - ä»…è¯¥ç¯å¢ƒç‰¹å®š):"
echo "  - NAMESPACE (æ¨è: health-platform-dev)"
echo "  - BACKEND_REPLICAS (å½“å‰: 1)"
echo "  - FRONTEND_REPLICAS (å½“å‰: 1)"  
echo "  - SERVICE_TYPE (å½“å‰: LoadBalancer)"
echo ""
echo "Secrets (æ•æ„Ÿä¿¡æ¯):"
echo "  - DEV_KUBE_CONFIG (kubeconfig content)"
echo "  - DEV_KUBE_CONTEXT (kubernetes context name)"
echo ""
echo "å›ºå®šå€¼ (ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œæ— éœ€é…ç½®):"
echo "  - æ‰€æœ‰èµ„æºé™åˆ¶é…ç½® (MEMORY/CPU REQUEST/LIMIT)"
echo "  - FLASK_ENV=development"

echo ""
echo "ğŸ¯ Variable Priority Order (High â†’ Low):"
echo "  1. GitHub Actions Workflow env settings (highest)"
echo "  2. GitHub Environment Variables"
echo "  3. Local dev.env file (lowest)"

echo ""
echo "ğŸš€ To trigger deployment:"
echo "  1. Create 'develop' branch if not exists:"
echo "     git checkout -b develop"
echo "     git push origin develop"
echo ""
echo "  2. Make changes and push to develop:"
echo "     git add ."
echo "     git commit -m 'Test deployment'"
echo "     git push origin develop"
echo ""
echo "  3. Or trigger manually:"
echo "     Go to GitHub Actions â†’ Deploy to Development â†’ Run workflow"

echo ""
echo "âœ… Configuration validation completed!"
echo ""
echo "âš ï¸  Next steps:"
echo "1. Ensure all GitHub Environment variables are set"
echo "2. Verify DEV_KUBE_CONFIG and DEV_KUBE_CONTEXT secrets"
echo "3. Create develop branch if needed"
echo "4. Test deployment by pushing to develop branch"
