"""
Test cases for WeChat OAuth endpoints. Generated by Copilot
"""
import json
import pytest
from unittest.mock import patch, MagicMock
from src.manager.wechat_manager import WeChatManager
from src.manager.user_manager import UserManager


class TestWeChatEndpoints:
    """Test WeChat OAuth related endpoints"""
    
    def test_get_qr_code_success(self, client, app):
        """Test successful QR code parameter generation"""
        with app.app_context():
            app.config['WECHAT_APP_ID'] = 'test_app_id'
            app.config['WECHAT_REDIRECT_URI'] = 'http://localhost:3000/callback'
            
            response = client.get('/api/v1/auth/wechat/qr')
            assert response.status_code == 200
            
            data = response.get_json()
            assert 'qr_url' in data
            assert 'appid' in data
            assert 'state' in data
            assert 'test_app_id' in data['qr_url']
    
    def test_get_qr_code_no_config(self, client, app):
        """Test QR code generation without WeChat configuration"""
        with app.app_context():
            app.config['WECHAT_APP_ID'] = ''
            app.config['WECHAT_REDIRECT_URI'] = ''
            
            response = client.get('/api/v1/auth/wechat/qr')
            assert response.status_code == 500
            
            data = response.get_json()
            assert data['code'] == '500'
    
    @patch('src.manager.wechat_manager.requests.get')
    def test_wechat_callback_success_new_user(self, mock_get, client, app):
        """Test successful WeChat callback creating a new user"""
        # Mock WeChat API responses
        mock_token_response = MagicMock()
        mock_token_response.json.return_value = {
            "access_token": "test_access_token",
            "openid": "test_openid",
            "unionid": "test_unionid"
        }
        
        mock_user_response = MagicMock()
        mock_user_response.json.return_value = {
            "nickname": "测试用户",
            "headimgurl": "http://example.com/avatar.jpg",
            "unionid": "test_unionid"
        }
        
        mock_get.side_effect = [mock_token_response, mock_user_response]
        
        with app.app_context():
            app.config['WECHAT_APP_ID'] = 'test_app_id'
            app.config['WECHAT_APP_SECRET'] = 'test_secret'
            
            callback_data = {
                'code': 'test_authorization_code'
            }
            
            response = client.post('/api/v1/auth/wechat/callback', json=callback_data)
            assert response.status_code == 200
            
            data = response.get_json()
            assert 'access_token' in data
            assert 'refresh_token' in data
            assert data['token_type'] == 'Bearer'
            assert 'user' in data
            assert data['user']['username'] == '测试用户'
            assert data['user']['is_wechat_user'] is True
    
    @patch('src.manager.wechat_manager.requests.get')
    def test_wechat_callback_existing_user(self, mock_get, client, app):
        """Test WeChat callback with existing WeChat user"""
        with app.app_context():
            # Create a WeChat user first
            wechat_manager = WeChatManager()
            user = wechat_manager.create_wechat_user(
                "existing_unionid",
                "Existing User",
                "http://example.com/avatar.jpg"
            )
            
            # Mock WeChat API responses
            mock_token_response = MagicMock()
            mock_token_response.json.return_value = {
                "access_token": "test_access_token",
                "openid": "test_openid",
                "unionid": "existing_unionid"
            }
            
            mock_user_response = MagicMock()
            mock_user_response.json.return_value = {
                "nickname": "Existing User",
                "headimgurl": "http://example.com/avatar.jpg",
                "unionid": "existing_unionid"
            }
            
            mock_get.side_effect = [mock_token_response, mock_user_response]
            
            app.config['WECHAT_APP_ID'] = 'test_app_id'
            app.config['WECHAT_APP_SECRET'] = 'test_secret'
            
            callback_data = {
                'code': 'test_authorization_code'
            }
            
            response = client.post('/api/v1/auth/wechat/callback', json=callback_data)
            assert response.status_code == 200
            
            data = response.get_json()
            assert 'access_token' in data
            assert data['user']['id'] == user.id
    
    def test_wechat_callback_missing_code(self, client):
        """Test WeChat callback without authorization code"""
        response = client.post('/api/v1/auth/wechat/callback', json={})
        assert response.status_code == 400
        
        data = response.get_json()
        assert data['code'] == '400'
    
    @patch('src.manager.wechat_manager.requests.get')
    def test_bind_wechat_success(self, mock_get, client, auth_headers, app):
        """Test successful WeChat binding to existing user"""
        with app.app_context():
            # Mock WeChat API responses
            mock_token_response = MagicMock()
            mock_token_response.json.return_value = {
                "access_token": "test_access_token",
                "openid": "test_openid",
                "unionid": "new_unionid"
            }
            
            mock_user_response = MagicMock()
            mock_user_response.json.return_value = {
                "nickname": "WeChat User",
                "headimgurl": "http://example.com/avatar.jpg",
                "unionid": "new_unionid"
            }
            
            mock_get.side_effect = [mock_token_response, mock_user_response]
            
            app.config['WECHAT_APP_ID'] = 'test_app_id'
            app.config['WECHAT_APP_SECRET'] = 'test_secret'
            
            bind_data = {
                'code': 'test_authorization_code'
            }
            
            response = client.post(
                '/api/v1/auth/wechat/bind',
                json=bind_data,
                headers=auth_headers['access']
            )
            assert response.status_code == 200
            
            data = response.get_json()
            assert data['message'] == 'WeChat account bound successfully'
            assert data['user']['wechat_bound'] is True
    
    @patch('src.manager.wechat_manager.requests.get')
    def test_bind_wechat_already_bound(self, mock_get, client, auth_headers, app):
        """Test binding WeChat that's already bound to another user"""
        with app.app_context():
            # Create another user with this unionid
            wechat_manager = WeChatManager()
            wechat_manager.create_wechat_user(
                "already_bound_unionid",
                "Another User",
                "http://example.com/avatar.jpg"
            )
            
            # Mock WeChat API responses
            mock_token_response = MagicMock()
            mock_token_response.json.return_value = {
                "access_token": "test_access_token",
                "openid": "test_openid",
                "unionid": "already_bound_unionid"
            }
            
            mock_user_response = MagicMock()
            mock_user_response.json.return_value = {
                "nickname": "WeChat User",
                "headimgurl": "http://example.com/avatar.jpg",
                "unionid": "already_bound_unionid"
            }
            
            mock_get.side_effect = [mock_token_response, mock_user_response]
            
            app.config['WECHAT_APP_ID'] = 'test_app_id'
            app.config['WECHAT_APP_SECRET'] = 'test_secret'
            
            bind_data = {
                'code': 'test_authorization_code'
            }
            
            response = client.post(
                '/api/v1/auth/wechat/bind',
                json=bind_data,
                headers=auth_headers['access']
            )
            assert response.status_code == 409
            
            data = response.get_json()
            assert data['code'] == '409'


class TestWeChatManager:
    """Test WeChat manager methods"""
    
    def test_create_wechat_user(self, app):
        """Test creating a new WeChat user"""
        with app.app_context():
            wechat_manager = WeChatManager()
            user = wechat_manager.create_wechat_user(
                "test_unionid_123",
                "Test User",
                "http://example.com/avatar.jpg"
            )
            
            assert user.id is not None
            assert user.username == "Test User"
            assert user.wechat_unionid == "test_unionid_123"
            assert user.avatar_url == "http://example.com/avatar.jpg"
            assert user.is_wechat_user is True
            assert user.password_hash is None
            assert "wechat_" in user.email
    
    def test_find_user_by_unionid(self, app):
        """Test finding user by WeChat unionid"""
        with app.app_context():
            wechat_manager = WeChatManager()
            
            # Create a user
            created_user = wechat_manager.create_wechat_user(
                "find_test_unionid",
                "Find Test User",
                None
            )
            
            # Find the user
            found_user = wechat_manager.find_user_by_unionid("find_test_unionid")
            assert found_user is not None
            assert found_user.id == created_user.id
            assert found_user.username == "Find Test User"
            
            # Try to find non-existent user
            not_found = wechat_manager.find_user_by_unionid("nonexistent_unionid")
            assert not_found is None
    
    def test_bind_wechat_to_user(self, app):
        """Test binding WeChat to existing email user"""
        with app.app_context():
            user_manager = UserManager()
            wechat_manager = WeChatManager()
            
            # Create a regular email user
            user = user_manager.create_user(
                "bindtest",
                "bind@example.com",
                "password123"
            )
            
            # Bind WeChat
            updated_user = wechat_manager.bind_wechat_to_user(
                user,
                "bind_unionid",
                "http://example.com/avatar.jpg"
            )
            
            assert updated_user.wechat_unionid == "bind_unionid"
            assert updated_user.avatar_url == "http://example.com/avatar.jpg"
            assert updated_user.password_hash is not None  # Should still have password
    
    def test_bind_wechat_already_bound_to_another(self, app):
        """Test binding WeChat that's already bound to another user"""
        with app.app_context():
            user_manager = UserManager()
            wechat_manager = WeChatManager()
            
            # Create first user and bind WeChat
            user1 = user_manager.create_user(
                "user1",
                "user1@example.com",
                "password123"
            )
            wechat_manager.bind_wechat_to_user(user1, "shared_unionid", None)
            
            # Create second user
            user2 = user_manager.create_user(
                "user2",
                "user2@example.com",
                "password123"
            )
            
            # Try to bind the same WeChat to user2
            with pytest.raises(ValueError) as exc_info:
                wechat_manager.bind_wechat_to_user(user2, "shared_unionid", None)
            
            assert str(exc_info.value) == "WECHAT_ALREADY_BOUND"
