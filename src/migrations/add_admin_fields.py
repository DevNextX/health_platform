"""
Database migration to add admin and versioning fields to users table.
Generated by Copilot
"""
from datetime import datetime
from sqlalchemy import text
from ..extensions import db
from ..models import User


def upgrade():
    """Add role and must_change_password fields to users table"""
    # Check if columns already exist to avoid duplicate migration
    inspector = db.inspect(db.engine)
    columns = [col['name'] for col in inspector.get_columns('users')]
    
    # Add role column if it doesn't exist
    if 'role' not in columns:
        if db.engine.dialect.name == 'sqlite':
            db.session.execute(text("ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'USER' NOT NULL"))
        elif db.engine.dialect.name == 'mysql':
            db.session.execute(text("ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'USER' NOT NULL"))
        else:
            # Generic SQL for PostgreSQL and others
            db.session.execute(text("ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'USER' NOT NULL"))
    
    # Add must_change_password column if it doesn't exist
    if 'must_change_password' not in columns:
        if db.engine.dialect.name == 'sqlite':
            db.session.execute(text("ALTER TABLE users ADD COLUMN must_change_password BOOLEAN DEFAULT 0 NOT NULL"))
        elif db.engine.dialect.name == 'mysql':
            db.session.execute(text("ALTER TABLE users ADD COLUMN must_change_password BOOLEAN DEFAULT FALSE NOT NULL"))
        else:
            # Generic SQL for PostgreSQL and others
            db.session.execute(text("ALTER TABLE users ADD COLUMN must_change_password BOOLEAN DEFAULT FALSE NOT NULL"))
    
    db.session.commit()
    print("Migration completed: added role and must_change_password fields to users table")


def downgrade():
    """Remove role and must_change_password fields from users table"""
    # Note: SQLite doesn't support DROP COLUMN, so we skip downgrade for SQLite
    if db.engine.dialect.name != 'sqlite':
        try:
            db.session.execute(text("ALTER TABLE users DROP COLUMN role"))
            db.session.execute(text("ALTER TABLE users DROP COLUMN must_change_password"))
            db.session.commit()
            print("Migration downgraded: removed admin fields from users table")
        except Exception as e:
            db.session.rollback()
            print(f"Downgrade failed: {e}")
    else:
        print("SQLite does not support DROP COLUMN, skipping downgrade")


if __name__ == "__main__":
    # For manual execution
    from flask import Flask
    from ..config import Config
    from ..extensions import db
    
    app = Flask(__name__)
    app.config.from_object(Config)
    db.init_app(app)
    
    with app.app_context():
        upgrade()