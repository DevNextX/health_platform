"""
Admin service endpoints for user management.
Generated by Copilot
"""
from flask import Blueprint, request, jsonify
from flask_jwt_extended import get_jwt_identity
from ..manager.user_manager import UserManager
from ..utils.auth import require_admin, require_super_admin, RoleChecker, validate_role_change
from ..utils import error

admin_bp = Blueprint("admin", __name__)
user_manager = UserManager()
role_checker = RoleChecker(user_manager)


@admin_bp.route("/users", methods=["GET"])
@require_admin
def list_users(current_user):
    """List all users (filtered by role permissions)"""
    page = int(request.args.get("page", 1))
    size = int(request.args.get("size", 20))
    
    # Apply role-based filtering
    exclude_roles = []
    if current_user.role == "ADMIN":
        exclude_roles = ["SUPER_ADMIN"]  # Admin cannot see super admin
    
    try:
        result = user_manager.list_users(exclude_roles=exclude_roles, page=page, size=size)
        return jsonify(result), 200
    except Exception as e:
        return jsonify(error("500", f"Failed to list users: {str(e)}")), 500


@admin_bp.route("/users/<int:user_id>/role", methods=["PUT"])
@require_super_admin
def change_user_role(user_id: int, current_user):
    """Change user role (SUPER_ADMIN only)"""
    data = request.get_json(force=True) or {}
    new_role = data.get("role", "").upper()
    
    if not new_role:
        return jsonify(error("400", "Role is required")), 400
    
    # Get target user
    target_user = user_manager.get_user(user_id)
    if not target_user:
        return jsonify(error("404", "User not found")), 404
    
    # Prevent changing own role
    if target_user.id == current_user.id:
        return jsonify(error("403", "Cannot change own role")), 403
    
    # Validate role change
    is_valid, error_msg = validate_role_change(
        current_user.role, 
        target_user.role, 
        new_role
    )
    
    if not is_valid:
        if "super admin" in error_msg.lower():
            return jsonify(error("400", error_msg, {"code": "SUPER_ADMIN_PROTECT"})), 400
        elif "additional super admin" in error_msg.lower():
            return jsonify(error("400", error_msg, {"code": "SUPER_ADMIN_UNIQUE_VIOLATION"})), 400
        else:
            return jsonify(error("400", error_msg)), 400
    
    # Check if role is already the same (idempotent)
    if target_user.role == new_role:
        return jsonify({
            "id": target_user.id,
            "username": target_user.username,
            "email": target_user.email,
            "role": target_user.role,
            "updated_at": target_user.updated_at.isoformat() + "Z"
        }), 200
    
    # Change role
    try:
        user_manager.change_user_role(target_user, new_role)
        return jsonify({
            "id": target_user.id,
            "username": target_user.username,
            "email": target_user.email,
            "role": target_user.role,
            "updated_at": target_user.updated_at.isoformat() + "Z"
        }), 200
    except ValueError as e:
        if str(e) == "SUPER_ADMIN_UNIQUE_VIOLATION":
            return jsonify(error("400", "Cannot create additional super admin", {"code": "SUPER_ADMIN_UNIQUE_VIOLATION"})), 400
        elif str(e) == "INVALID_ROLE":
            return jsonify(error("400", "Invalid role")), 400
        else:
            return jsonify(error("500", f"Failed to change role: {str(e)}")), 500


@admin_bp.route("/users/<int:user_id>/password/reset", methods=["POST"])
@require_admin
def reset_user_password(user_id: int, current_user):
    """Reset user password (ADMIN and SUPER_ADMIN)"""
    # Get target user
    target_user = user_manager.get_user(user_id)
    if not target_user:
        return jsonify(error("404", "User not found")), 404
    
    # Prevent resetting own password through admin interface
    if target_user.id == current_user.id:
        return jsonify(error("400", "Use change password endpoint to reset own password")), 400
    
    # Check permissions
    if not role_checker.can_reset_password(current_user.role, target_user.role):
        return jsonify(error("403", "Cannot reset this user's password")), 403
    
    # Reset password
    try:
        temp_password = user_manager.reset_user_password(target_user, reset_by_admin=True)
        return jsonify({
            "message": "Password reset successfully",
            "temporary_password": temp_password,
            "user_id": target_user.id,
            "must_change_password": True
        }), 200
    except Exception as e:
        return jsonify(error("500", f"Failed to reset password: {str(e)}")), 500


@admin_bp.route("/users/<int:user_id>", methods=["GET"])
@require_admin
def get_user_details(user_id: int, current_user):
    """Get user details (for admin interface)"""
    target_user = user_manager.get_user(user_id)
    if not target_user:
        return jsonify(error("404", "User not found")), 404
    
    # Check if current user can view this user
    if current_user.role == "ADMIN" and target_user.role == "SUPER_ADMIN":
        return jsonify(error("403", "Cannot view super admin details")), 403
    
    return jsonify({
        "id": target_user.id,
        "username": target_user.username,
        "email": target_user.email,
        "role": target_user.role,
        "must_change_password": target_user.must_change_password,
        "age": target_user.age,
        "gender": target_user.gender,
        "weight": target_user.weight,
        "created_at": target_user.created_at.isoformat() + "Z",
        "updated_at": target_user.updated_at.isoformat() + "Z"
    }), 200


@admin_bp.route("/stats", methods=["GET"])
@require_admin
def get_admin_stats(current_user):
    """Get basic admin statistics"""
    try:
        from sqlalchemy import func
        from ..models import User
        from ..extensions import db
        
        # Get user counts by role (based on current user's view permissions)
        if current_user.role == "SUPER_ADMIN":
            user_counts = db.session.query(User.role, func.count(User.id)).group_by(User.role).all()
        else:
            # Admin cannot see super admin count
            user_counts = db.session.query(User.role, func.count(User.id)).filter(
                User.role != "SUPER_ADMIN"
            ).group_by(User.role).all()
        
        role_counts = {role: count for role, count in user_counts}
        total_users = sum(role_counts.values())
        
        return jsonify({
            "total_users": total_users,
            "users_by_role": role_counts,
            "admin_role": current_user.role
        }), 200
    except Exception as e:
        return jsonify(error("500", f"Failed to get stats: {str(e)}")), 500