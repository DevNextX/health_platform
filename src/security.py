"""
Security helpers. Generated by Zhuang
"""
from datetime import timedelta
from typing import Optional, Union
from flask_jwt_extended import create_access_token, create_refresh_token
from werkzeug.security import generate_password_hash, check_password_hash
import secrets
import string


def hash_password(password: str) -> str:
    return generate_password_hash(password)


def verify_password(password: str, password_hash: str) -> bool:
    return check_password_hash(password_hash, password)


def make_tokens(identity: Union[str, int], token_version: int, additional_claims: Optional[dict] = None,
                access_expires: Optional[timedelta] = None, refresh_expires: Optional[timedelta] = None) -> dict:
    claims = {"token_version": token_version}
    if additional_claims:
        claims.update(additional_claims)
    at = create_access_token(identity=identity, additional_claims=claims, expires_delta=access_expires)
    rt = create_refresh_token(identity=identity, additional_claims=claims, expires_delta=refresh_expires)
    return {"access_token": at, "refresh_token": rt}


def validate_password_strength(password: str) -> bool:
    """Return True if password is at least 8 chars and contains letters and digits."""
    if not password or len(password) < 8:
        return False
    has_alpha = any(c.isalpha() for c in password)
    has_digit = any(c.isdigit() for c in password)
    return has_alpha and has_digit


def generate_temp_password(length: int = 12) -> str:
    """Generate a strong temporary password with letters, digits and symbols.
    Ensures at least one lowercase, one uppercase, one digit, one symbol.
    """
    length = max(8, length)
    lower = string.ascii_lowercase
    upper = string.ascii_uppercase
    digits = string.digits
    symbols = "!@#$%^&*()-_=+[]{};:,.?"  # avoid quotes and backslashes for safety
    # Guarantee minimal composition
    base = [
        secrets.choice(lower),
        secrets.choice(upper),
        secrets.choice(digits),
        secrets.choice(symbols),
    ]
    pool = lower + upper + digits + symbols
    rest = [secrets.choice(pool) for _ in range(length - len(base))]
    chars = base + rest
    secrets.SystemRandom().shuffle(chars)
    return ''.join(chars)
