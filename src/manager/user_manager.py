"""
User manager layer. Generated by Zhuang
"""
from typing import Optional
from sqlalchemy.exc import IntegrityError
from ..extensions import db
from ..models import User
from sqlalchemy import func
from datetime import datetime
from ..timeutil import UTC
from ..security import hash_password


class UserManager:
    def create_user(self, username: str, email: str, password: str,
                    age: Optional[int] = None, gender: Optional[str] = None, weight: Optional[float] = None) -> User:
        user = User()
        # Normalize username to lowercase for case-insensitive handling
        user.username = (username or "").lower()
        user.email = email
        user.password_hash = hash_password(password)
        user.age = age
        user.gender = gender
        user.weight = weight
        db.session.add(user)
        try:
            db.session.commit()
        except IntegrityError:
            db.session.rollback()
            raise ValueError("EMAIL_EXISTS")
        return user

    def get_user(self, user_id: int) -> Optional[User]:
        # Use modern Session.get API to avoid LegacyAPIWarning
        return db.session.get(User, user_id)

    def get_user_by_email(self, email: str) -> Optional[User]:
        return User.query.filter_by(email=email).first()

    def get_user_by_username_ci(self, username: str) -> Optional[User]:
        if not username:
            return None
        return User.query.filter(func.lower(User.username) == (username or "").lower()).first()

    def update_user(self, user: User, **fields) -> User:
        for k, v in fields.items():
            if v is not None and hasattr(user, k):
                setattr(user, k, v)
        db.session.commit()
        return user

    def bump_token_version(self, user: User):
        user.token_version += 1
        db.session.commit()

    def set_password(self, user: User, new_password: str, force_change_next_login: bool = False):
        user.password_hash = hash_password(new_password)
        user.must_change_password = bool(force_change_next_login)
        # Invalidate existing refresh tokens
        user.token_version += 1
        db.session.commit()

    def set_role(self, user: User, role: str):
        user.role = role
        db.session.commit()

    def set_last_login(self, user: User):
        user.last_login_at = datetime.now(UTC)
        db.session.commit()
