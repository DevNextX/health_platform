"""
WeChat OAuth manager layer. Generated by Copilot
"""
import requests
from typing import Optional, Dict, Any
from flask import current_app
from ..extensions import db
from ..models import User
from ..security import hash_password


class WeChatManager:
    """Manager for WeChat OAuth operations"""
    
    WECHAT_API_BASE = "https://api.weixin.qq.com"
    WECHAT_OPEN_BASE = "https://open.weixin.qq.com"
    
    def get_qr_ticket(self) -> Optional[Dict[str, Any]]:
        """
        Get QR code ticket for WeChat login.
        Returns ticket data or None if failed.
        """
        app_id = current_app.config.get("WECHAT_APP_ID")
        redirect_uri = current_app.config.get("WECHAT_REDIRECT_URI")
        
        if not app_id or not redirect_uri:
            return None
            
        # WeChat uses a ticket-based system for QR code generation
        # In production, you would call WeChat's API to get a ticket
        # For now, we return the parameters needed for QR code generation
        return {
            "appid": app_id,
            "redirect_uri": redirect_uri,
            "scope": "snsapi_login",
            "state": "STATE"  # Should be a random state for CSRF protection
        }
    
    def get_access_token(self, code: str) -> Optional[Dict[str, Any]]:
        """
        Exchange authorization code for access token.
        Returns dict with access_token, openid, unionid or None if failed.
        """
        app_id = current_app.config.get("WECHAT_APP_ID")
        app_secret = current_app.config.get("WECHAT_APP_SECRET")
        
        if not app_id or not app_secret:
            return None
            
        url = f"{self.WECHAT_API_BASE}/sns/oauth2/access_token"
        params = {
            "appid": app_id,
            "secret": app_secret,
            "code": code,
            "grant_type": "authorization_code"
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            data = response.json()
            
            if "errcode" in data:
                current_app.logger.error(f"WeChat access token error: {data}")
                return None
                
            return data
        except Exception as e:
            current_app.logger.error(f"WeChat access token request failed: {e}")
            return None
    
    def get_user_info(self, access_token: str, openid: str) -> Optional[Dict[str, Any]]:
        """
        Get WeChat user information.
        Returns dict with nickname, headimgurl, unionid or None if failed.
        """
        url = f"{self.WECHAT_API_BASE}/sns/userinfo"
        params = {
            "access_token": access_token,
            "openid": openid
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            data = response.json()
            
            if "errcode" in data:
                current_app.logger.error(f"WeChat user info error: {data}")
                return None
                
            return data
        except Exception as e:
            current_app.logger.error(f"WeChat user info request failed: {e}")
            return None
    
    def find_user_by_unionid(self, unionid: str) -> Optional[User]:
        """Find user by WeChat unionid"""
        return User.query.filter_by(wechat_unionid=unionid).first()
    
    def create_wechat_user(self, unionid: str, nickname: str, avatar_url: str = None) -> User:
        """
        Create a new user from WeChat login.
        Email is generated as wechat_{unionid}@wechat.placeholder
        Password is set to None for WeChat-only users.
        """
        # Generate a unique email for WeChat users
        email = f"wechat_{unionid}@wechat.placeholder"
        
        user = User()
        user.username = nickname
        user.email = email
        user.password_hash = None  # No password for WeChat-only users
        user.wechat_unionid = unionid
        user.avatar_url = avatar_url
        user.is_wechat_user = True
        
        db.session.add(user)
        db.session.commit()
        return user
    
    def bind_wechat_to_user(self, user: User, unionid: str, avatar_url: str = None) -> User:
        """
        Bind WeChat account to an existing user.
        Raises ValueError if unionid is already bound to another user.
        """
        # Check if unionid is already bound to another user
        existing = self.find_user_by_unionid(unionid)
        if existing and existing.id != user.id:
            raise ValueError("WECHAT_ALREADY_BOUND")
        
        user.wechat_unionid = unionid
        if avatar_url:
            user.avatar_url = avatar_url
        db.session.commit()
        return user
