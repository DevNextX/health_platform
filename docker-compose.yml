# Generated by Zhuang; docker-compose for local/dev
version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: health-platform-backend:local
    environment:
      # External DB configuration; override as needed
      - DATABASE_URL=${DATABASE_URL:-mysql+pymysql://user:password@mysql:3306/healthdb?charset=utf8mb4}
      - JWT_SECRET=${JWT_SECRET:-dev-change-me}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}
      - JWT_ACCESS_MINUTES=${JWT_ACCESS_MINUTES:-30}
      - JWT_REFRESH_DAYS=${JWT_REFRESH_DAYS:-7}
      - PORT=5000
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:5000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: health-platform-frontend:local
    environment:
      - API_URL=${API_URL:-http://backend:5000}
      - LISTEN_PORT=80
    ports:
      - "8080:80"
    depends_on:
      backend:
        condition: service_healthy

  # Optional MySQL for local development (uncomment to use)
  # mysql:
  #   image: mysql:8.0
  #   environment:
  #     - MYSQL_DATABASE=healthdb
  #     - MYSQL_USER=user
  #     - MYSQL_PASSWORD=password
  #     - MYSQL_ROOT_PASSWORD=devroot
  #   ports:
  #     - "3306:3306"
  #   command: ["mysqld", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-pdevroot"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
