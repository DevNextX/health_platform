# 贡献指南

感谢您对健康记录平台的贡献！本文档介绍代码规范、提交流程和版本发布机制。

## 代码规范

### 语言约定
- **代码与注释**：统一使用英文
- **协作沟通**：使用中文
- **提交标注**：保留 `Generated by Copilot` 标记

### Python 风格
- 遵循 PEP 8
- 使用 `datetime.now(UTC)` 而非 `datetime.utcnow()`（已废弃）
- 空字符串视为 `None/null` 处理

### React 风格
- 函数式组件 + Hooks
- 使用 Ant Design 组件库
- i18next 国际化

## Git 提交规范

使用 [Conventional Commits](https://www.conventionalcommits.org/)：

```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

**Type 类型**：
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具

**示例**：
```
feat(admin): add user role management API
fix(chart): correct Y-axis scale for blood pressure
docs: update README with version management
```

## 版本发布流程

### 版本号规范

采用 [语义化版本](https://semver.org/lang/zh-CN/)：`MAJOR.MINOR.PATCH`

- **MAJOR**：不兼容的 API 变更
- **MINOR**：向下兼容的功能新增
- **PATCH**：向下兼容的问题修复

### 发布步骤

1. **更新版本号**
   ```bash
   # 编辑 VERSION 文件
   echo "1.1.0" > VERSION
   ```

2. **更新变更日志**
   ```markdown
   # CHANGELOG.md
   ## [1.1.0] - 2025-12-01
   
   ### 新增
   - 功能描述
   
   ### 修复
   - Bug 描述
   ```

3. **提交并打标签**
   ```bash
   git add VERSION CHANGELOG.md
   git commit -m "chore: release v1.1.0"
   git tag v1.1.0
   git push origin main --tags
   ```

### 版本号读取机制

```
VERSION 文件
    │
    ├──► 后端: src/config.py 读取
    │         │
    │         ▼
    │    GET /api/v1/version
    │         │
    └──► 前端: 登录页调用 API 显示
```

## Pull Request 流程

1. Fork 仓库或创建功能分支
2. 编写代码和测试
3. 确保测试通过：`pytest tests/ -v`
4. 提交 PR，填写描述
5. 等待代码审查
6. 合并后删除分支

## 分支管理规范

- 主分支：`main`，始终保持可部署状态。
- 开发分支：`dev_*` 或 `feature/*`，用于新功能开发或大改动。
- 修复分支：`fix/*`，用于 Bug 修复。
- 分支命名建议：`feature/功能描述`、`fix/问题描述`。
- 所有功能/修复分支需通过 PR 合并，禁止直接推送到 `main`。
- 合并前需确保 CI 测试通过。
- 合并后及时删除临时分支。

### 发布与环境映射

1. 将 `feature/*` 或 `fix/*` 合并至 `main` 后，CI 会以 `main` 最新提交构建并部署到测试/准生产环境，供 QA 与回归验证。
2. 验证通过后，在 `main` 头部创建版本 Tag（如 `v1.1.0`），同步更新 `CHANGELOG.md` 与 `VERSION`。
3. 生产环境仅接受带 Tag 的构建，部署脚本以 Tag 触发，确保可追溯与快速回滚。
4. 如需要更长的回归周期，可按需临时创建 `release/*` 分支，验证完成后再合并回 `main` 并按上面步骤发布。

> 说明：若团队规模扩大或需要多环境长期并行，可参考 `docs/BRANCH-ENVIRONMENT-STRATEGY.md` 中的 GitFlow 扩展方案；默认情况下以此轻量主干流程为准。

## DevOps & CI/CD 规范

- 所有 PR 自动触发单元测试（Pytest）和 E2E 测试（Playwright）。
- 通过 GitHub Actions 实现自动化测试和构建。
- 生产部署需通过主分支触发，自动构建 Docker 镜像并推送到注册中心。
- 关键配置（如数据库密码、JWT 密钥）通过 GitHub Secrets 管理，禁止明文提交。

详细 CI/CD 流程与环境变量配置见 [部署指南](deploy/README.md) 和 [安全配置](docs/SECURITY-CONFIG.md)。

## 关键约定

### 必须遵守
- 不要破坏 "Self/自己" 成员的保护机制
- 分页参数使用 `page` 和 `size`
- CSV 导出保持 UTF-8 BOM
- Tag 过滤使用精确匹配 + OR 语义

### 验证规则
| 字段 | 规则 |
|-----|------|
| 血压 | 30-250 mmHg，收缩压 > 舒张压 |
| 心率 | 可选，30-150 bpm |
| 成员名 | 不可重复，"Self/自己" 保留 |
