/**
 * Health Chart Component using ECharts
 * Generated by Zhuang
 */
import React, { useEffect, useState, useCallback } from 'react';
import ReactEChartsCore from 'echarts-for-react/lib/core';
import * as echarts from 'echarts/core';
import { LineChart } from 'echarts/charts';
import {
  GridComponent,
  TooltipComponent,
  LegendComponent,
  DataZoomComponent,
} from 'echarts/components';
import { CanvasRenderer } from 'echarts/renderers';
import { Empty, Select, Space, Button } from 'antd';
import { DownloadOutlined } from '@ant-design/icons';
import dayjs from 'dayjs';
import { parseServerTime } from '../utils/date';
import {
  buildHealthChartSeries,
  SYSTOLIC_COLOR,
  DIASTOLIC_COLOR,
  HEART_RATE_COLOR,
} from '../utils/healthChart';
import { useTranslation } from 'react-i18next';

const { Option } = Select;


// Register ECharts components
echarts.use([
  LineChart,
  GridComponent,
  TooltipComponent,
  LegendComponent,
  DataZoomComponent,
  CanvasRenderer,
]);

const HealthChart = ({ records = [] }) => {
  const { t } = useTranslation();
  const [timeRange, setTimeRange] = useState('week'); // week, month, all
  const [filteredRecords, setFilteredRecords] = useState([]);

  const filterRecordsByTimeRange = useCallback(() => {
    if (!records.length) {
      setFilteredRecords([]);
      return;
    }

    let filtered = [...records];
    let threshold = null;

    if (timeRange === 'week') {
      threshold = dayjs().subtract(7, 'day');
    } else if (timeRange === 'month') {
      threshold = dayjs().subtract(30, 'day');
    }

    if (threshold) {
      filtered = records.filter(record => {
        const ts = parseServerTime(record.timestamp);
        return ts.isValid() && ts.isAfter(threshold);
      });
    }

    // Sort by timestamp
    filtered.sort((a, b) => {
      const tsA = parseServerTime(a.timestamp);
      const tsB = parseServerTime(b.timestamp);
      const aValue = tsA.isValid() ? tsA.valueOf() : 0;
      const bValue = tsB.isValid() ? tsB.valueOf() : 0;
      return aValue - bValue;
    });
    setFilteredRecords(filtered);
  }, [records, timeRange]);

  useEffect(() => {
    filterRecordsByTimeRange();
  }, [filterRecordsByTimeRange]);

  const downloadChart = () => {
    const chartInstance = document.querySelector('.health-chart canvas');
    if (chartInstance) {
      const link = document.createElement('a');
      link.download = `health-chart-${timeRange}-${dayjs().format('YYYY-MM-DD')}.png`;
      link.href = chartInstance.toDataURL();
      link.click();
    }
  };

  if (!filteredRecords.length) {
    return (
      <div>
        <Space style={{ marginBottom: 16 }}>
          <Select value={timeRange} onChange={setTimeRange} style={{ width: 120 }}>
      <Option value="week">{t('chart.range.week')}</Option>
      <Option value="month">{t('chart.range.month')}</Option>
      <Option value="all">{t('chart.range.all')}</Option>
          </Select>
        </Space>
    <Empty description={t('chart.noData')} />
      </div>
    );
  }

  // Prepare data for ECharts
  const {
    timeAxis,
    systolicData,
    diastolicData,
    heartRateData,
    yMin,
    yMax,
  } = buildHealthChartSeries(filteredRecords);

  const option = {
    title: {
  text: t('dashboard.chartTitle'),
      left: 'center',
    },
  tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross',
      },
      formatter: function (params) {
        let result = `${params[0].axisValue}<br/>`;
        params.forEach(param => {
          const pointValue = param?.data && typeof param.data === 'object' && !Array.isArray(param.data)
            ? param.data.value
            : param.value;
          if (pointValue !== null && pointValue !== undefined) {
      const unit = param.seriesName === t('chart.series.hr') ? ' bpm' : ' mmHg';
      result += `${param.seriesName}: ${pointValue}${unit}<br/>`;
          }
        });
        return result;
      },
    },
    legend: {
      data: [t('chart.series.systolic'), t('chart.series.diastolic'), t('chart.series.hr')],
      top: 30,
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '10%',
      top: '15%',
      containLabel: true,
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: timeAxis,
      axisLabel: {
        rotate: 45,
      },
    },
    yAxis: {
      type: 'value',
      name: t('chart.yaxis.shared'),
      axisLabel: {
        formatter: '{value}',
      },
      min: yMin,
      max: yMax,
    },
    series: [
      {
  name: t('chart.series.systolic'),
        type: 'line',
        data: systolicData,
        itemStyle: {
          color: SYSTOLIC_COLOR,
        },
        lineStyle: {
          color: SYSTOLIC_COLOR,
        },
        connectNulls: false,
        symbol: 'circle',
        symbolSize: 6,
        emphasis: {
          itemStyle: {
            borderColor: '#ff4d4f',
            borderWidth: 2,
          },
        },
      },
      {
  name: t('chart.series.diastolic'),
        type: 'line',
        data: diastolicData,
        itemStyle: {
          color: DIASTOLIC_COLOR,
        },
        lineStyle: {
          color: DIASTOLIC_COLOR,
        },
        connectNulls: false,
        symbol: 'circle',
        symbolSize: 6,
        emphasis: {
          itemStyle: {
            borderColor: '#52c41a',
            borderWidth: 2,
          },
        },
      },
      {
  name: t('chart.series.hr'),
        type: 'line',
        data: heartRateData,
        itemStyle: {
          color: HEART_RATE_COLOR,
        },
        lineStyle: {
          color: HEART_RATE_COLOR,
        },
        connectNulls: false,
        symbol: 'triangle',
        symbolSize: 6,
        emphasis: {
          itemStyle: {
            borderColor: '#1890ff',
            borderWidth: 2,
          },
        },
      },
    ],
    dataZoom: [
      {
        type: 'inside',
        start: 0,
        end: 100,
      },
      {
        start: 0,
        end: 100,
      },
    ],
  };

  return (
    <div>
      <Space style={{ marginBottom: 16, justifyContent: 'space-between', width: '100%' }}>
        <Select value={timeRange} onChange={setTimeRange} style={{ width: 120 }}>
          <Option value="week">{t('chart.range.week')}</Option>
          <Option value="month">{t('chart.range.month')}</Option>
          <Option value="all">{t('chart.range.all')}</Option>
        </Select>
        <Button 
          icon={<DownloadOutlined />} 
          onClick={downloadChart}
          type="default"
        >
          {t('chart.download')}
        </Button>
      </Space>
      
      <ReactEChartsCore
        echarts={echarts}
        option={option}
        style={{ height: '400px', width: '100%' }}
        className="health-chart"
      />
    </div>
  );
};

export default HealthChart;
