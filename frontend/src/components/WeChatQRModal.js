/**
 * WeChat QR Code Modal Component
 * Generated by Copilot
 */
import React, { useState, useEffect } from 'react';
import { Modal, Spin, Button, Typography, Space } from 'antd';
import { WechatOutlined, ReloadOutlined } from '@ant-design/icons';
import QRCode from 'qrcode';
import { useTranslation } from 'react-i18next';
import { wechatAPI } from '../services/api';

const { Text } = Typography;

const WeChatQRModal = ({ visible, onClose, onSuccess }) => {
  const { t } = useTranslation();
  const [loading, setLoading] = useState(true);
  const [qrCodeUrl, setQrCodeUrl] = useState('');
  const [wechatUrl, setWechatUrl] = useState('');
  const [error, setError] = useState(false);

  const loadQRCode = async () => {
    setLoading(true);
    setError(false);
    try {
      const response = await wechatAPI.getQRCode();
      const { qr_url } = response.data;
      
      setWechatUrl(qr_url);
      
      // Generate QR code image
      const qrDataUrl = await QRCode.toDataURL(qr_url, {
        width: 300,
        margin: 2,
      });
      
      setQrCodeUrl(qrDataUrl);
    } catch (err) {
      console.error('Failed to load QR code:', err);
      setError(true);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (visible) {
      loadQRCode();
    } else {
      // Reset state when modal closes
      setQrCodeUrl('');
      setWechatUrl('');
      setError(false);
    }
  }, [visible]);

  const handleRefresh = () => {
    loadQRCode();
  };

  return (
    <Modal
      title={
        <Space>
          <WechatOutlined style={{ color: '#07C160', fontSize: 24 }} />
          <span>{t('login.wechat.qrTitle')}</span>
        </Space>
      }
      open={visible}
      onCancel={onClose}
      footer={null}
      width={400}
      centered
    >
      <div style={{ textAlign: 'center', padding: '20px 0' }}>
        {loading ? (
          <div style={{ padding: '60px 0' }}>
            <Spin size="large" />
            <div style={{ marginTop: 16 }}>
              <Text type="secondary">{t('login.wechat.loading')}</Text>
            </div>
          </div>
        ) : error ? (
          <div style={{ padding: '40px 0' }}>
            <Text type="danger">{t('login.wechat.expired')}</Text>
            <div style={{ marginTop: 16 }}>
              <Button
                type="primary"
                icon={<ReloadOutlined />}
                onClick={handleRefresh}
              >
                {t('login.wechat.refresh')}
              </Button>
            </div>
          </div>
        ) : (
          <>
            <img
              src={qrCodeUrl}
              alt="WeChat QR Code"
              style={{
                width: 300,
                height: 300,
                border: '1px solid #d9d9d9',
                borderRadius: 4,
              }}
            />
            <div style={{ marginTop: 16 }}>
              <Text type="secondary">{t('login.wechat.qrSubtitle')}</Text>
            </div>
            <div style={{ marginTop: 12 }}>
              <Button
                icon={<ReloadOutlined />}
                onClick={handleRefresh}
              >
                {t('login.wechat.refresh')}
              </Button>
            </div>
          </>
        )}
      </div>
    </Modal>
  );
};

export default WeChatQRModal;
