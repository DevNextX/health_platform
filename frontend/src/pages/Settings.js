/**
 * Settings Page: language switcher
 * Generated by Zhuang
 * Generated by Copilot
 */
import React, { useCallback, useMemo, useState, useEffect } from 'react';
import { Card, Form, Select, Button, Typography, message, Space, Input, Row, Col, Divider, Progress } from 'antd';
import { useTranslation } from 'react-i18next';
import { authAPI } from '../services/api';
import { getUserIdFromToken, getMustChangeFromToken } from '../utils/auth';
import { useNavigate } from 'react-router-dom';
import { useLocation } from 'react-router-dom';
import FirstLoginGuide from '../components/FirstLoginGuide';

const { Title } = Typography;

const Settings = () => {
  const { i18n, t } = useTranslation();
  const [form] = Form.useForm();
  const [saving, setSaving] = useState(false);
  const location = useLocation();
  const mustChange = getMustChangeFromToken();
  const firstLogin = new URLSearchParams(location.search).get('first') === '1';

  const options = useMemo(() => ([
    { label: t('settings.language.zh'), value: 'zh' },
    { label: t('settings.language.en'), value: 'en' },
  ]), [t]);

  // Per-user language (default English)
  const uid = getUserIdFromToken();
  const userLangKey = uid ? `lang_user_${uid}` : 'app_language';
  const storedLang = (typeof localStorage !== 'undefined') ? localStorage.getItem(userLangKey) : null;
  const initialLang = storedLang || (i18n.language?.startsWith('en') ? 'en' : 'en');

  const onFinish = useCallback(async (values) => {
    try {
      setSaving(true);
      const lang = values.language || 'en';
      await i18n.changeLanguage(lang);
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem(userLangKey, lang);
      }
      message.success(t('settings.saved'));
    } finally {
      setSaving(false);
    }
  }, [i18n, t]);

  return (
    <div>
      <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Title level={2}>{t('settings.title')}</Title>
      </div>
      {(mustChange || firstLogin) && (
        <Card style={{ marginBottom: 16 }}>
          <FirstLoginGuide />
        </Card>
      )}
      <Card>
        <Form form={form} layout="vertical" onFinish={onFinish} initialValues={{ language: initialLang }}>
          <Form.Item name="language" label={t('settings.language')}>
            <Select options={options} style={{ maxWidth: 280 }} />
          </Form.Item>
          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit" loading={saving}>{t('settings.save')}</Button>
            </Space>
          </Form.Item>
        </Form>
      </Card>

      <Divider />

      <Card title={t('settings.changePassword') || '修改密码'}>
        <ChangePasswordInline />
      </Card>
    </div>
  );
};

export default Settings;

// Inline Change Password form (consistent with Settings layout)
const ChangePasswordInline = () => {
  const { t } = useTranslation();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [pwd, setPwd] = useState('');
  const navigate = useNavigate();

  const strength = (p) => {
    if (!p) return 0;
    let s = 0;
    if (p.length >= 8) s += 30;
    if (/[a-z]/.test(p)) s += 20;
    if (/[A-Z]/.test(p)) s += 20;
    if (/[0-9]/.test(p)) s += 20;
    if (/[^A-Za-z0-9]/.test(p)) s += 10;
    return Math.min(s, 100);
  };

  const onFinish = async (values) => {
    const { current_password, new_password, confirm_password } = values;
    if (new_password !== confirm_password) {
      message.error(t('settings.password.mismatch') || '两次输入的新密码不一致');
      return;
    }
    setLoading(true);
    try {
      await authAPI.changePassword({ current_password, new_password });
      message.success(t('settings.password.relogin') || t('settings.password.changed'));
      try { localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); } catch {}
      navigate('/login');
    } catch (e) {
      const msg = e.response?.data?.message || (t('settings.password.failed') || '修改密码失败');
      message.error(msg);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Row gutter={24}>
      <Col xs={24} md={14}>
        <Form form={form} layout="vertical" onFinish={onFinish}>
          <Form.Item label={t('settings.password.current') || '当前密码'} name="current_password" rules={[{ required: true, message: t('settings.password.currentReq') || '请输入当前密码' }]}>
            <Input.Password placeholder={t('settings.password.current') || '当前密码'} />
          </Form.Item>
          <Form.Item label={t('settings.password.new') || '新密码'} name="new_password" rules={[{ required: true, message: t('settings.password.newReq') || '请输入新密码（至少8位，包含字母和数字）' }]}>
            <Input.Password placeholder={t('settings.password.new') || '新密码'} onChange={(e) => setPwd(e.target.value)} />
          </Form.Item>
          <Form.Item label={t('settings.password.confirm') || '确认新密码'} name="confirm_password" rules={[{ required: true, message: t('settings.password.confirmReq') || '请再次输入新密码' }]}>
            <Input.Password placeholder={t('settings.password.confirm') || '确认新密码'} />
          </Form.Item>
          <Form.Item>
            <Button type="primary" htmlType="submit" loading={loading}>{t('settings.password.submit') || '提交'}</Button>
          </Form.Item>
        </Form>
      </Col>
      <Col xs={24} md={10}>
        <div style={{ paddingTop: 8 }}>
          <Typography.Text type="secondary">{t('settings.password.strength') || '密码强度'}</Typography.Text>
          <Progress percent={strength(pwd)} showInfo={false} status="active" style={{ marginTop: 6 }} />
          <div style={{ marginTop: 8 }}>
            <ul style={{ paddingLeft: 18, margin: 0 }}>
              <li>{t('settings.password.ruleLen') || '至少 8 位'}</li>
              <li>{t('settings.password.ruleMix') || '包含字母与数字'}</li>
              <li>{t('settings.password.ruleAdv') || '建议包含大写/小写/符号提升强度'}</li>
            </ul>
          </div>
        </div>
      </Col>
    </Row>
  );
};
