# GitHub Actions Workflows Examples
# Generated by Zhuang

This directory contains example GitHub Actions workflows for implementing different CI/CD strategies for the Health Platform project.

## Workflow Overview

### Current Implementation
- **Single Workflow**: Uses `ci.yml` for all environments
- **Branch-based deployment**: Automatic deployment based on branch names
- **Manual override**: Workflow dispatch for manual deployments

### Recommended Multi-Workflow Strategy

The examples in this directory demonstrate a more robust approach with separate workflows for different concerns:

## Workflow Files

### 1. `build.yml` - Build and Test Workflow
**Purpose**: Builds and tests code on all branches
**Triggers**: 
- Push to any branch
- Pull requests to main/staging/develop

**Features**:
- Runs unit tests for backend and frontend
- Builds Docker images and pushes to registry
- Caches build artifacts
- Runs on all branches for continuous validation

### 2. `pr-validation.yml` - Pull Request Validation
**Purpose**: Comprehensive validation for pull requests
**Triggers**: 
- Pull request creation/updates

**Features**:
- Configuration file validation
- Docker file syntax checking
- Security scanning for secrets
- Frontend and backend testing
- Integration tests (optional)
- Automated PR comments with results

### 3. `deploy-dev.yml` - Development Deployment
**Purpose**: Auto-deploy to development environment
**Triggers**: 
- Push to `develop` branch
- Manual workflow dispatch

**Features**:
- Automatic deployment to dev cluster
- Health checks and service validation
- LoadBalancer IP detection
- Fast deployment for rapid iteration

### 4. `deploy-staging.yml` - Staging Deployment  
**Purpose**: Deploy to staging for pre-production testing
**Triggers**: 
- Push to `staging` branch
- Manual workflow dispatch

**Features**:
- Pre-deployment validation
- Comprehensive health checks
- Integration test execution
- Service endpoint validation
- Production readiness verification

### 5. `deploy-prod.yml` - Production Deployment
**Purpose**: Secure production deployment with approval gates
**Triggers**: 
- Push to `main` branch
- Manual workflow dispatch

**Features**:
- **Manual approval requirement** (configured via GitHub Environment)
- Pre-deployment validation
- Deployment backup creation
- Comprehensive health validation
- Automatic rollback on failure
- Post-deployment verification

## Implementation Strategy

### Phase 1: Evaluation (Current)
Use the existing single workflow (`ci.yml`) while evaluating team needs.

### Phase 2: Migration Plan

#### Step 1: Create Branch Structure
```bash
# Create required branches
git checkout main
git checkout -b staging
git push origin staging

git checkout -b develop  
git push origin develop
```

#### Step 2: Configure GitHub Environments
1. Go to repository Settings â†’ Environments
2. Create three environments:
   - `development` (no restrictions)
   - `staging` (optional: required reviewers)
   - `production` (required reviewers, delay timer)

#### Step 3: Set Up Environment Secrets
For each environment, configure:
```
DEV_KUBE_CONFIG - Development cluster kubeconfig
DEV_KUBE_CONTEXT - Development cluster context

STAGING_KUBE_CONFIG - Staging cluster kubeconfig
STAGING_KUBE_CONTEXT - Staging cluster context

PROD_KUBE_CONFIG - Production cluster kubeconfig  
PROD_KUBE_CONTEXT - Production cluster context
```

#### Step 4: Replace Workflows
1. Backup current `ci.yml`
2. Copy desired workflows from this examples directory to `.github/workflows/`
3. Remove or rename the old `ci.yml`
4. Commit and push changes

### Example Migration Script

```bash
# Backup current workflow
cp .github/workflows/ci.yml .github/workflows/ci.yml.backup

# Copy new workflows (adjust as needed)
cp .github/workflows-examples/build.yml .github/workflows/
cp .github/workflows-examples/pr-validation.yml .github/workflows/
cp .github/workflows-examples/deploy-dev.yml .github/workflows/
cp .github/workflows-examples/deploy-staging.yml .github/workflows/
cp .github/workflows-examples/deploy-prod.yml .github/workflows/

# Commit the changes
git add .github/workflows/
git commit -m "Implement multi-workflow CI/CD strategy

- Add separate workflows for each environment
- Add PR validation workflow
- Implement approval gates for production
- Add comprehensive health checks and rollback
Generated by Zhuang"
```

## Workflow Customization

### Environment URLs
Update the `environment.url` values in each deployment workflow:
```yaml
environment:
  name: production
  url: https://your-production-domain.com  # Update this
```

### Notification Integration
Add Slack/Teams notifications in the success/failure steps:
```yaml
- name: Notify Slack
  if: success()
  uses: 8398a7/action-slack@v3
  with:
    status: success
    channel: '#deployments'
    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### Additional Security
Consider adding:
- Container image scanning
- Dependency vulnerability checks
- SAST (Static Application Security Testing)
- DAST (Dynamic Application Security Testing)

## Testing the Workflows

### 1. Test Development Flow
```bash
git checkout develop
echo "test change" > test.txt
git add . && git commit -m "test dev deployment"
git push origin develop
# Should trigger deploy-dev.yml
```

### 2. Test Staging Flow
```bash
git checkout staging
git merge develop
git push origin staging
# Should trigger deploy-staging.yml
```

### 3. Test Production Flow
```bash
git checkout main
git merge staging
git push origin main
# Should trigger deploy-prod.yml with approval gate
```

## Monitoring and Maintenance

### Workflow Monitoring
- Monitor workflow execution times
- Set up alerts for deployment failures
- Review and update approval settings regularly

### Security Maintenance
- Rotate Kubernetes credentials regularly
- Review and update secret scopes
- Audit workflow permissions quarterly

### Performance Optimization
- Optimize Docker build caches
- Review and clean up old workflow runs
- Monitor resource usage in runners

## Troubleshooting

### Common Issues
1. **Secrets not accessible**: Check environment configuration and secret names
2. **Kubernetes connection failures**: Verify kubeconfig and context names
3. **Approval not working**: Check GitHub Environment protection rules
4. **Health checks failing**: Verify service endpoints and timeouts

### Debug Steps
1. Check workflow logs in GitHub Actions
2. Verify secret values (without exposing them)
3. Test kubectl commands manually
4. Validate configuration files

## Support and Contribution

For questions or improvements:
1. Create GitHub issue for bugs
2. Submit PR for enhancements  
3. Update documentation when making changes
4. Follow the security guidelines in `GITHUB-SECRETS.md`

Remember to always test changes in development environment first!
