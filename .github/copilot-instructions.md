## Health Platform – Copilot Instructions

These notes make AI agents productive in this repo quickly. Keep edits minimal, preserve public APIs, and match existing patterns. 

### Big picture
- Monolith with clear layers:
  - Backend (Flask, `src/`): Blueprints under `src/service/*` call managers in `src/manager/*` which touch models in `src/models.py`. JWT auth, CORS, rate limiting.
  - Frontend (React 18, Ant Design 5, `frontend/`): Pages under `src/pages`, shared components in `src/components`, Axios API in `src/services/api.js` with token refresh.
  - Tests: Pytest unit tests under `tests/`; Playwright E2E under `tests/e2e/`.

### Patterns you must follow
- Service/Manager layering: Services own HTTP concerns and validation; Managers perform DB queries/updates. Don’t query DB in services directly.
- Members: there is a special default member “Self/自己”. Never allow editing/deleting Self via members API; UI disables those actions. Backend recognizes both names.
- “Self overlay”: `member_service.list_members` overlays Self’s gender/age/weight from the User profile without DB schema changes. Height lives on the Self member.
- Tag filtering semantics: exact match inside a JSON array with OR across multiple tags. Tags are stored with `ensure_ascii=False` and must match Unicode/raw encodings. Keep this in queries.
- Pagination: backend expects `page` and `size` (not `per_page`). Frontend already uses `size` in Dashboard/HealthRecords.
- CSV export: UTF‑8 BOM, includes `member_name` column, and sets RFC5987 `filename*` plus ASCII `filename`. CORS must expose `Content-Disposition`.

### Key files to read first
- Backend: `src/service/health_service.py`, `src/manager/health_manager.py`, `src/service/member_service.py`, `src/manager/member_manager.py`, `src/service/user_service.py`, `src/security.py`.
- Frontend: `frontend/src/pages/HealthRecords.js`, `frontend/src/components/TagSelector.js` (mode="tags" + responsive chips), `frontend/src/components/Layout.js`, `frontend/src/services/api.js`.
- Tests: `tests/test_health.py` (tag OR semantics, pagination), E2E specs in `tests/e2e/tests/`.

### Language & style
- 与人类协作“聊天”统一使用中文；代码与注释统一使用英文。提交中保留标注：`Generated by Copilot`。

### Developer workflows (shell‑agnostic)
- Backend venv + run (activate per shell):
  - Create venv (all shells): `python -m venv .venv`
  - Activate:
    - PowerShell: `./.venv/Scripts/Activate.ps1`
    - cmd: `\.venv\Scripts\activate.bat`
    - Bash: `source .venv/bin/activate`
  - Install deps: `pip install -r requirements.txt`
  - Env vars + run Flask:
    - PowerShell: `$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask run --host=0.0.0.0 --port=5000`
    - cmd: `set PYTHONPATH=.` then `set FLASK_APP=src.app` then `python -m flask run --host=0.0.0.0 --port=5000`
    - Bash: `export PYTHONPATH=.` then `export FLASK_APP=src.app` then `python -m flask run --host=0.0.0.0 --port=5000`
- Unit tests (any shell): `python -m pytest -q` (或使用 `./.venv/Scripts/python.exe -m pytest -q` 指定解释器)
- Frontend dev (any shell): `cd frontend` → `npm install` → `npm start`
- E2E (backend+frontend running): `cd tests/e2e` → `npm install` → `npx playwright install --with-deps` → `npm run test`
Note: PowerShell 中避免使用 `&&`，请用分号或换行；Bash/cmd 可使用 `&&` 连接。

### Frontend conventions
- Auth: Axios interceptors attach `Authorization: Bearer <access>`. Refresh uses the refresh token as Bearer when calling `/api/v1/auth/refresh` & logout.
- Layout header shows current user (username + email) and global member selector. HealthRecords uses inline filters with labeled “日期/标签”; TagSelector allows typing new tags; active filters render as closable chips.
- CSV download parses `Content-Disposition` and honors `filename*`.

### Backend conventions
- Keep route behavior stable for tests: tag filters are exact-match OR; list endpoints return `{records, pagination}`; CSV respects filters and Self backfill; 204 OPTIONS for export.
- When updating profile, sync `height` to Self member. Self backfill maps legacy `HealthRecord` rows to Self when listing/exporting.

### When adding features
- Extend managers for query logic, then services. Update or add pytest cases mirroring `tests/test_health.py` style. If behavior touches UI flows, add/adjust Playwright specs.
- Respect CORS and headers already configured; if adding downloads, expose needed headers.

### Gotchas
- Don’t break “Self/自己” protections. Don’t switch pagination param names. Don’t re-escape tag JSON. Ensure CSV keeps BOM.
