## Health Platform – Copilot Instructions

### Project Overvie### Language & style
- 与人类协作"聊天"统一使用中文；代码与注释统一使用英文。提交中保留标注：`Generated by Copilot`。 Platform**: A comprehensive health monitoring system for tracking vital health metrics for multiple family members.
- **Key Features**:
  - Multi-user support with family member management
  - Health record tracking (blood pressure, heart rate, weight, etc.)
  - Customizable tagging system for health records
  - Data filtering, analytics and CSV export
  - User profile management with authentication
  - Internationalization (English/中文) throughout the application
  - Responsive design supporting multiple device formats
- **Deployment**: Supports Docker containerization, Kubernetes, and Azure Container Apps
- **Audience**: Individuals and families tracking health metrics over time

### Technical Stack & Requirements
- **Backend**:
  - Python (compatible with Flask 3.0.3)
  - Flask 3.0.3 framework
  - SQLAlchemy ORM (Flask-SQLAlchemy 3.1.1)
  - JWT authentication (flask-jwt-extended 4.6.0, PyJWT 2.9.0)
  - SQLite for development (PostgreSQL/MySQL compatible for production)
  - CORS (Flask-Cors 4.0.1) and rate-limiting (Flask-Limiter 3.7.0)
  - Werkzeug 3.0.3
- **Frontend**:
  - React 18.2.0
  - Ant Design 5.8.6 UI framework
  - react-router-dom 6.15.0 
  - i18next 22.5.1 / react-i18next 12.3.1 for translations
  - Axios 1.5.0 for API interactions
  - dayjs 1.11.9 for date handling
  - echarts 5.4.3 for data visualization
- **Testing**:
  - Pytest 8.2.2 for backend unit/integration tests
  - Playwright for E2E testing (headless browser)

### System Architecture
- **Application Structure**: Monolith with clear layers:
  - Backend (Flask, `src/`): Blueprints under `src/service/*` call managers in `src/manager/*` which touch models in `src/models.py`. JWT auth, CORS, rate limiting.
  - Frontend (React 18, Ant Design 5, `frontend/`): Pages under `src/pages`, shared components in `src/components`, Axios API in `src/services/api.js` with token refresh.
  - Tests: Pytest unit tests under `tests/`; Playwright E2E under `tests/e2e/`.
- **Data flow**: Client → API Gateway → Service Layer → Manager Layer → Database
- **Authentication flow**: Login → JWT token → Refresh token rotation → Protected routes
- **Key components**:
  - User authentication & registration system
  - Member management (family members + Self)
  - Health record CRUD operations with validation
  - Data export and filtering system
  - Internationalization middleware
  - Unit and E2E test suites

### Patterns you must follow
- Service/Manager layering: Services own HTTP concerns and validation; Managers perform DB queries/updates. Don’t query DB in services directly.
- Members: there is a special default member “Self/自己”. Never allow editing/deleting Self via members API; UI disables those actions. Backend recognizes both names.
- “Self overlay”: `member_service.list_members` overlays Self’s gender/age/weight from the User profile without DB schema changes. Height lives on the Self member.
- Tag filtering semantics: exact match inside a JSON array with OR across multiple tags. Tags are stored with `ensure_ascii=False` and must match Unicode/raw encodings. Keep this in queries.
- Pagination: backend expects `page` and `size` (not `per_page`). Frontend already uses `size` in Dashboard/HealthRecords.
- CSV export: UTF‑8 BOM, includes `member_name` column, and sets RFC5987 `filename*` plus ASCII `filename`. CORS must expose `Content-Disposition`.

### Key files to read first
- Backend: `src/service/health_service.py`, `src/manager/health_manager.py`, `src/service/member_service.py`, `src/manager/member_manager.py`, `src/service/user_service.py`, `src/security.py`.
- Frontend: `frontend/src/pages/HealthRecords.js`, `frontend/src/components/TagSelector.js` (mode="tags" + responsive chips), `frontend/src/components/Layout.js`, `frontend/src/services/api.js`.
- Tests: `tests/test_health.py` (tag OR semantics, pagination), E2E specs in `tests/e2e/tests/`.

### Language & style
- 与人类协作“聊天”统一使用中文；代码与注释统一使用英文。提交中保留标注：`Generated by Copilot`。

### System Architecture
- **Data flow**: Client → API Gateway → Service Layer → Manager Layer → Database
- **Authentication flow**: Login → JWT token → Refresh token rotation → Protected routes
- **Key components**:
  - User authentication & registration system
  - Member management (family members + Self)
  - Health record CRUD operations with validation
  - Data export and filtering system
  - Internationalization middleware
  - Unit and E2E test suites

### Validation Rules
- **Blood pressure**: Systolic & diastolic 30-250 mmHg; systolic must be greater than diastolic
- **Heart rate**: Optional field, when present must be 30-150 bpm
- **Weight**: Positive number, reasonable human range
- **Member names**: Cannot duplicate existing names; "Self/自己" is reserved

### Gotchas
- Don't break "Self/自己" protections. Don't switch pagination param names. Don't re-escape tag JSON. Ensure CSV keeps BOM.
- Use `datetime.now(datetime.UTC)` rather than deprecated `datetime.utcnow()` for new code.
- Empty strings for optional numeric fields should be treated as None/null.
- Keep edits minimal, preserve public APIs, and match existing patterns.

### Developer workflows (shell‑agnostic)
- Backend venv + run (activate per shell):
  - Create venv (all shells): `python -m venv .venv`
  - Activate:
    - PowerShell: `./.venv/Scripts/Activate.ps1`
    - cmd: `\.venv\Scripts\activate.bat`
    - Bash: `source .venv/bin/activate`
  - Install deps: `pip install -r requirements.txt`
  - Env vars + run Flask:
    - PowerShell: `$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask run --host=0.0.0.0 --port=5000`
    - cmd: `set PYTHONPATH=.` then `set FLASK_APP=src.app` then `python -m flask run --host=0.0.0.0 --port=5000`
    - Bash: `export PYTHONPATH=.` then `export FLASK_APP=src.app` then `python -m flask run --host=0.0.0.0 --port=5000`
- Unit tests (any shell): `python -m pytest -q` (或使用 `./.venv/Scripts/python.exe -m pytest -q` 指定解释器)
- Frontend dev (any shell): `cd frontend` → `npm install` → `npm start`
- E2E (backend+frontend running): `cd tests/e2e` → `npm install` → `npx playwright install --with-deps` → `npm run test`
Note: PowerShell 中避免使用 `&&`，请用分号或换行；Bash/cmd 可使用 `&&` 连接。

### Frontend conventions
- Auth: Axios interceptors attach `Authorization: Bearer <access>`. Refresh uses the refresh token as Bearer when calling `/api/v1/auth/refresh` & logout.
- Layout header shows current user (username + email) and global member selector. HealthRecords uses inline filters with labeled “日期/标签”; TagSelector allows typing new tags; active filters render as closable chips.
- CSV download parses `Content-Disposition` and honors `filename*`.

### Backend conventions
- Keep route behavior stable for tests: tag filters are exact-match OR; list endpoints return `{records, pagination}`; CSV respects filters and Self backfill; 204 OPTIONS for export.
- When updating profile, sync `height` to Self member. Self backfill maps legacy `HealthRecord` rows to Self when listing/exporting.

### When adding features
- Extend managers for query logic, then services. Update or add pytest cases mirroring `tests/test_health.py` style. If behavior touches UI flows, add/adjust Playwright specs.
- Respect CORS and headers already configured; if adding downloads, expose needed headers.


