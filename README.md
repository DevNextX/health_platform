# 健康记录平台

## Generated by Zhuang

一个完整的个人健康数据记录与管理平台，提供血压、心率等健康指标的记录、分析和可视化功能。

## 📋 重要文档

- 🔐 **[安全配置管理指南](docs/SECURITY-CONFIG.md)** - 配置分层策略与安全最佳实践
- 🔧 **[GitHub 环境配置指南](docs/GITHUB-ENVIRONMENT-SETUP.md)** - GitHub Environments 设置教程
- 🚀 **[部署文档](deploy/README.md)** - K8s 部署指南
- 📝 **[变更日志](CHANGELOG.md)** - 版本变更记录
 - 🔑 **[管理员重置密码流程](docs/ADMIN-PASSWORD-RESET.md)** · **[EN](docs/ADMIN-PASSWORD-RESET.en.md)**

## 🔒 安全配置

本项目采用三层安全配置管理：
1. **GitHub Secrets** - 敏感信息（数据库密码、JWT密钥）
2. **GitHub Variables** - 环境特定配置（CORS域名、副本数）
3. **Repository Files** - 公共配置（资源限制、命名空间）

### 🔒 CORS 智能默认生成
- 如果未设置 `CORS_ORIGINS`，系统自动基于 `NAMESPACE` 生成安全默认值
- 默认值：`http://localhost:3000,http://127.0.0.1:3000,http://frontend-svc.{NAMESPACE}.svc.cluster.local:80`
- 确保默认只允许前端服务和本地开发访问，提高安全性

详见 [SECURITY-CONFIG.md](docs/SECURITY-CONFIG.md)

## 🚀 已完成功能

```cmd
:: 运行API测试（推荐使用虚拟环境的 Python 执行器）
:: 方式A：先激活 .venv（简洁）
python -m venv .venv
.\.venv\Scripts\activate.bat
python -m pytest tests/ -v

:: 方式B：不激活 .venv，直接用虚拟环境解释器（最稳妥，避免" No module named pytest "）
cd c:\Zhuang\Source\health_platform
.\.venv\Scripts\python.exe -m pytest tests/ -q



:: Kubernetes 部署验证测试
kubectl get pods -n health-platform
kubectl logs deployment/frontend -n health-platform
kubectl logs deployment/backend -n health-platform(Flask)
- 用户注册/登录/登出 (JWT认证)
- 健康记录CRUD操作
- 数据分页与筛选
- API限流保护
- 自动化测试 (31/31通过)

### ✅ 前端界面 (React)
- 登录/注册（邮箱唯一、表单校验）
- 健康记录列表（分页、标签/日期筛选）、新增/编辑/删除
- 仪表盘统计（总数/本周/平均收缩压/平均舒张压/平均心率）
- 趋势折线图（最近一周/一月/全部），图表下载 PNG
- 响应式设计
- 简化版家庭成员：成员档案管理（不能登录），按成员录入与筛选（subject_member_id）

## 🚀 快速开始

**重要提示**: 后端和前端服务是独立的进程，需要分别在 **两个独立的终端窗口** 中启动。启动服务后，这两个终端窗口将持续运行并输出日志，请不要关闭它们或在其中执行其他命令，以免中断服务。后续的命令行操作（如运行测试）需要 **新开一个终端窗口**。

### 1. 启动后端服务（在第一个终端窗口中）

```cmd
:: 创建虚拟环境
python -m venv .venv
.\.venv\Scripts\activate.bat

:: 安装依赖
pip install -r requirements.txt

:: 启动服务
set PYTHONPATH=.
set FLASK_APP=src.app
python -m flask run --host=0.0.0.0 --port=5000
```

故障排查：如果遇到 ModuleNotFoundError（例如 No module named 'flask_jwt_extended'），请确认已在当前虚拟环境中安装依赖，并使用该环境启动 Flask：

```cmd
python -m venv .venv
.\.venv\Scripts\activate.bat
pip install -r requirements.txt
set PYTHONPATH=.
set FLASK_APP=src.app
python -m flask run --host=0.0.0.0 --port=5000
```

### 2. 启动前端（在第二个终端窗口中）

```cmd
cd frontend
npm install
npm start
```

说明：
- `npm start` 会启动开发服务器（**热更新**：代码修改后自动重新编译并刷新浏览器）。
- `npm run build` 只会生成生产构建到 build/，不会启动服务器；如需本地预览生产构建：

```cmd
cd frontend
npm run build
npm install -g serve
serve -s build -l 3000
```

注意：`serve` 命令需要在 `frontend` 目录下执行，因为 `build` 文件夹位于该目录中。

本地用 `serve` 预览生产构建时不会自动代理 `/api` 到后端（与开发模式不同），需要在构建前指定后端地址，否则前端会把 `/api` 请求发到 3000 端口并得到 HTML（index.html）：

```cmd
:: 在 frontend 目录中，构建时注入后端地址
cd frontend
set REACT_APP_API_URL=http://127.0.0.1:5000
npm run build
serve -s build -l 3000
```

排查提示：若登录请求返回的是一段 HTML（doctype 开头），且 localStorage 中 `access_token`/`refresh_token` 显示为 'undefined'，基本就是上述原因。解决方法是用 `REACT_APP_API_URL` 重新构建，或改用开发模式 `npm start`（CRA dev server 会把 `/api` 代理到 `http://localhost:5000`）。

> 提示: 如果看到“Attempting to bind to HOST environment variable: localhost”警告，说明在全局环境里设置了 HOST。项目已移除本地 .env 中的 HOST 配置；如仍提示，请重启终端或在“系统属性 → 环境变量”中删除用户级 HOST 后再启动。Generated by Zhuang

## 📊 功能验收状态

根据需求文档 `docs/Req/Requirements_MVP.md`：

| 功能模块 | 状态 | 验收标准 |
|---------|------|----------|
| 用户管理 | ✅ 完成 | 注册/登录/邮箱唯一性校验 |
| 健康数据录入 | ✅ 完成 | 血压范围校验/标签系统/时间戳 |
| 数据可视化 | ✅ 完成 | 折线图/时间范围/图表下载 |
| 分享与导出 | ✅ 完成 | 图片下载功能 |
| 响应式设计 | ✅ 完成 | 手机和电脑适配 |

## 🧪 测试验证

```cmd
:: 运行API测试（推荐使用虚拟环境的 Python 执行器）
:: 方式A：先激活 .venv（简洁）
python -m venv .venv
.\.venv\Scripts\activate.bat
python -m pytest tests/ -v

:: 方式B：不激活 .venv，直接用虚拟环境解释器（最稳妥，避免“ No module named pytest ”）
cd c:\Zhuang\Source\health_platform
.\.venv\Scripts\python.exe -m pytest tests/ -q

:: 结果: 31/31 测试通过 ✅

:: 运行端到端(E2E)测试
:: 1) 先启动后端 http://localhost:5000
:: 2) 安装并使用 Playwright 测试运行器（版本需一致）
cd tests\e2e
npm install
npx playwright install --with-deps
npm run test

:: 可覆盖前端基地址（默认 http://localhost:3000）
set E2E_BASE_URL=http://localhost:3001 && npm run test

注意：请使用 `npm run test` 或 `npx playwright test` 执行测试，不要使用 `npx run test`（那是另一个社区包，会尝试执行一个名为 test 的本地脚本文件，导致 Cannot find module '...\\test' 错误）。
```

### 🧰 后端单元测试使用说明（pytest）

- 两条命令的区别：
	- 解释器来源：`python -m pytest ...` 取决于当前 PATH 指向的 Python；`.\.venv\Scripts\python.exe -m pytest ...` 强制使用本项目虚拟环境，避免全局环境未安装 pytest 时的 ImportError。
	- 输出详略：`-v` 详细显示每个用例；`-q` 安静模式仅显示必要信息。
	- 工作目录：请确保在项目根目录执行（包含 `tests/`），或显式传入测试路径（如 `tests/`）。

- 常用命令（cmd）：

```cmd
:: 全量运行，详细输出
.\.venv\Scripts\python.exe -m pytest tests/ -v

:: 单个用例
.\.venv\Scripts\python.exe -m pytest tests/test_auth.py::TestAuthEndpoints::test_health_check -q

:: 关键字过滤
.\.venv\Scripts\python.exe -m pytest -k "login and not refresh" -v

:: 首个失败即停
.\.venv\Scripts\python.exe -m pytest tests/ -x -v
```

若出现导入错误（如找不到 `pytest` 或 `flask_jwt_extended`），优先确认是否使用了 `.venv` 解释器；必要时重新安装依赖：

```cmd
python -m venv .venv
.\.venv\Scripts\activate.bat
pip install -r requirements.txt
```

> Generated by Zhuang

## 📁 项目结构

```
health_platform/
├── src/                    # 后端API
├── frontend/              # React前端
├── static_demo/           # 静态演示页面
├── tests/                 # 自动化测试
├── docs/                  # 需求与设计文档
└── README.md             # 本文件
```

## 🎯 下一步扩展

- 家庭成员管理
- CSV数据导出  
- 微信小程序
- Azure容器化部署

## ⬆️ 升级指南（Schema 变更与版本）

当后端引入数据库结构变更（如本次增加 `users.role`、`users.must_change_password`、`users.last_login_at`）时，请按以下步骤安全升级：

- 开发/测试环境（便捷）
  - 后端启动时会做“最佳努力”的列补齐：若检测到 `users` 表缺少上述列，会自动执行 `ALTER TABLE` 添加，避免 500 错误。
  - 这种方式适用于本地或临时环境，不建议用于生产的长期演进。

- 生产环境（推荐）
  - 使用 Alembic/Flask-Migrate 进行标准迁移：
    - 安装依赖：`pip install -r requirements.txt`
    - 设置环境：`export FLASK_APP=src.app`
    - 执行迁移：`flask db upgrade`
    - 如需离线生成 SQL，可用 Alembic offline 模式或将 `flask db upgrade` 运行在准备好的环境。
  - 回滚：`flask db downgrade <revision>`（仅在必要时使用）。

- 版本号与变更日志
  - 后端版本来自 `APP_VERSION`（见 `.env.example`），也可直接修改 `src/config.py` 的 `VERSION` 默认值。
  - 版本接口：`GET /api/v1/version`。
  - 变更记录：见 `CHANGELOG.md`。

注意：生产环境应优先使用迁移脚本来管理结构变更，以便审计与回滚；自动列补齐仅作为防守性补救，避免升级遗漏导致运行时 500。

## 🛠️ 容器化部署经验总结

### Kubernetes 权限问题处理
在容器化部署过程中遇到了 Frontend Pod `CrashLoopBackOff` 问题，根本原因是 Nginx 权限配置与 K8s 安全上下文冲突。

**问题现象**：
```bash
nginx: [emerg] mkdir() "/var/cache/nginx/client_temp" failed (13: Permission denied)
```

**解决方案**：
1. **临时修复**：调整 K8s 安全上下文允许 root 用户
2. **长期方案**：重新构建支持非 root 用户的 Nginx 镜像

**关键经验**：
- 优先查看 Pod 日志：`kubectl logs <pod> --previous`
- 权限问题应在镜像构建阶段解决，而非运行时配置
- 容器安全策略必须与应用需求匹配

详细记录见：[GitHub Issue #24](https://github.com/DevNextX/health_platform/issues/24)

---

**Generated by Zhuang** - 健康记录平台 MVP v1.0

---

## 🗄️ 数据库初始化（MySQL/外部数据库）

为避免首次连接到“空库”时出现 500 错误，应用对“自动建表”的策略如下（自 v1.0 修订）：

- SQLite（本地开发）：启动时总是自动建表（db.create_all）。
- MySQL/其它外部数据库：
	- 默认：在“检测到关键表缺失”时自动建表（users/members/health_records/households/record_subjects）。
	- 强制建表：设置 `DB_AUTO_CREATE=1` 将始终建表。
	- 关闭自动建：设置 `DB_CREATE_ON_MISSING=0`，即便缺表也不自动建（适合生产）。

标准化初始化与验证（cmd）：

```cmd
.\.venv\Scripts\activate.bat
set PYTHONPATH=.
set FLASK_APP=src.app
python -m flask db-info   :: 查看方言/字符集/现有表
python -m flask db-create :: 创建/补齐所有表（幂等）
python -m flask db-info   :: 再次确认
```
