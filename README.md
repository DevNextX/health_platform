# 健康记录平台

## Generated by Zhuang

一个完整的个人健康数据记录与管理平台，提供血压、心率等健康指标的记录、分析和可视化功能。

## 🚀 已完成功能

### ✅ 后端API (Flask)
- 用户注册/登录/登出 (JWT认证)
- 健康记录CRUD操作
- 数据分页与筛选
- API限流保护
- 自动化测试 (31/31通过)

### ✅ 前端界面 (React)
- 登录/注册（邮箱唯一、表单校验）
- 健康记录列表（分页、标签/日期筛选）、新增/编辑/删除
- 仪表盘统计（总数/本周/平均收缩压/平均舒张压/平均心率）
- 趋势折线图（最近一周/一月/全部），图表下载 PNG
- 响应式设计
- 简化版家庭成员：成员档案管理（不能登录），按成员录入与筛选（subject_member_id）

## 🚀 快速开始

### 1. 启动后端服务

```powershell
# 创建虚拟环境
python -m venv .venv
.\.venv\Scripts\Activate.ps1

# 安装依赖
pip install -r requirements.txt

# 启动服务
$env:PYTHONPATH="."
$env:FLASK_APP="src.app"
python -m flask run --host=0.0.0.0 --port=5000
```

故障排查：如果遇到 ModuleNotFoundError（例如 No module named 'flask_jwt_extended'），请确认已在当前虚拟环境中安装依赖，并使用该环境启动 Flask：

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask run --host=0.0.0.0 --port=5000
```

### 2. 启动前端（开发模式）

```powershell
cd frontend
npm install
npm start
```

说明：
- npm start 会启动开发服务器（热更新）。
- npm run build 只会生成生产构建到 build/，不会启动服务器；如需本地预览生产构建：

```powershell
cd frontend
npm run build
npm install -g serve
serve -s build -l 3000
```

> 提示: 如果看到“Attempting to bind to HOST environment variable: localhost”警告，说明在全局环境里设置了 HOST。项目已移除本地 .env 中的 HOST 配置；如仍提示，请重启终端或在“系统属性 → 环境变量”中删除用户级 HOST 后再启动。Generated by Zhuang

## 📊 功能验收状态

根据需求文档 `docs/Req/Requirements_MVP.md`：

| 功能模块 | 状态 | 验收标准 |
|---------|------|----------|
| 用户管理 | ✅ 完成 | 注册/登录/邮箱唯一性校验 |
| 健康数据录入 | ✅ 完成 | 血压范围校验/标签系统/时间戳 |
| 数据可视化 | ✅ 完成 | 折线图/时间范围/图表下载 |
| 分享与导出 | ✅ 完成 | 图片下载功能 |
| 响应式设计 | ✅ 完成 | 手机和电脑适配 |

## 🧪 测试验证

```powershell
# 运行API测试（推荐使用虚拟环境的 Python 执行器）
# 方式A：先激活 .venv（简洁）
python -m venv .venv
\.venv\Scripts\Activate.ps1
python -m pytest tests/ -v

# 方式B：不激活 .venv，直接用虚拟环境解释器（最稳妥，避免“ No module named pytest ”）
Set-Location -Path 'c:\Zhuang\Source\health_platform'; .\.venv\Scripts\python.exe -m pytest tests/ -q

# 结果: 31/31 测试通过 ✅

# 运行端到端(E2E)测试
# 1) 先启动后端 http://localhost:5000
# 2) 安装并使用 Playwright 测试运行器（版本需一致）
cd tests/e2e
npm install
npx playwright install --with-deps
npm run test

# 可覆盖前端基地址（默认 http://localhost:3000）
set E2E_BASE_URL=http://localhost:3001; npm run test

注意：请使用 `npm run test` 或 `npx playwright test` 执行测试，不要使用 `npx run test`（那是另一个社区包，会尝试执行一个名为 test 的本地脚本文件，导致 Cannot find module '...\\test' 错误）。
```

### 🧰 后端单元测试使用说明（pytest）

- 两条命令的区别：
	- 解释器来源：`python -m pytest ...` 取决于当前 PATH 指向的 Python；`.\.venv\Scripts\python.exe -m pytest ...` 强制使用本项目虚拟环境，避免全局环境未安装 pytest 时的 ImportError。
	- 输出详略：`-v` 详细显示每个用例；`-q` 安静模式仅显示必要信息。
	- 工作目录：请确保在项目根目录执行（包含 `tests/`），或显式传入测试路径（如 `tests/`）。

- 常用命令（PowerShell）：

```powershell
# 全量运行，详细输出
\.venv\Scripts\python.exe -m pytest tests/ -v

# 单个用例
\.venv\Scripts\python.exe -m pytest tests/test_auth.py::TestAuthEndpoints::test_health_check -q

# 关键字过滤
\.venv\Scripts\python.exe -m pytest -k "login and not refresh" -v

# 首个失败即停
\.venv\Scripts\python.exe -m pytest tests/ -x -v
```

若出现导入错误（如找不到 `pytest` 或 `flask_jwt_extended`），优先确认是否使用了 `.venv` 解释器；必要时重新安装依赖：

```powershell
python -m venv .venv
\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

> Generated by Zhuang

## 📁 项目结构

```
health_platform/
├── src/                    # 后端API
├── frontend/              # React前端
├── static_demo/           # 静态演示页面
├── tests/                 # 自动化测试
├── docs/                  # 需求与设计文档
└── README.md             # 本文件
```

## 🎯 下一步扩展

- 家庭成员管理
- CSV数据导出  
- 微信小程序
- Azure容器化部署

---

**Generated by Zhuang** - 健康记录平台 MVP v1.0

---

## 🗄️ 数据库初始化（MySQL/外部数据库）

为避免首次连接到“空库”时出现 500 错误，应用对“自动建表”的策略如下（自 v1.0 修订）：

- SQLite（本地开发）：启动时总是自动建表（db.create_all）。
- MySQL/其它外部数据库：
	- 默认：在“检测到关键表缺失”时自动建表（users/members/health_records/households/record_subjects）。
	- 强制建表：设置 `DB_AUTO_CREATE=1` 将始终建表。
	- 关闭自动建：设置 `DB_CREATE_ON_MISSING=0`，即便缺表也不自动建（适合生产）。

标准化初始化与验证（PowerShell）：

```powershell
\.venv\Scripts\Activate.ps1
$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask db-info   # 查看方言/字符集/现有表
$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask db-create # 创建/补齐所有表（幂等）
$env:PYTHONPATH='.'; $env:FLASK_APP='src.app'; python -m flask db-info   # 再次确认
```

生产建议：默认关闭“缺表自动建”（`DB_CREATE_ON_MISSING=0`），并在部署流水线中显式执行 `flask db-create` 或采用数据库迁移工具管理结构变更。Generated by Zhuang